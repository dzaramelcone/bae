---
project: bae
status: in_progress
last_updated: 2026-02-04
---

# Bae: Type-driven Agent Graphs

## Current State

Implementing integration tests for real LLM backends. The Claude CLI backend has a bug - using wrong flag `--output-schema` instead of `--json-schema`.

## What's Built

Core framework is working:
- **Node** - Pydantic BaseModel with `__call__(lm: LM)` that returns next node
- **Graph** - Discovers topology from type hints, runs execution loop
- **LM Protocol** - `make(node, TargetType)` and `decide(node)` methods
- **PydanticAIBackend** - Implemented, needs API key to test
- **ClaudeCLIBackend** - Implemented but has bug (wrong flag name)

## Files

```
bae/
├── __init__.py     # exports Node, NodeConfig, Graph, LM, backends
├── node.py         # Node base class, type hint extraction
├── graph.py        # Graph discovery, validation, run()
├── lm.py           # LM protocol + PydanticAI/ClaudeCLI backends
├── compiler.py     # DSPy compilation stubs (not wired up)
tests/
├── test_node.py    # Unit tests - passing
├── test_graph.py   # Unit tests - passing (17 total)
├── test_integration.py  # Real LLM tests - needs fix
```

## The Bug to Fix

In `bae/lm.py`, ClaudeCLIBackend uses `--output-schema` but should use `--json-schema`:

```python
# Line ~160 and ~204 - change:
"--output-schema", json.dumps(schema),
# to:
"--json-schema", json.dumps(schema),
```

## Design Decisions Made

1. **No `prev` parameter** - `self` IS the state, no need for previous node
2. **LM is a tool, not executor** - User calls `lm.make()` or `lm.decide()` from `__call__`
3. **Sync interface** - Using pydantic-ai's `run_sync`, simpler than async
4. **Python 3.14+** - PEP 649 means forward refs just work
5. **No incant** - Simpler to just pass `lm` directly

## Next Actions

1. Fix the `--json-schema` flag in ClaudeCLIBackend
2. Run integration tests with Claude CLI
3. Test with real scenarios
4. Wire up DSPy compilation if desired

## How to Resume

```bash
cd ~/lab/bae
# Fix the flag in lm.py (--output-schema -> --json-schema)
# Then run:
uv run pytest tests/test_integration.py::TestClaudeCLIBackend -v -s
```
