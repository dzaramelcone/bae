---
phase: 03-optimization
plan: 03
type: tdd
wave: 2
depends_on: ["03-01"]
files_modified:
  - bae/optimizer.py
  - tests/test_optimizer.py
autonomous: true

must_haves:
  truths:
    - "save_optimized() writes predictors to JSON files"
    - "load_optimized() reads JSON files into predictors"
    - "Round-trip: save then load produces equivalent predictors"
    - "Missing files handled gracefully on load"
    - "Directory created if not exists on save"
  artifacts:
    - path: "bae/optimizer.py"
      provides: "save_optimized, load_optimized functions"
      exports: ["save_optimized", "load_optimized"]
    - path: "tests/test_optimizer.py"
      provides: "TDD tests for save/load"
      contains: "test_save|test_load"
  key_links:
    - from: "bae/optimizer.py"
      to: "dspy.Predict"
      via: "save() and load() methods"
      pattern: "predictor\\.(save|load)"
    - from: "bae/optimizer.py"
      to: "pathlib"
      via: "Path for file operations"
      pattern: "from pathlib import Path"
---

<objective>
TDD: Save and load compiled prompts to JSON

Purpose: Optimized predictors need persistence for production deployment. save_optimized() writes predictors to disk, load_optimized() reads them back. Uses DSPy's native save/load with JSON format.

Output: save_optimized() and load_optimized() functions in bae/optimizer.py, fully tested
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/03-optimization/03-RESEARCH.md
@.planning/phases/03-optimization/03-01-SUMMARY.md

@bae/compiler.py
@bae/graph.py
</context>

<feature>
  <name>Save and Load Compiled Prompts</name>
  <files>bae/optimizer.py, tests/test_optimizer.py</files>
  <behavior>
    save_optimized(
        optimized: dict[type[Node], dspy.Predict],
        path: str | Path
    ) -> None:
    - Creates directory if not exists
    - For each (node_cls, predictor) pair:
      - Saves to path/{NodeClassName}.json
      - Uses predictor.save(path, save_program=False) for JSON format

    load_optimized(
        node_classes: list[type[Node]],
        path: str | Path
    ) -> dict[type[Node], dspy.Predict]:
    - For each node_cls in node_classes:
      - Creates predictor: dspy.Predict(node_to_signature(node_cls))
      - Checks if path/{NodeClassName}.json exists
      - If exists: loads state with predictor.load(path)
      - Adds to result dict
    - Returns dict mapping node classes to predictors

    Cases:
    - save_optimized({NodeA: pred_a}, "/tmp/compiled") -> creates /tmp/compiled/NodeA.json
    - load_optimized([NodeA], "/tmp/compiled") -> {NodeA: loaded_pred}
    - load_optimized([NodeA], "/nonexistent") -> {NodeA: fresh_pred} (no crash)
    - Round trip: save then load preserves demos in predictor
  </behavior>
  <implementation>
    Add to bae/optimizer.py:

    1. save_optimized():
       - path = Path(path)
       - path.mkdir(parents=True, exist_ok=True)
       - for node_cls, predictor in optimized.items():
           predictor.save(str(path / f"{node_cls.__name__}.json"), save_program=False)

    2. load_optimized():
       - from bae.compiler import node_to_signature
       - path = Path(path)
       - loaded = {}
       - for node_cls in node_classes:
           sig_path = path / f"{node_cls.__name__}.json"
           predictor = dspy.Predict(node_to_signature(node_cls))
           if sig_path.exists():
               predictor.load(str(sig_path))
           loaded[node_cls] = predictor
       - return loaded

    Testing approach:
    - Use tmp_path fixture for isolated file tests
    - Test directory creation
    - Test round-trip save/load
    - Test missing file handling
    - Verify JSON format (not pickle)
  </implementation>
</feature>

<verification>
```bash
pytest tests/test_optimizer.py -v -k "save or load"
```

All save/load tests pass. Coverage includes:
- Directory creation on save
- File written per node class
- Round-trip preserves state
- Missing directory on load (creates fresh predictors)
- Missing file on load (creates fresh predictor)
</verification>

<success_criteria>
- save_optimized() creates JSON files in specified directory
- load_optimized() loads existing files and handles missing gracefully
- Round-trip produces functionally equivalent predictors
- Satisfies OPT-03 and OPT-04
</success_criteria>

<output>
After completion, create `.planning/phases/03-optimization/03-03-SUMMARY.md`
</output>
