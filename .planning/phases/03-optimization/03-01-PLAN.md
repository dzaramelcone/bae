---
phase: 03-optimization
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - bae/optimizer.py
  - tests/test_optimizer.py
autonomous: true

must_haves:
  truths:
    - "GraphResult.trace converts to dspy.Example list"
    - "Each example has input node fields as inputs"
    - "Each example has next_node_type as label"
    - "Metric returns 1.0 when types match, 0.0 when not"
    - "Metric returns bool during bootstrapping (trace is not None)"
  artifacts:
    - path: "bae/optimizer.py"
      provides: "trace_to_examples, node_transition_metric"
      exports: ["trace_to_examples", "node_transition_metric"]
    - path: "tests/test_optimizer.py"
      provides: "TDD tests for conversion and metric"
      min_lines: 60
  key_links:
    - from: "bae/optimizer.py"
      to: "bae/node.py"
      via: "Node type and model_dump()"
      pattern: "model_dump|model_fields"
    - from: "bae/optimizer.py"
      to: "dspy"
      via: "dspy.Example creation"
      pattern: "dspy\\.Example"
---

<objective>
TDD: Trace-to-Example conversion and type-match metric function

Purpose: These two functions form the foundation for DSPy optimization. trace_to_examples() converts execution traces to DSPy's training format. node_transition_metric() scores predictions for optimizer selection.

Output: bae/optimizer.py with trace_to_examples() and node_transition_metric(), fully tested
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-optimization/03-RESEARCH.md

@bae/result.py
@bae/node.py
</context>

<feature>
  <name>Trace-to-Example Conversion and Metric Function</name>
  <files>bae/optimizer.py, tests/test_optimizer.py</files>
  <behavior>
    trace_to_examples(trace: list[Node]) -> list[dspy.Example]:
    - Given trace [NodeA, NodeB, NodeC], returns 2 examples
    - Example 0: inputs from NodeA, next_node_type="NodeB"
    - Example 1: inputs from NodeB, next_node_type="NodeC"
    - Each example has .with_inputs() called with input node's field names
    - Empty trace returns empty list
    - Single-node trace returns empty list (no transitions)

    node_transition_metric(example, pred, trace=None) -> float | bool:
    - example.next_node_type = expected type name
    - pred has .next_node_type or .output attribute with predicted type
    - When trace is None (evaluation): returns 1.0 if match, 0.0 if not
    - When trace is not None (bootstrapping): returns True if match, False if not
    - Matching is case-insensitive substring match (flexible for LLM output)

    Cases:
    - trace_to_examples([A, B]) -> [Example(A fields, next_node_type="B")]
    - trace_to_examples([A, B, C]) -> [Example(A...), Example(B...)]
    - trace_to_examples([A]) -> []
    - trace_to_examples([]) -> []
    - metric(ex(type="B"), pred(type="B"), None) -> 1.0
    - metric(ex(type="B"), pred(type="X"), None) -> 0.0
    - metric(ex(type="B"), pred(type="B"), []) -> True
    - metric(ex(type="B"), pred(type="nodeB"), None) -> 1.0 (substring)
  </behavior>
  <implementation>
    Create bae/optimizer.py with:

    1. trace_to_examples():
       - Iterate pairs: for i in range(len(trace) - 1)
       - input_node = trace[i], output_node = trace[i+1]
       - Build example with input_node.model_dump() fields
       - Add node_type=type(input_node).__name__
       - Add next_node_type=type(output_node).__name__
       - Call .with_inputs() with input node's field names + "node_type"
       - Return list of examples

    2. node_transition_metric():
       - Get expected from example.next_node_type
       - Get predicted from pred.next_node_type or pred.output
       - Normalize both to lowercase, strip whitespace
       - Check if one contains the other (substring match)
       - Return float if trace is None, bool otherwise
  </implementation>
</feature>

<verification>
```bash
pytest tests/test_optimizer.py -v
```

All tests pass. Coverage includes:
- Empty trace handling
- Single-node trace handling
- Multi-node trace conversion
- Example input marking
- Metric type match
- Metric type mismatch
- Metric bootstrap mode (trace not None)
- Metric evaluation mode (trace is None)
</verification>

<success_criteria>
- trace_to_examples() converts GraphResult.trace to dspy.Example list
- Each example correctly identifies inputs via with_inputs()
- node_transition_metric() returns correct types based on trace parameter
- All tests pass
- Satisfies foundation for OPT-01 and supports OPT-02
</success_criteria>

<output>
After completion, create `.planning/phases/03-optimization/03-01-SUMMARY.md`
</output>
