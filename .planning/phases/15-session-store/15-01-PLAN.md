---
phase: 15-session-store
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - bae/repl/store.py
  - tests/repl/test_store.py
autonomous: true

must_haves:
  truths:
    - "SessionStore creates .bae/store.db with sessions and entries tables on init"
    - "store.record() persists labeled entries with mode, channel, direction, and metadata"
    - "store.search() returns FTS5 full-text matches across entries"
    - "store.recent() returns the N most recent entries across all sessions"
    - "store.session_entries() returns all entries for a given session"
    - "Content longer than 10,000 characters is truncated with metadata flag"
  artifacts:
    - path: "bae/repl/store.py"
      provides: "SessionStore class with SQLite + FTS5 persistence"
      contains: "class SessionStore"
    - path: "tests/repl/test_store.py"
      provides: "Tests for SessionStore record/search/query methods"
      contains: "test_record"
  key_links:
    - from: "bae/repl/store.py"
      to: "sqlite3"
      via: "stdlib sqlite3 with FTS5 and JSON functions"
      pattern: "sqlite3\\.connect"
---

<objective>
Build the SessionStore class -- SQLite persistence for REPL I/O with FTS5 full-text search.

Purpose: Foundation for all session persistence. Every future phase that reads/writes I/O depends on this store.
Output: `bae/repl/store.py` with SessionStore class, `tests/repl/test_store.py` with full coverage.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-session-store/15-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for SessionStore</name>
  <files>tests/repl/test_store.py</files>
  <action>
Create `tests/repl/test_store.py` with the following test cases. All tests use `:memory:` SQLite (pass `Path(":memory:")` or use `tmp_path / "test.db"`). Use `tmp_path` fixture for tests that need a real file path.

Tests to write:

1. `test_init_creates_session` -- SessionStore(db_path) creates a session row in the sessions table with a uuid7 id, started_at timestamp, and cwd.
2. `test_record_persists_entry` -- `store.record("PY", "repl", "input", "x = 42")` inserts a row in entries with correct session_id, mode, channel, direction, content, and timestamp.
3. `test_record_with_metadata` -- `store.record("PY", "repl", "output", "42", {"type": "expr_result"})` stores JSON metadata retrievable via `json_extract`.
4. `test_search_fts` -- After recording several entries, `store.search("hello")` returns entries containing "hello" via FTS5 MATCH.
5. `test_search_returns_empty_for_no_match` -- `store.search("nonexistent")` returns empty list.
6. `test_recent_returns_latest` -- After recording 5 entries, `store.recent(3)` returns the 3 most recent by timestamp (descending).
7. `test_session_entries_returns_current` -- `store.session_entries()` returns only entries for the current session.
8. `test_sessions_lists_all` -- `store.sessions()` returns a list including the current session.
9. `test_content_truncation` -- Recording content longer than 10,000 chars truncates to 10,000 and sets `{"truncated": true, "original_length": N}` in metadata.
10. `test_close` -- After `store.close()`, the connection is closed (further operations raise).

Import from `bae.repl.store import SessionStore`. Tests will fail because the module does not exist yet.

Run tests: `uv run pytest tests/repl/test_store.py -x` -- expect ImportError or all failures.
  </action>
  <verify>uv run pytest tests/repl/test_store.py -x 2>&1 | head -20  -- must show failures (RED phase)</verify>
  <done>10 test functions exist in test_store.py, all fail because SessionStore does not exist yet</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement SessionStore</name>
  <files>bae/repl/store.py</files>
  <action>
Create `bae/repl/store.py` implementing the SessionStore class. Follow the research pattern exactly:

**Schema** (in module-level SCHEMA constant):
- `sessions` table: id TEXT PK, started_at REAL, cwd TEXT, metadata TEXT DEFAULT '{}'
- `entries` table: id INTEGER PK AUTOINCREMENT, session_id TEXT FK, timestamp REAL, mode TEXT, channel TEXT, direction TEXT CHECK('input','output'), content TEXT, metadata TEXT DEFAULT '{}'
- `entries_fts` virtual table: FTS5 on content, content=entries, content_rowid=id
- AFTER INSERT trigger `entries_ai` to sync FTS5
- AFTER DELETE trigger `entries_ad` to sync FTS5
- Indexes on session_id, mode, channel, timestamp

**SessionStore class:**
- `__init__(self, db_path: Path)` -- mkdir parents, connect sqlite3, set row_factory=Row, executescript SCHEMA, set `PRAGMA journal_mode=WAL`, create session row with uuid.uuid7(), time.time(), Path.cwd(). Store session_id.
- `record(self, mode, channel, direction, content, metadata=None)` -- Truncate content to 10,000 chars. If truncated, merge `{"truncated": True, "original_length": len(original)}` into metadata dict. INSERT + commit.
- `search(self, query, limit=20)` -- FTS5 MATCH query, JOIN entries, ORDER BY timestamp DESC, LIMIT.
- `recent(self, n=50)` -- SELECT from entries ORDER BY timestamp DESC LIMIT n.
- `session_entries(self, session_id=None)` -- SELECT from entries WHERE session_id, ORDER BY timestamp ASC.
- `sessions(self)` -- SELECT from sessions ORDER BY started_at DESC.
- `close(self)` -- conn.close().

**Content truncation constant:** `MAX_CONTENT = 10_000`

Use only stdlib: sqlite3, json, time, uuid, pathlib.

Run: `uv run pytest tests/repl/test_store.py -x` -- all tests must pass.
  </action>
  <verify>uv run pytest tests/repl/test_store.py -v  -- all 10 tests pass (GREEN phase)</verify>
  <done>SessionStore class exists in bae/repl/store.py, all 10 tests pass, FTS5 search works</done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/repl/test_store.py -v` -- all tests pass
2. `uv run pytest tests/ -x` -- full suite still passes (no regressions)
3. `uv run ruff check bae/repl/store.py` -- no lint errors
</verification>

<success_criteria>
- SessionStore class persists entries with structured metadata to SQLite
- FTS5 full-text search returns matching entries
- Content truncation at 10,000 chars with metadata flag
- All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/15-session-store/15-01-SUMMARY.md`
</output>
