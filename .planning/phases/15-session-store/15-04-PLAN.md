---
phase: 15-session-store
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/repl/store.py
  - tests/repl/test_store.py
  - tests/repl/test_store_integration.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "store() and store('query') use identical tag format via a single _format_entry method"
    - "Long content in store display shows ellipsis when truncated"
    - "store.sessions(), store.recent(), store.search(), store.session_entries() all return list[dict]"
  artifacts:
    - path: "bae/repl/store.py"
      provides: "_format_entry method, dict returns from all public methods, ellipsis on truncation"
      contains: "_format_entry"
  key_links:
    - from: "bae/repl/store.py::__call__"
      to: "bae/repl/store.py::_format_entry"
      via: "Both display branches call _format_entry"
      pattern: "_format_entry"
    - from: "bae/repl/store.py::search"
      to: "caller"
      via: "Returns list[dict] not list[sqlite3.Row]"
      pattern: "dict\\(row\\) for row in"
---

<objective>
Close three UAT gaps from Phase 15: (1) truncation display lacks ellipsis, (2) tag format inconsistency between store() and store('query'), (3) public methods return raw sqlite3.Row objects instead of dicts.

Purpose: UAT tests 4, 5, 6 report usability issues -- truncated text has no indicator, tag labels are inconsistent, and all methods except __call__ return unusable Row objects.
Output: Single-concern refactor of store.py with consistent formatting, clean returns, and updated tests.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-session-store/15-UAT.md
@bae/repl/store.py
@tests/repl/test_store.py
@tests/repl/test_store_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unify display formatting, add ellipsis, return dicts from all public methods</name>
  <files>bae/repl/store.py</files>
  <action>
Three changes to `bae/repl/store.py`, all focused on the SessionStore class:

**1. Add `_format_entry` method (gap 2 -- consistent tags):**

Add a private method that both `__call__` branches use for display:

```python
def _format_entry(self, entry: dict, max_width: int = 80) -> str:
    tag = f"[{entry['mode']}:{entry['channel']}:{entry['direction']}]"
    content = entry["content"].replace("\n", "\\n")
    avail = max_width - len(tag) - 1  # 1 for space
    if len(content) > avail:
        content = content[:avail - 3] + "..."
    return f"{tag} {content}"
```

The canonical tag format is always `[mode:channel:direction]` -- 3 fields. This resolves the inconsistency where session display used 2 fields and search display used 3.

The `max_width` parameter controls truncation. Content longer than available space gets `...` suffix (gap 1 -- ellipsis). Newlines in content are escaped to `\n` for single-line display.

**2. Refactor `__call__` to use `_format_entry` (gap 2):**

Replace both display paths in `__call__`:

```python
def __call__(self, query: str | None = None, n: int = 20) -> None:
    if query:
        entries = self.search(query, limit=n)
        for e in entries:
            print(self._format_entry(e))
    else:
        entries = self.session_entries()
        print(f"Session {self.session_id}: {len(entries)} entries")
        for e in entries[-n:]:
            print(f"  {self._format_entry(e)}")
```

Note: since `search()` and `session_entries()` now return `list[dict]` (change 3 below), no `dict(e)` conversion needed in `__call__`.

**3. Return `list[dict]` from all public query methods (gap 3):**

Change the return type and add dict conversion in these four methods:

- `search()`: change return annotation to `list[dict]`, add `return [dict(row) for row in rows]` (fetch into local `rows` first)
- `recent()`: same pattern
- `session_entries()`: same pattern
- `sessions()`: same pattern

Each method fetches into a local variable, converts, and returns:
```python
def search(self, query: str, limit: int = 20) -> list[dict]:
    rows = self._conn.execute(...).fetchall()
    return [dict(row) for row in rows]
```

Do NOT change `record()` or `close()` -- they don't return query results.
Do NOT change `__init__` or the `row_factory` setting -- Row factory is still useful internally.
  </action>
  <verify>
Run `uv run pytest tests/repl/test_store.py tests/repl/test_store_integration.py -x -v`. Most tests should still pass because dict supports the same `["key"]` access as sqlite3.Row. The `test_store_sessions_accessible` test does `dict(s)["id"]` which is now redundant (double dict()) but still works. Existing `__call__` tests check for substring matches ("hello", "Session {id}") not exact tag format, so they pass. Look for any failures and address in Task 2.
  </verify>
  <done>
All four public query methods return list[dict]. _format_entry produces canonical [mode:channel:direction] tags with ellipsis on truncation. __call__ uses _format_entry for both branches.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update and add tests for unified formatting, ellipsis, and dict returns</name>
  <files>tests/repl/test_store.py, tests/repl/test_store_integration.py</files>
  <action>
**Update `tests/repl/test_store.py`:**

Add these new tests:

1. `test_search_returns_dicts` -- call `store.search("hello")`, assert `isinstance(results[0], dict)` (not sqlite3.Row).

2. `test_recent_returns_dicts` -- call `store.recent()`, assert `isinstance(results[0], dict)`.

3. `test_session_entries_returns_dicts` -- call `store.session_entries()`, assert `isinstance(results[0], dict)`.

4. `test_sessions_returns_dicts` -- call `store.sessions()`, assert `isinstance(results[0], dict)`.

Remove the `import sqlite3` at top if it's only used by `test_close` -- check first. Actually `test_close` uses `sqlite3.ProgrammingError`, so keep the import.

**Update `tests/repl/test_store_integration.py`:**

1. In `test_store_sessions_accessible`: simplify `dict(s)["id"]` to just `s["id"]` since sessions() now returns dicts directly.

2. In `test_cross_session_persistence`: the line `contents = [r["content"] for r in recent]` already works with dicts. No change needed.

3. Update `test_store_inspector_search` to verify the canonical 3-field tag format. After `store("hello")`, check that `captured.out` contains `[PY:repl:input]` (the canonical format). This confirms the unified formatter is active.

4. Add `test_store_display_truncation_ellipsis`:
   - Record an entry with content "a" * 200 (long content)
   - Call `store()`, capture output
   - Assert the output line for that entry ends with `...`
   - Assert the raw 200-char content is NOT fully present in the display

5. Add `test_store_search_display_truncation_ellipsis`:
   - Record an entry with long content containing the word "findme" at the start: `"findme " + "x" * 200`
   - Call `store("findme")`, capture output
   - Assert the output contains `...`

6. Add `test_format_entry_consistency`:
   - Record entries in PY/repl/input and BASH/stdout/output
   - Call `store()`, capture output
   - Assert both entries show 3-field tags: `[PY:repl:input]` and `[BASH:stdout:output]`

Run the full test suite after adding these tests.
  </action>
  <verify>
Run `uv run pytest tests/repl/test_store.py tests/repl/test_store_integration.py -x -v` -- ALL tests must pass, zero failures. Then run `uv run pytest tests/repl/ -x` for full repl suite sanity.
  </verify>
  <done>
New tests verify: (1) all public methods return list[dict], (2) display uses consistent 3-field tags, (3) truncated content shows ellipsis. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/repl/test_store.py tests/repl/test_store_integration.py -x -v` -- all tests pass (existing + new)
2. `uv run python -c "from bae.repl.store import SessionStore; from pathlib import Path; s = SessionStore(Path('/tmp/test_gap4.db')); s.record('PY','repl','input','hello world'); print(type(s.sessions()[0])); s.close()"` -- prints `<class 'dict'>`
3. `uv run python -c "from bae.repl.store import SessionStore; from pathlib import Path; s = SessionStore(Path('/tmp/test_gap4b.db')); s.record('PY','repl','input','x'*200); s(); s.close()"` -- display line ends with `...`
</verification>

<success_criteria>
- store() and store('query') produce identical [mode:channel:direction] tag format (UAT test 5 gap closed)
- Long content in display shows ellipsis truncation marker (UAT test 4 gap closed)
- store.sessions(), store.recent(), store.search() all return list[dict] (UAT test 6 gap closed)
- All existing tests pass without regression
- New tests cover all three gaps
</success_criteria>

<output>
After completion, create `.planning/phases/15-session-store/15-04-SUMMARY.md`
</output>
