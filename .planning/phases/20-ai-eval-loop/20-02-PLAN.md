---
phase: 20-ai-eval-loop
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/repl/ai.py
  - bae/repl/store.py
  - bae/repl/shell.py
  - bae/repl/ai_prompt.md
  - tests/repl/test_ai.py
autonomous: true

must_haves:
  truths:
    - "AI sessions spawned from PY mode are attachable/selectable in NL mode"
    - "NL mode has a session selector when multiple AI sessions exist"
    - "On launch, AI context includes recent session history from the store"
  artifacts:
    - path: "bae/repl/ai.py"
      provides: "AI with cross-session context loading and label support"
      contains: "_load_cross_session_context"
    - path: "bae/repl/shell.py"
      provides: "Multi-session AI management with @N prefix routing"
      contains: "_ai_sessions"
    - path: "bae/repl/store.py"
      provides: "Cross-session context query method"
      contains: "cross_session_context"
  key_links:
    - from: "bae/repl/shell.py"
      to: "bae/repl/ai.py"
      via: "_get_or_create_session creates AI instances keyed by label"
      pattern: "_ai_sessions"
    - from: "bae/repl/ai.py"
      to: "bae/repl/store.py"
      via: "cross_session_context called on first AI prompt"
      pattern: "cross_session_context"
    - from: "bae/repl/shell.py"
      to: "namespace['ai']"
      via: "active session pointer updated on switch"
      pattern: "namespace.*ai"
---

<objective>
Add multi-session AI management and cross-session memory from the store.

Purpose: SC2/SC3 (AI sessions from PY mode attachable in NL, session selector) and SC5 (cross-session memory) are the session management layer that the eval loop (Plan 03) builds on.
Output: Multiple AI sessions keyed by label, @N prefix to route in NL mode, store-sourced context on first prompt.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-ai-eval-loop/20-RESEARCH.md
@.planning/phases/18-ai-agent/18-01-SUMMARY.md

@bae/repl/ai.py
@bae/repl/store.py
@bae/repl/shell.py
@bae/repl/ai_prompt.md
@tests/repl/test_ai.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Multi-session AI management and cross-session memory</name>
  <files>bae/repl/ai.py, bae/repl/store.py, bae/repl/shell.py, bae/repl/ai_prompt.md, tests/repl/test_ai.py</files>
  <action>
**Cross-session memory (store.py + ai.py):**

1. Add `SessionStore.cross_session_context(budget: int = 2000) -> str` method:
   - Query `recent(n=50)` for entries from PREVIOUS sessions (exclude current session_id)
   - Filter out `channel == "debug"` entries
   - Build lines as `[{mode}:{channel}] {content[:200]}` for each entry, capped at 20 entries
   - Join with newlines, prefix with `[Previous session context]`
   - Truncate total to `budget` chars
   - Return empty string if no previous entries

2. Add `label` parameter to `AI.__init__` (default `"1"`). Store as `self._label`.

3. Add `store` parameter to `AI.__init__` (default `None`). Store as `self._store`.

4. In `AI.__call__`, when `self._call_count == 0` and `self._store` is not None:
   - Call `self._store.cross_session_context()` and prepend to the full_prompt (before namespace context)
   - This gives the AI cross-session memory on first prompt only. Subsequent calls use `--resume` which has conversation history.

5. Update `AI.__repr__` to include label: `f"ai:{self._label} -- await ai('question'). session {sid}, {n} calls."`

6. Update channel output in `AI.__call__` to use label in metadata: `metadata={"type": "response", "label": self._label}`.

**Multi-session management (shell.py):**

7. Add `_ai_sessions: dict[str, AI]` and `_active_session: str = "1"` to `CortexShell.__init__`.

8. Add `_get_or_create_session(label: str) -> AI` method:
   - If label not in `_ai_sessions`, create new AI instance with that label, same lm/router/namespace/tm/store
   - Each session gets its own UUID session_id (AI.__init__ already does this)
   - Return the session

9. Replace the single `self.ai = AI(...)` in `__init__` with:
   - `self.ai = self._get_or_create_session("1")`
   - Store in `_ai_sessions` dict
   - `self.namespace["ai"] = self.ai`

10. In `_run_nl`, parse `@N` prefix from text:
    - If text starts with `@` followed by a digit/label and a space (e.g., `@2 tell me more`), extract the label and remaining text
    - Switch `_active_session` to that label, create session if needed
    - Update `self.ai = self._ai_sessions[label]` and `self.namespace["ai"] = self.ai`
    - Use the remaining text (without prefix) as the prompt
    - If no prefix, use current active session

11. In `_dispatch`, when submitting NL task, include session label in task name: `f"ai:{self._active_session}:{text[:30]}"` so task menu shows which session.

**System prompt update (ai_prompt.md):**

12. Update the system prompt to mention that code blocks will be automatically executed and results fed back. Add a brief note: "Code in ```python fences executes in the REPL namespace. You will see the output. You may iterate." This prepares for Plan 03's eval loop.

**Tests (test_ai.py):**

13. Add tests:
    - `test_ai_label_default`: AI().label defaults to "1"
    - `test_ai_label_custom`: AI(label="2") stores label
    - `test_ai_repr_with_label`: repr includes label
    - `test_cross_session_context_empty`: no previous sessions returns ""
    - `test_cross_session_context_excludes_current`: entries from current session excluded
    - `test_cross_session_context_excludes_debug`: debug channel entries filtered out
    - `test_cross_session_context_budget`: output truncated to budget
    - `test_cross_session_context_format`: output starts with "[Previous session context]"
  </action>
  <verify>
`uv run pytest tests/repl/test_ai.py -v` — all tests pass including new session/context tests.
`uv run pytest tests/repl/ -v` — full repl suite green, no regressions.
  </verify>
  <done>
Multi-session AI: shell manages dict of AI sessions, @N prefix routes in NL mode, namespace["ai"] always points to active session.
Cross-session memory: store.cross_session_context() provides previous session history, injected into first AI prompt.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest tests/repl/ -v` — all repl tests pass
- AI instances accept label parameter
- Shell manages multiple AI sessions via _ai_sessions dict
- @N prefix in NL mode switches active session
- store.cross_session_context() returns formatted previous session entries
- AI first prompt includes cross-session context when store is provided
</verification>

<success_criteria>
SC2: AI sessions spawned from PY mode (await ai("q")) are attachable/selectable in NL mode via @N prefix
SC3: NL mode has a session selector — @N prefix syntax routes to session N
SC5: On launch, AI context includes recent session history from the store
</success_criteria>

<output>
After completion, create `.planning/phases/20-ai-eval-loop/20-02-SUMMARY.md`
</output>
