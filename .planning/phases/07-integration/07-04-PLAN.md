---
phase: 07-integration
plan: 04
type: execute
wave: 4
depends_on: ["07-03"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All tests pass (291+ tests, 0 failures, 0 errors)"
    - "No references to incant anywhere in the codebase (bae/, tests/, pyproject.toml)"
    - "Graph.run() uses max_iters (not max_steps) with default 10"
    - "Dep fields on start node are resolved in the first loop iteration"
    - "Each iteration: resolve deps/recalls -> set on self -> append trace -> __call__/LM route"
    - "Terminal nodes are included in the execution trace"
    - "Phase 7 success criteria 1-4 from ROADMAP.md are all satisfied"
  artifacts: []
  key_links: []
---

<objective>
Phase gate: verify all Phase 7 success criteria are met. Full regression + targeted verification of each success criterion.

Purpose: Ensure the integration work is complete and correct before marking Phase 7 done. This is a verification-only plan -- no code changes unless verification reveals issues.

Output: Phase 7 verified as complete. STATE.md and ROADMAP.md updated.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration/07-CONTEXT.md
@.planning/phases/07-integration/07-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full regression and success criteria verification</name>
  <files></files>
  <action>
Run the full test suite and verify all Phase 7 success criteria.

**Step 1: Full regression**
```bash
cd /Users/dzaramelcone/lab/bae && python -m pytest tests/ -v --tb=short
```
ALL tests must pass. Zero failures, zero errors. Note the exact count.

**Step 2: Verify incant fully removed**
```bash
grep -r "incant" bae/ tests/ pyproject.toml
```
Must return nothing. If any hits, flag as issue.

**Step 3: Verify success criteria from ROADMAP.md**

Criterion 1: "Dep fields on the start node are auto-resolved before graph execution begins"
- Per CONTEXT.md decision: "inside the first loop iteration" (same path as all nodes, not a special pre-step)
- Verify: test_dep_injection.py has a test where start node has Dep field and it gets resolved
- Check: `grep -n "StartWithDep\|start.*[Dd]ep" tests/test_dep_injection.py`

Criterion 2: "Each execution loop iteration resolves deps, resolves recalls, then has LM fill remaining fields -- in that order"
- Verify: Read bae/graph.py run() method and confirm ordering: resolve_fields -> set on self -> trace.append -> __call__/LM
- Check: The code structure in Graph.run() follows this exact order

Criterion 3: "The incant dependency is removed; dep resolution uses bae's own resolver"
- Already verified in Step 2
- Additional check: `grep "resolve_fields" bae/graph.py` -- must have hits (using bae's resolver)

Criterion 4: "A multi-node graph with deps, recalls, and LLM-filled fields runs end-to-end producing correct results"
- Verify: test_dep_injection.py has a multi-node test with deps AND recalls
- Check: `grep -n "Recall\|recall" tests/test_dep_injection.py` -- must have Recall usage in tests

**Step 4: Verify API changes**
```python
# Check Graph.run() signature
python -c "import inspect; from bae.graph import Graph; sig = inspect.signature(Graph.run); print(sig)"
```
Must show `(self, start_node: bae.node.Node, lm: bae.lm.LM | None = None, max_iters: int = 10) -> bae.result.GraphResult`
- No **kwargs
- max_iters (not max_steps)
- Default 10 (not 100)

**Step 5: Verify exports**
```python
python -c "from bae import DepError, FillError; print('DepError:', DepError); print('FillError:', FillError)"
```
Must import cleanly.

If ANY verification fails, fix the issue (small targeted fix) and re-run.
  </action>
  <verify>`python -m pytest tests/ -x -q` -- all tests pass with zero failures</verify>
  <done>All Phase 7 success criteria verified. Full test suite passes. incant fully removed. v2 Graph.run() working.</done>
</task>

<task type="auto">
  <name>Task 2: Update STATE.md and ROADMAP.md</name>
  <files></files>
  <action>
Update .planning/STATE.md:
- Phase: 7 of 8 (Integration) -- COMPLETE
- Plan: 4 of 4 in current phase
- Status: Phase complete and verified (N tests pass, 0 failures)
- Last activity: current date -- Completed 07-04-PLAN.md (Phase 7 gate)
- Progress: Update percentage and fraction (should be ~23/30 plans complete including phase 7's 4 plans, recalculate)
- Add Phase 7 to performance metrics table
- Update decisions section with key Phase 7 decisions:
  - Graph.run() uses resolve_fields + choose_type/fill (not incant)
  - max_iters=10 default (not max_steps=100)
  - Terminal nodes included in trace
  - DepError/FillError for structured error handling
  - _wants_lm uses type-hint detection (not name-based)

Update .planning/ROADMAP.md:
- Phase 7 row: Plans Complete = 4/4, Status = Complete, Completed = current date
- Phase 7 Plans section: Update with actual plan checkboxes:
  ```
  Plans:
  - [x] 07-01-PLAN.md -- Error hierarchy + _wants_lm type-hint detection
  - [x] 07-02-PLAN.md -- Graph.run() v2 rewrite
  - [x] 07-03-PLAN.md -- Test migration + incant removal
  - [x] 07-04-PLAN.md -- Phase gate verification
  ```

Commit: `docs(phase-7): complete Integration phase`
  </action>
  <verify>Read STATE.md and ROADMAP.md to confirm updates are correct</verify>
  <done>STATE.md and ROADMAP.md reflect Phase 7 complete. Ready for Phase 8.</done>
</task>

</tasks>

<verification>
- Full test suite passes (zero failures)
- All 4 ROADMAP success criteria for Phase 7 verified
- STATE.md and ROADMAP.md updated
- No incant references in codebase
</verification>

<success_criteria>
- Phase 7 verified complete with all success criteria met
- STATE.md current position updated to Phase 7 complete
- ROADMAP.md progress table and plan checklist updated
- Ready for Phase 8 (Cleanup & Migration)
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration/07-04-SUMMARY.md`
</output>
