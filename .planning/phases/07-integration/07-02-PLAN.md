---
phase: 07-integration
plan: 02
type: tdd
wave: 2
depends_on: ["07-01"]
files_modified:
  - bae/graph.py
  - tests/test_dep_injection.py
autonomous: true

must_haves:
  truths:
    - "Graph.run() resolves Dep and Recall fields via resolve_fields() before __call__ on every node"
    - "Resolved field values are set on self via object.__setattr__ before __call__ runs"
    - "Ellipsis-body nodes route via choose_type/fill (v2 LM API), not make/decide (v1)"
    - "Custom __call__ nodes are invoked directly; LM passed as arg only if _wants_lm is True"
    - "Terminal nodes (return None) are included in the trace"
    - "Iteration guard raises BaeError when max_iters exceeded; default is 10; 0 means infinite"
    - "incant import and all incant helper functions are removed from graph.py"
    - "Dep failures raise DepError with exception chaining and partial trace"
  artifacts:
    - path: "bae/graph.py"
      provides: "v2 Graph.run() with resolve_fields, choose_type/fill routing"
      contains: "resolve_fields"
    - path: "bae/graph.py"
      provides: "No incant dependency"
      min_lines: 150
    - path: "tests/test_dep_injection.py"
      provides: "v2 integration tests replacing all v1 incant tests"
      contains: "resolve_fields"
  key_links:
    - from: "bae/graph.py"
      to: "bae/resolver.py"
      via: "resolve_fields called in execution loop"
      pattern: "resolve_fields\\(current\\.__class__"
    - from: "bae/graph.py"
      to: "bae/lm.py"
      via: "choose_type and fill called for routing"
      pattern: "lm\\.choose_type|lm\\.fill"
    - from: "bae/graph.py"
      to: "bae/exceptions.py"
      via: "DepError raised on dep failures"
      pattern: "raise DepError"
    - from: "bae/graph.py"
      to: "bae/node.py"
      via: "_wants_lm for LM param detection"
      pattern: "_wants_lm\\(current"
---

<objective>
Rewrite Graph.run() to use v2 field resolution (resolve_fields), v2 LM routing (choose_type/fill), and remove all incant integration. Replace v1 incant-based tests with v2 integration tests.

Purpose: This is the core integration work of Phase 7. The v2 execution loop wires together resolver (Phase 5) and LM protocol (Phase 6) into the graph runtime, replacing incant dependency injection with bae's own field resolution.

Output: Rewritten bae/graph.py with v2 run(), removed incant helpers. Rewritten tests/test_dep_injection.py with v2 integration tests.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration/07-CONTEXT.md
@.planning/phases/07-integration/07-RESEARCH.md
@.planning/phases/07-integration/07-01-SUMMARY.md

@bae/graph.py
@bae/resolver.py
@bae/lm.py
@bae/node.py
@bae/exceptions.py
@tests/test_dep_injection.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD - v2 Graph.run() core execution loop</name>
  <files>bae/graph.py, tests/test_dep_injection.py</files>
  <action>
**RED phase:** Delete the ENTIRE contents of tests/test_dep_injection.py and rewrite with v2 integration tests. The old tests test incant injection (v1) which is being removed. The new tests test field-level Dep/Recall resolution (v2).

New test file structure for tests/test_dep_injection.py:

```python
"""v2 integration tests for Graph.run() field resolution.

Tests the v2 execution loop:
- Dep(callable) fields resolved before __call__
- Recall() fields resolved from trace before __call__
- Custom __call__ reads resolved fields from self
- Ellipsis body nodes route via choose_type/fill
- Error hierarchy (DepError, RecallError) on failures
- Iteration guard (max_iters)
"""
```

Define test node classes using v2 patterns (Dep on FIELDS, not __call__ params):

1. **Dep resolution on start node:**
   - `StartWithDep` node with `data: Annotated[SomeResult, Dep(fetch_data)]` field
   - `fetch_data()` is a plain function returning SomeResult
   - Terminal return type
   - Test: graph.run(StartWithDep(...)) resolves dep field, trace[0] has data populated

2. **Multi-node with deps and recalls:**
   - `GatherInfo` (start) with `info: Annotated[Info, Dep(fetch_info)]`, returns `Analyze`
   - `Analyze` with `prev_info: Annotated[Info, Recall()]` and `analysis: str`, returns None (terminal)
   - Use a MockV2LM that implements choose_type/fill (NOT make/decide)
   - Test: graph runs, GatherInfo gets dep resolved, Analyze gets recall from trace

3. **Custom __call__ with resolved deps:**
   - Node with Dep field + custom __call__ that reads self.dep_field
   - Test: custom __call__ can access self.dep_field after resolution

4. **Dep failure raises DepError:**
   - Node with Dep(failing_fn) where failing_fn raises RuntimeError
   - Test: graph.run raises DepError with __cause__ set and trace attribute

5. **Iteration guard:**
   - Infinite loop node (returns self type)
   - Test: graph.run with max_iters=5 raises BaeError after 5 iterations
   - Test: graph.run with max_iters=0 does NOT raise (sentinel for infinite)
     (Use a node that terminates after a few steps to avoid actual infinite loop)

6. **Terminal node in trace:**
   - Terminal node (returns None)
   - Test: terminal node is included in trace (last element)

The MockV2LM for tests must implement the v2 API:
```python
class MockV2LM:
    """Mock LM implementing v2 API (choose_type/fill)."""
    def __init__(self, responses: dict[type, Node]):
        self.responses = responses
        self.fill_calls = []
        self.choose_type_calls = []

    def choose_type(self, types, context):
        self.choose_type_calls.append((types, context))
        for t in types:
            if t in self.responses:
                return t
        return types[0]

    def fill(self, target, context, instruction):
        self.fill_calls.append((target, context, instruction))
        return self.responses[target]

    # Keep v1 methods as stubs to satisfy Protocol shape
    def make(self, node, target): raise NotImplementedError("v1 API")
    def decide(self, node): raise NotImplementedError("v1 API")
```

Run tests -- they MUST fail (Graph.run() is still v1).
Commit: `test(07-02): add v2 integration tests for Graph.run() field resolution`

**GREEN phase:** Rewrite bae/graph.py:

1. **Remove incant imports and helpers:**
   - Remove `from incant import Incanter` (line 11)
   - Remove `_is_dep_annotated()` function (lines 20-28)
   - Remove `_get_base_type()` function (lines 31-49)
   - Remove `_create_dep_hook_factory()` function (lines 52-65)
   - Remove `_capture_bind_fields()` function (lines 68-84)
   - Remove unused imports: `inspect` (if no longer needed), `Bind` from markers

2. **Add new imports:**
   ```python
   import logging
   from bae.exceptions import BaeError, DepError, RecallError
   from bae.node import Node, _has_ellipsis_body, _wants_lm
   from bae.resolver import resolve_fields
   ```
   Add logger: `logger = logging.getLogger(__name__)`

3. **Add context-building helper:**
   ```python
   def _build_context(node: Node) -> dict[str, object]:
       """Build context dict from node fields for LM fill."""
       return {
           name: getattr(node, name)
           for name in node.model_fields
           if hasattr(node, name)
       }

   def _build_instruction(target_type: type) -> str:
       """Build instruction string from class name + optional docstring."""
       instruction = target_type.__name__
       if target_type.__doc__:
           instruction += f": {target_type.__doc__.strip()}"
       return instruction
   ```

4. **Rewrite Graph.run():**

   Signature: `def run(self, start_node: Node, lm: LM | None = None, max_iters: int = 10) -> GraphResult:`
   - Remove **kwargs (no more external dep injection via kwargs)
   - Rename max_steps to max_iters, default 10

   Body -- the v2 execution loop:
   ```
   if lm is None: default to DSPyBackend()

   trace = []
   dep_cache = {}
   current = start_node
   iters = 0

   while current is not None:
       # Iteration guard
       if max_iters and iters >= max_iters:
           err = BaeError(f"Graph execution exceeded {max_iters} iterations")
           err.trace = trace
           raise err

       # 1. Resolve deps and recalls
       try:
           resolved = resolve_fields(current.__class__, trace, dep_cache)
       except RecallError:
           raise  # Already correct type
       except Exception as e:
           err = DepError(
               f"{e} failed on {current.__class__.__name__}",
               node_type=current.__class__,
               cause=e,
           )
           err.trace = trace
           raise err from e

       # 2. Set resolved values on self
       for field_name, value in resolved.items():
           object.__setattr__(current, field_name, value)

       logger.debug("Resolved %d fields on %s", len(resolved), current.__class__.__name__)

       # 3. Append to trace (after resolution, before __call__)
       trace.append(current)

       # 4. Determine routing and execute
       strategy = _get_routing_strategy(current.__class__)

       if strategy[0] == "terminal":
           # Terminal node -- already in trace, exit
           current = None
       elif strategy[0] == "custom":
           # Custom __call__ logic
           if _wants_lm(current.__class__.__call__):
               current = current(lm)
           else:
               current = current()
       else:
           # Ellipsis body -- LM routing via v2 API
           context = _build_context(current)

           if strategy[0] == "make":
               target_type = strategy[1]
               instruction = _build_instruction(target_type)
               current = lm.fill(target_type, context, instruction)
           elif strategy[0] == "decide":
               types_list = list(strategy[1])
               chosen = lm.choose_type(types_list, context)
               instruction = _build_instruction(chosen)
               current = lm.fill(chosen, context, instruction)

       iters += 1

   return GraphResult(node=None, trace=trace)
   ```

   CRITICAL details:
   - Terminal node IS included in the trace (appended before loop exits via `current = None`)
   - `max_iters=0` means infinite (the `if max_iters` check is False when 0)
   - Dep failures wrap in DepError with trace attached and exception chaining
   - RecallError passes through (already the right type from resolver)
   - Keep `_get_routing_strategy()` -- it's still useful and not incant-related

5. **Keep _get_routing_strategy unchanged** -- it works for v2 too. It reads type hints, not incant state.

6. **Keep Graph.__init__, _discover, validate, to_mermaid unchanged.** The _validate_bind_uniqueness method can stay for now (Bind removal is Phase 8). It doesn't break anything.

Run tests -- v2 integration tests MUST pass.
Commit: `feat(07-02): rewrite Graph.run() with v2 field resolution and LM routing`

**REFACTOR (if needed):** Clean up any obvious issues. Run full test suite. Some existing tests (test_graph.py, test_auto_routing.py, test_integration_dspy.py) WILL fail because they use v1 MockLM (make/decide) and max_steps. That's expected -- Plan 03 handles those.

Commit only if refactoring occurs: `refactor(07-02): clean up Graph.run() v2 implementation`
  </action>
  <verify>
`cd /Users/dzaramelcone/lab/bae && python -m pytest tests/test_dep_injection.py -x -v` -- all new v2 tests pass.
`python -c "from bae.graph import Graph; import inspect; assert 'incant' not in inspect.getsource(Graph.run)"` -- no incant in run().
`grep -c "incant" bae/graph.py` -- returns 0 (no incant references).
  </verify>
  <done>
Graph.run() uses resolve_fields for dep/recall resolution, choose_type/fill for LM routing, no incant. v2 integration tests pass. Old test_dep_injection.py fully replaced with v2 equivalents.
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/test_dep_injection.py -x -v` -- all v2 integration tests pass
- `grep -r "incant" bae/graph.py` returns nothing
- `grep -r "from incant" bae/` returns nothing
- Graph.run() signature has `max_iters: int = 10` (not max_steps)
- Graph.run() does NOT accept **kwargs
- Terminal node appears in trace (last element)
- DepError raised on dep failures with trace attribute
</verification>

<success_criteria>
- Graph.run() v2 execution loop: resolve_fields -> set on self -> __call__ -> LM route
- All incant code removed from graph.py (imports, helpers, usage)
- v2 integration tests cover: dep resolution, recall resolution, custom __call__, dep failure, iteration guard, terminal-in-trace
- MockV2LM uses choose_type/fill (not make/decide)
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration/07-02-SUMMARY.md`
</output>
