---
phase: 07-integration
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - tests/test_graph.py
  - tests/test_auto_routing.py
  - tests/test_integration_dspy.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "test_graph.py MockLM implements v2 API (choose_type/fill) and tests use max_iters instead of max_steps"
    - "test_auto_routing.py MockLM implements v2 API and auto-routing tests verify fill/choose_type calls"
    - "test_integration_dspy.py v1 incant tests (TestBindDepValueFlow, TestExternalDepInjection, test_dep_params_injected_via_incant) are deleted and replaced with v2 equivalents"
    - "incant is removed from pyproject.toml dependencies"
    - "All 291+ tests pass with zero failures"
  artifacts:
    - path: "tests/test_graph.py"
      provides: "Updated MockLM with v2 API, max_iters usage"
      contains: "max_iters"
    - path: "tests/test_auto_routing.py"
      provides: "Updated MockLM with v2 API"
      contains: "choose_type"
    - path: "tests/test_integration_dspy.py"
      provides: "v2 integration tests replacing v1 incant tests"
    - path: "pyproject.toml"
      provides: "No incant dependency"
  key_links:
    - from: "tests/test_graph.py"
      to: "bae/graph.py"
      via: "Tests exercise Graph.run() with v2 MockLM"
      pattern: "graph\\.run"
    - from: "pyproject.toml"
      to: "bae/graph.py"
      via: "incant removed from deps, graph.py no longer imports it"
      pattern: "dependencies"
---

<objective>
Migrate remaining v1 test files to v2 patterns and remove incant from pyproject.toml. After this plan, all tests pass and incant is fully gone.

Purpose: Plan 02 rewrote Graph.run() and test_dep_injection.py but left other test files using v1 MockLM (make/decide) and max_steps. These tests will be failing after Plan 02. This plan updates them and removes the incant dependency entirely.

Output: Updated test_graph.py, test_auto_routing.py, test_integration_dspy.py. Updated pyproject.toml without incant.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-integration/07-CONTEXT.md
@.planning/phases/07-integration/07-RESEARCH.md
@.planning/phases/07-integration/07-02-SUMMARY.md

@bae/graph.py
@tests/test_graph.py
@tests/test_auto_routing.py
@tests/test_integration_dspy.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update test_graph.py and test_auto_routing.py for v2</name>
  <files>tests/test_graph.py, tests/test_auto_routing.py</files>
  <action>
**test_graph.py changes:**

1. The test node classes (Start, Clarify, Process, Review, LoopA, LoopB, Infinite) all have custom `__call__` with `lm: LM` parameter and explicit `lm.decide(self)` / `lm.make(self, T)` calls. These are "custom" strategy nodes (non-ellipsis body). The v2 loop calls `current(lm)` for custom nodes when `_wants_lm` is True.

   The MockLM MUST still implement `make` and `decide` because the NODES call these methods from their custom `__call__` bodies. But the v2 Graph.run() loop calls `current(lm)` for custom nodes, which then calls `lm.make()/lm.decide()` internally. So the MockLM can keep make/decide.

   HOWEVER, the MockLM also needs `choose_type` and `fill` stubs to satisfy the Protocol shape if any test exercises ellipsis-body nodes. Add stub methods:
   ```python
   def choose_type(self, types, context):
       raise NotImplementedError("v1 test mock")
   def fill(self, target, context, instruction):
       raise NotImplementedError("v1 test mock")
   ```

2. `test_run_max_steps` uses `max_steps=10`. Change to `max_iters=10`. Also update the expected error: v2 raises BaeError, not RuntimeError. Update `pytest.raises(RuntimeError, match="exceeded")` to `pytest.raises(BaeError, match="exceeded")`. Add import for BaeError.

3. The `test_run_simple_path` and `test_run_multiple_steps` assertions check `result.node is None`. In v2, GraphResult still has `node=None` when graph terminates. These should still pass.

   WAIT: Check trace length expectations. In v1, terminal node with strategy "terminal" does NOT add to trace (loop exits). In v2, terminal node IS added to trace before loop exits. The test `test_run_simple_path` expects `len(result.trace) == 2` (Start, Process). But Process has `__call__` returning `None`, so it's in the trace. And Start's custom `__call__` returns Process, so the loop:
   - iter 1: current=Start, resolve fields, trace=[Start], custom __call__ returns Process(task="do it"), current=Process
   - iter 2: current=Process, resolve fields, trace=[Start, Process], custom __call__ returns None (from lm.decide), current=None
   - Loop exits. trace = [Start, Process]. Result: GraphResult(node=None, trace=[Start, Process])

   Actually wait -- Process has custom __call__ that calls `lm.decide(self)`. The mock returns `None`. So Process.__call__ returns None. Strategy is "custom" (non-ellipsis body). So the v2 loop does: `current = current(lm)` which returns None. current is now None, loop exits. trace = [Start, Process]. len == 2. Same as v1 expectations. Good.

   `test_run_multiple_steps` expects trace length 3 (Start, Process, Review). Same logic applies -- custom __call__ nodes. Should be fine.

4. But Infinite node: `def __call__(self, lm: LM) -> Infinite: return Infinite(x=self.x + 1)` -- custom strategy. v2 loop calls current(lm). But Infinite.__call__ doesn't use lm. _wants_lm returns True (has `lm: LM` param). So v2 calls `current(lm)` which works fine.

**test_auto_routing.py changes:**

1. MockLM needs v2 API methods. The auto-routing tests exercise ellipsis-body nodes, which in v2 use `choose_type`/`fill` (not `make`/`decide`).

   Replace MockLM with a v2-compatible version:
   ```python
   class MockLM:
       """Mock LM for testing v2 auto-routing."""
       def __init__(self, sequence: list[Node | None] | None = None):
           self.sequence = sequence or []
           self.index = 0
           self.fill_calls: list[tuple[type, dict, str]] = []
           self.choose_type_calls: list[tuple[list, dict]] = []

       def choose_type(self, types, context):
           self.choose_type_calls.append((types, context))
           # Return the type of the next item in sequence
           next_node = self.sequence[self.index]
           if next_node is None:
               return types[0]  # Shouldn't happen for choose_type
           return type(next_node)

       def fill(self, target, context, instruction):
           self.fill_calls.append((target, context, instruction))
           result = self.sequence[self.index]
           self.index += 1
           return result

       # v1 stubs for custom __call__ nodes that still call lm.make/decide
       def make(self, node, target):
           result = self.sequence[self.index]
           self.index += 1
           return result

       def decide(self, node):
           result = self.sequence[self.index]
           self.index += 1
           return result
   ```

2. Update TestGraphRunAutoRouting assertions:
   - `test_ellipsis_union_calls_lm_decide`: Now should check `lm.choose_type_calls` instead of `lm.decide_calls`. Ellipsis union uses choose_type then fill.
   - `test_ellipsis_single_calls_lm_make`: Now should check `lm.fill_calls` instead of `lm.make_calls`. Ellipsis single uses fill directly.
   - `test_custom_logic_called_directly`: Custom __call__ still calls lm.make internally, so lm.make is called. This test might stay similar.
   - `test_ellipsis_terminal_returns_graph_result_with_none`: Terminal node -- no LM calls. Stays the same.
   - `test_graph_run_returns_graph_result`: Update if needed.
   - `test_trace_includes_all_nodes`: In v2, trace ordering should still be [start, mid, end]. But StartSingleNode has ellipsis body with single return -> fill. MidNode has ellipsis body with single return -> fill. TerminalTarget has ellipsis body with None return -> terminal. Trace should include all three. Check expectations.

   IMPORTANT: In v2, the trace includes the terminal node. The v1 test `test_ellipsis_terminal_returns_graph_result_with_none` checks `len(result.trace) == 1` (just start node). In v2, the terminal node IS the start node (PureTerminalNode returns None). It enters the loop, gets resolved, appended to trace, strategy is terminal, current = None. trace = [PureTerminalNode]. len == 1. Same. Good.

3. The trace test `test_trace_includes_all_nodes` uses StartSingleNode -> MidNode -> TerminalTarget. In v2 with ellipsis bodies and fill, the sequence has [mid, end] (fill returns these). But now both fill calls consume from sequence. And terminal node enters loop, gets appended. trace = [start, mid, end]. len == 3. Same as v1. Good.

After updating both files, run full test suite to verify.
Commit: `fix(07-03): update test_graph and test_auto_routing for v2 Graph.run()`
  </action>
  <verify>`cd /Users/dzaramelcone/lab/bae && python -m pytest tests/test_graph.py tests/test_auto_routing.py -x -v` -- all tests pass</verify>
  <done>test_graph.py and test_auto_routing.py use v2 MockLM (choose_type/fill), max_iters, and BaeError for iteration guard</done>
</task>

<task type="auto">
  <name>Task 2: Update test_integration_dspy.py + remove incant from pyproject.toml</name>
  <files>tests/test_integration_dspy.py, pyproject.toml</files>
  <action>
**test_integration_dspy.py changes:**

1. **Delete v1 incant-specific tests:**
   - `TestBindDepValueFlow` class (tests Bind -> Dep via incant) -- DELETE entirely
   - `TestExternalDepInjection` class (tests run() kwargs -> incant injection) -- DELETE entirely
   - `test_dep_params_injected_via_incant` inside `TestPhase2SuccessCriteria` -- DELETE

2. **Delete v1 test node classes** that are no longer used after deleting the above:
   - `Initialize`, `UseConnection`, `FinalResult` (Bind/Dep flow nodes)
   - `NeedsConfig`, `ConfigResult` (external dep injection nodes)
   - `DatabaseConn`, `Config` (external dep types)
   - Only delete if no remaining test uses them. Check carefully.

3. **Update MockLM** in test_integration_dspy.py to include v2 API:
   ```python
   class MockLM:
       def __init__(self, responses: dict[type, Node | None]):
           self.responses = responses
           self.fill_calls = []
           self.choose_type_calls = []

       def choose_type(self, types, context):
           self.choose_type_calls.append((types, context))
           for t in types:
               if t in self.responses:
                   return t
           return types[0]

       def fill(self, target, context, instruction):
           self.fill_calls.append((target, context, instruction))
           return self.responses[target]

       # v1 stubs for custom __call__ that still use make/decide
       def make(self, node, target):
           return self.responses[target]

       def decide(self, node):
           for target in node.successors():
               if target in self.responses:
                   return self.responses[target]
           return None
   ```

4. **Update auto-routing tests:**
   - `TestAutoRoutingUnionType.test_union_return_type_calls_lm_decide`: AnalyzeQuery has ellipsis body with union return. In v2, this calls choose_type + fill (not decide). Update assertions to check `lm.choose_type_calls` and `lm.fill_calls`.
   - `TestAutoRoutingSingleType.test_single_return_type_calls_lm_make`: ProcessComplex has ellipsis body with single return. In v2, this calls fill (not make). Update assertions.
   - `TestCustomCallEscapeHatch`: StartCustom has custom __call__ that calls `lm.make(self, EndCustom)`. This still works -- v2 calls `current(lm)` for custom nodes. Keep test logic, just verify MockLM has make method.

5. **Update TestDSPyBackendDefault:**
   - `test_graph_run_without_lm_uses_dspy_backend`: Done node is terminal with ellipsis body. v2 loop: resolve, append, terminal, exit. No LM calls needed. Should still pass.
   - `test_dspy_backend_used_for_auto_routing`: ProcessSimple has ellipsis body with `Done | None` return. In v2, this uses choose_type + fill via DSPyBackend. The mock patches `dspy.Predict`. In v2, DSPyBackend.choose_type uses dspy.Predict (see dspy_backend.py line 329). This test may need adjustment to account for v2 choose_type calling predict differently.

   Actually, this test mocks `dspy.Predict` globally and just checks it was called. The v2 DSPyBackend.choose_type still calls `dspy.Predict`, so the assertion `assert mock_predict_cls.called` should still pass. But the side_effect may need updating -- v2 choose_type expects a `choice` field in the result, and fill expects node fields. Review carefully.

6. **Update TestGraphResultTrace:**
   - These tests use MockLM with v1 `decide`/`make`. The nodes (AnalyzeQuery, ProcessSimple, ProcessComplex, Review, Done) have ellipsis bodies. In v2, ellipsis nodes use choose_type/fill. Update MockLM to v2 and adjust assertions.

   Trace expectations: In v2, terminal node IS in trace. The test `test_trace_shows_full_execution_path` expects trace = [AnalyzeQuery, ProcessComplex, Review, Done] with len 4. In v2, Done is terminal and gets appended to trace. len == 4 still. Good.

7. **Update TestPhase2SuccessCriteria:**
   - Remove `test_dep_params_injected_via_incant` (incant gone)
   - Other tests reference auto-routing/DSPy which still apply conceptually
   - `test_pydantic_models_parse_from_dspy_output`: Tests DSPyBackend.make() directly -- still valid
   - `test_union_return_types_two_step_pattern`: Tests DSPyBackend.decide() directly -- still valid (decide is v1 but DSPyBackend still has it for backward compat until Phase 8)

8. **Remove unused imports:** `Bind`, `Dep` if no longer used in this file. Keep `Context` if still used by node class definitions.

**pyproject.toml change:**
Remove `"incant>=1.0"` from the dependencies list.

Run full test suite.
Commit: `fix(07-03): migrate test_integration_dspy to v2, remove incant dependency`
  </action>
  <verify>
`cd /Users/dzaramelcone/lab/bae && python -m pytest tests/ -x -q` -- ALL tests pass (291+)
`grep "incant" pyproject.toml` -- returns nothing
`python -c "import bae; print('ok')"` -- imports cleanly without incant
  </verify>
  <done>All v1 incant tests deleted/replaced, MockLMs updated to v2 API, incant removed from pyproject.toml, full test suite passes</done>
</task>

</tasks>

<verification>
- `python -m pytest tests/ -x -q` -- ALL tests pass, zero failures
- `grep -r "incant" bae/ tests/ pyproject.toml` -- returns nothing (incant fully removed)
- `grep "max_steps" tests/` -- returns nothing (all updated to max_iters)
- No test imports Bind from bae (unless used in test_bind_validation.py which is Phase 8 concern)
</verification>

<success_criteria>
- test_graph.py, test_auto_routing.py, test_integration_dspy.py all pass with v2 patterns
- incant fully removed from pyproject.toml
- No references to incant in bae/ or tests/
- All MockLMs implement v2 API (choose_type/fill)
- Full test suite passes (291+ tests, 0 failures)
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration/07-03-SUMMARY.md`
</output>
