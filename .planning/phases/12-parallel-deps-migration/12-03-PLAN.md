---
phase: 12-parallel-deps-migration
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - tests/test_resolver.py
  - tests/test_dep_injection.py
  - tests/test_graph.py
  - tests/test_auto_routing.py
  - tests/test_fill_protocol.py
  - tests/test_integration.py
  - tests/test_integration_dspy.py
  - tests/test_ootd_e2e.py
  - tests/test_compiler.py
autonomous: true

must_haves:
  truths:
    - "All tests in test_resolver.py that call resolve_dep/resolve_fields are async def with await"
    - "All tests calling graph.run() are changed to graph.arun() with await"
    - "CompiledGraph tests calling compiled.run() are changed to compiled.arun() with await"
    - "Full test suite passes: 313+ passed, 0 failed"
    - "No 'coroutine was never awaited' warnings"
    - "No tests deleted (323+ collected)"
  artifacts:
    - path: "tests/test_resolver.py"
      provides: "Async tests for resolve_dep and resolve_fields"
      contains: "async def test_resolve"
    - path: "tests/test_graph.py"
      provides: "Tests using graph.arun()"
      contains: "graph.arun"
    - path: "tests/test_dep_injection.py"
      provides: "Tests using graph.arun()"
      contains: "graph.arun"
  key_links:
    - from: "test_resolver.py TestResolveDep"
      to: "resolve_dep"
      via: "await resolve_dep(fn, cache)"
      pattern: "await resolve_dep"
    - from: "test_resolver.py TestResolveFields"
      to: "resolve_fields"
      via: "await resolve_fields(node_cls, trace, dep_cache)"
      pattern: "await resolve_fields"
    - from: "test_graph.py/test_dep_injection.py/etc"
      to: "Graph.arun()"
      via: "await graph.arun(...)"
      pattern: "await graph\\.arun"
---

<objective>
Migrate all existing tests to use async resolve_dep/resolve_fields and graph.arun().

Purpose: After Plans 01 and 02 changed the function signatures, all existing tests that call these functions must be updated. This is mechanical but high-volume migration across ~9 test files.

Output: All existing tests pass with the new async API. Zero test deletions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-parallel-deps-migration/12-RESEARCH.md
@.planning/phases/12-parallel-deps-migration/12-01-SUMMARY.md
@.planning/phases/12-parallel-deps-migration/12-02-SUMMARY.md
@tests/test_resolver.py
@tests/test_dep_injection.py
@tests/test_graph.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test_resolver.py to async</name>
  <files>tests/test_resolver.py</files>
  <action>
Convert all tests that call resolve_dep() or resolve_fields() to async:

**TestResolveDep class (~5 tests):**
- `def test_resolve_leaf_dep` -> `async def test_resolve_leaf_dep`
  - `result = resolve_dep(...)` -> `result = await resolve_dep(...)`
- `def test_resolve_chained_dep` -> `async def test_resolve_chained_dep`
  - Same await pattern
- `def test_cache_prevents_duplicate_calls` -> `async def test_cache_prevents_duplicate_calls`
  - Both `resolve_dep` calls get `await`
- `def test_cache_keyed_by_identity` -> `async def test_cache_keyed_by_identity`
  - `result = resolve_dep(...)` -> `result = await resolve_dep(...)`
- `def test_dep_exception_propagates_raw` -> `async def test_dep_exception_propagates_raw`
  - `resolve_dep(failing_dep, {})` -> `await resolve_dep(failing_dep, {})`

**TestResolveFields class (~8 tests):**
- All test methods: `def` -> `async def`
- All `resolve_fields(...)` calls: add `await`
- Specifically:
  - test_resolve_dep_field
  - test_resolve_recall_field
  - test_resolve_mixed_fields
  - test_resolve_fields_declaration_order
  - test_resolve_dep_caching_across_fields
  - test_resolve_fields_empty_for_plain_only
  - test_dep_cache_persists_across_calls (has TWO resolve_fields calls -- both need await)

**Leave these test classes UNCHANGED (they test sync functions):**
- TestDepMarker (tests Dep dataclass)
- TestRecallMarker (tests Recall dataclass)
- TestRecallError (tests exception class)
- TestClassifyFields (tests classify_fields -- stays sync)
- TestRecallFromTrace (tests recall_from_trace -- stays sync)
- TestBuildDepDag (tests build_dep_dag -- stays sync)
- TestValidateNodeDeps (tests validate_node_deps -- stays sync)

With asyncio_mode="auto" in pyproject.toml, no @pytest.mark.asyncio decorators needed -- just `async def` is sufficient.
  </action>
  <verify>
Run `uv run python -m pytest tests/test_resolver.py -v --tb=short` -- all tests pass, 0 failures.
  </verify>
  <done>All resolve_dep/resolve_fields test methods are async def with await. Sync-only test classes untouched. All resolver tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate graph.run() -> graph.arun() across all test files</name>
  <files>tests/test_dep_injection.py, tests/test_graph.py, tests/test_auto_routing.py, tests/test_fill_protocol.py, tests/test_integration.py, tests/test_integration_dspy.py, tests/test_ootd_e2e.py, tests/test_compiler.py</files>
  <action>
Mechanical search-and-replace across test files. For each file:

**Pattern:** `await graph.run(` -> `await graph.arun(`
**Pattern:** `await compiled.run(` -> `await compiled.arun(`

Specific files and expected change counts (from grep analysis):

1. **tests/test_dep_injection.py** (~8 occurrences of `graph.run`):
   - All `await graph.run(` -> `await graph.arun(`
   - Check docstrings mentioning `graph.run` -- update those to `graph.arun` too

2. **tests/test_graph.py** (~3 occurrences):
   - All `await graph.run(` -> `await graph.arun(`

3. **tests/test_auto_routing.py** (~6 occurrences):
   - All `await graph.run(` -> `await graph.arun(`
   - Class/method docstrings mentioning `Graph.run()` routing -- update to `Graph.arun()`

4. **tests/test_fill_protocol.py** (~3 occurrences):
   - All `await graph.run(` -> `await graph.arun(`

5. **tests/test_integration.py** (~4 occurrences):
   - All `await graph.run(` -> `await graph.arun(`

6. **tests/test_integration_dspy.py** (~7 occurrences):
   - All `await graph.run(` -> `await graph.arun(`
   - One test calls `await graph.run(Done(result="test"))` without lm= -- this becomes `await graph.arun(Done(result="test"))`

7. **tests/test_ootd_e2e.py** (~1 occurrence):
   - `await graph.run(` -> `await graph.arun(`

8. **tests/test_compiler.py** (~3 occurrences of `compiled.run`):
   - `await compiled.run(` -> `await compiled.arun(`
   - Check for any `graph.run` references too

**Important:** Do NOT change any test that's already calling `graph.run()` synchronously (without await) -- there shouldn't be any in tests, but if found, leave them. Tests run inside pytest-asyncio's event loop, so they must use `arun()`.

**Also update:** Any string literals or docstrings that reference the API change, e.g., "graph.run() auto-routing" -> "graph.arun() auto-routing".

After all changes, run the full test suite.
  </action>
  <verify>
Run `uv run python -m pytest tests/ -v --tb=short` -- full suite.
Expected: 313+ passed, 10 skipped (5 PydanticAI key, 5 E2E flag), 0 failed.

Grep `await graph\.run\(` across tests/ -- should find ZERO matches (all converted to arun).
Grep `await compiled\.run\(` across tests/ -- should find ZERO matches.
Grep `await.*\.arun\(` across tests/ -- should find all the converted calls.

No "coroutine was never awaited" warnings in test output.
  </verify>
  <done>All test files migrated from graph.run() to graph.arun(). Full test suite passes with 313+ passed, 0 failed. No coroutine warnings. No tests deleted.</done>
</task>

</tasks>

<verification>
- `uv run python -m pytest tests/ -v --tb=short` passes with 313+ passed, 0 failed
- No `await graph.run(` in any test file (all converted to arun)
- No `await compiled.run(` in any test file (all converted to arun)
- No tests deleted (323+ collected)
- No "coroutine was never awaited" warnings
- test_resolver.py resolve_dep/resolve_fields tests are async def
</verification>

<success_criteria>
Full existing test suite passes. All graph.run() calls in tests converted to graph.arun(). All resolve_dep/resolve_fields calls in tests use await. Zero test deletions. Zero coroutine warnings.
</success_criteria>

<output>
After completion, create `.planning/phases/12-parallel-deps-migration/12-03-SUMMARY.md`
</output>
