---
phase: 27-graph-mode
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/repl/graph_commands.py
  - bae/repl/views.py
  - tests/repl/test_graph_commands.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "list command renders a properly formatted Rich table (box-drawing, alignment) instead of raw escape codes"
    - "inspect command renders Rich Text output correctly"
  artifacts:
    - path: "bae/repl/graph_commands.py"
      provides: "ANSI metadata on router.write calls that send Rich-rendered content"
      contains: 'metadata=.*"type".*"ansi"'
    - path: "bae/repl/views.py"
      provides: "ANSI-aware rendering in all three formatters"
      contains: 'ANSI(content)'
  key_links:
    - from: "bae/repl/graph_commands.py"
      to: "bae/repl/views.py"
      via: "metadata type=ansi signals formatter to use ANSI() wrapper"
      pattern: '"type".*"ansi"'
---

<objective>
Fix ANSI rendering for GRAPH mode commands so Rich tables and text display correctly instead of showing raw escape codes.

Purpose: UAT showed `list` renders as garbled escape sequences because ANSI-formatted strings go through formatters that treat them as plain text.
Output: Rich-rendered content from graph commands displays with proper formatting in all view modes.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/27-graph-mode/27-02-SUMMARY.md
@.planning/debug/graph-list-ansi-escape-codes.md
@bae/repl/graph_commands.py
@bae/repl/views.py
@bae/repl/channels.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ANSI metadata to graph command router.write calls</name>
  <files>bae/repl/graph_commands.py</files>
  <action>
Two router.write() calls in graph_commands.py send Rich-rendered ANSI content but lack metadata signaling this:

1. **_cmd_list** (line 140): `shell.router.write("graph", _rich_to_ansi(table).rstrip("\n"), mode="GRAPH")`
   Change to: `shell.router.write("graph", _rich_to_ansi(table).rstrip("\n"), mode="GRAPH", metadata={"type": "ansi"})`

2. **_cmd_inspect** (line 206): `shell.router.write("graph", _rich_to_ansi(text).rstrip("\n"), mode="GRAPH")`
   Change to: `shell.router.write("graph", _rich_to_ansi(text).rstrip("\n"), mode="GRAPH", metadata={"type": "ansi"})`

No other changes to graph_commands.py. The error metadata on _cmd_run (line 64) and plain text writes are correct as-is.
  </action>
  <verify>Grep confirms: `grep -n '"type": "ansi"' bae/repl/graph_commands.py` shows two matches (list and inspect).</verify>
  <done>Both _cmd_list and _cmd_inspect signal their content as ANSI-formatted via metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Handle ANSI metadata in all three view formatters</name>
  <files>bae/repl/views.py, tests/repl/test_graph_commands.py</files>
  <action>
All three formatters need to detect `metadata.type == "ansi"` and render with prompt_toolkit's `ANSI()` wrapper instead of `FormattedText()`.

**UserView.render** (views.py line 73): Add an early return for ANSI content BEFORE the content_type switch. After `meta = metadata or {}` and `content_type = meta.get("type", "")`, add:

```python
if content_type == "ansi":
    print_formatted_text(ANSI(content))
    return
```

This goes before the ai_exec check (line 77) since ANSI content should never be buffered.

**DebugView.render** (views.py line 177): Add ANSI handling at the top of the method, after `meta = metadata or {}`:

```python
if meta.get("type") == "ansi":
    # Still show channel header for debug context
    meta_str = " ".join(f"{k}={v}" for k, v in sorted(meta.items()))
    header = f"[{channel_name}] {meta_str}"
    print_formatted_text(FormattedText([(f"{color} bold", header)]))
    print_formatted_text(ANSI(content))
    return
```

**AISelfView.render** (views.py line 205): Add ANSI handling after tag computation (line 208), before the display variable:

```python
if meta.get("type") == "ansi":
    print_formatted_text(FormattedText([("fg:#b0b040 bold", f"[{tag}]")]))
    print_formatted_text(ANSI(content))
    return
```

ANSI is already imported at line 20: `from prompt_toolkit.formatted_text import ANSI, FormattedText` -- no new imports needed.

**tests/repl/test_graph_commands.py**: Add a test that verifies _cmd_list passes metadata with type "ansi" to router.write. Use the existing FakeShell/FakeRouter pattern from the test file. Create a graph run in the registry, call _cmd_list, and check that FakeRouter captured a write with `metadata={"type": "ansi"}` in the call args. Similarly for _cmd_inspect.
  </action>
  <verify>`uv run pytest tests/repl/test_graph_commands.py -x -q` passes. Grep confirms ANSI() usage in all three formatters for the "ansi" metadata type.</verify>
  <done>All three view formatters (UserView, DebugView, AISelfView) render ANSI-tagged content using prompt_toolkit ANSI() wrapper. Rich tables and text from graph commands display correctly in all view modes.</done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/repl/test_graph_commands.py -x -q` -- all pass including new ANSI metadata tests
2. `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full suite passes
3. Grep confirms: `grep -n '"type": "ansi"' bae/repl/graph_commands.py` shows metadata on list and inspect
4. Grep confirms: `grep -n 'ANSI(content)' bae/repl/views.py` shows ANSI rendering in all three formatters
</verification>

<success_criteria>
- _cmd_list and _cmd_inspect pass metadata={"type": "ansi"} to router.write
- UserView, DebugView, and AISelfView all detect type=ansi and use ANSI() wrapper
- Rich table from list and Rich text from inspect render as formatted output, not raw escape codes
- All existing + new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-graph-mode/27-05-SUMMARY.md`
</output>
