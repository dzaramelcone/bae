---
phase: 08-cleanup-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/markers.py
  - bae/compiler.py
  - bae/dspy_backend.py
  - bae/graph.py
  - bae/__init__.py
  - bae/lm.py
autonomous: true

must_haves:
  truths:
    - "Context class no longer exists in markers.py"
    - "Bind class no longer exists in markers.py"
    - "Dep.description field no longer exists"
    - "from bae import Context raises AttributeError"
    - "from bae import Bind raises AttributeError"
    - "_extract_context_fields is gone from compiler.py and dspy_backend.py"
    - "_validate_bind_uniqueness is gone from graph.py"
    - "LM Protocol docstring no longer mentions Phase 8 removal"
  artifacts:
    - path: "bae/markers.py"
      provides: "Dep (fn-only) and Recall markers"
      contains: "class Dep"
    - path: "bae/compiler.py"
      provides: "node_to_signature, compile_graph, CompiledGraph"
    - path: "bae/dspy_backend.py"
      provides: "DSPyBackend with rewritten _build_inputs"
    - path: "bae/graph.py"
      provides: "Graph with validate() minus Bind check"
    - path: "bae/__init__.py"
      provides: "Package exports minus Context and Bind"
    - path: "bae/lm.py"
      provides: "LM Protocol with updated docstring"
  key_links:
    - from: "bae/dspy_backend.py"
      to: "bae/compiler.py"
      via: "node_to_signature import"
      pattern: "from bae.compiler import node_to_signature"
    - from: "bae/graph.py"
      to: "bae/resolver.py"
      via: "resolve_fields import"
      pattern: "from bae.resolver import resolve_fields"
---

<objective>
Remove all v1 marker code (Context, Bind) from source files and clean up Dep to v2-only form.

Purpose: This is the foundational source-side cleanup. After this plan, the bae package source code contains zero references to Context or Bind. Tests will temporarily break -- Plans 02 and 03 fix them.

Output: Clean source files with v1 markers fully excised.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Context and Bind from markers.py, clean up Dep</name>
  <files>bae/markers.py</files>
  <action>
  In bae/markers.py:

  1. Delete the entire `Context` class (lines 12-20 approximately -- the frozen dataclass with description field).

  2. Delete the entire `Bind` class (lines 52-74 approximately -- the frozen dataclass with pass body and docstring).

  3. Clean up `Dep` class:
     - Remove the `description: str = ""` field entirely. Dep should only have `fn: Callable | None = None`.
     - Rewrite the docstring to v2-only. Remove all v1 references, deprecated warnings, and v1 usage examples. The new docstring should describe Dep(callable) for field-level dependency injection only.
     - Remove the v1 `__call__` parameter usage example from docstring.

  4. Update the module docstring at the top to remove references to Context markers and v1 Signature generation. The module provides Dep and Recall markers for bae Node fields.

  The file should export only: Dep, Recall. No Context, no Bind.
  </action>
  <verify>
  Run: `cd /Users/dzaramelcone/lab/bae && uv run python -c "from bae.markers import Dep, Recall; d = Dep(lambda: 42); print('OK:', d.fn); r = Recall(); print('OK:', r)"`
  Confirm Dep(fn) works. Then:
  `uv run python -c "from bae.markers import Context" 2>&1` -- should produce ImportError.
  `uv run python -c "from bae.markers import Bind" 2>&1` -- should produce ImportError.
  `uv run python -c "from bae.markers import Dep; Dep(description='x')" 2>&1` -- should produce TypeError (no description param).
  </verify>
  <done>markers.py contains only Dep (with fn field) and Recall. Context and Bind classes are deleted. Dep.description field is gone.</done>
</task>

<task type="auto">
  <name>Task 2: Remove v1 code from compiler.py, dspy_backend.py, graph.py, __init__.py, lm.py</name>
  <files>bae/compiler.py, bae/dspy_backend.py, bae/graph.py, bae/__init__.py, bae/lm.py</files>
  <action>
  **bae/compiler.py:**
  1. Delete the entire `_extract_context_fields()` function (lines 93-115). It was kept for v1 backward compat.
  2. Remove `from bae.markers import Context` import (line 16). No markers import needed -- node_to_signature uses classify_fields from resolver.
  3. Keep everything else (node_to_signature, compile_graph, CompiledGraph) unchanged.

  **bae/dspy_backend.py:**
  1. Delete the `_extract_context_fields()` method from DSPyBackend class (lines 66-81).
  2. Rewrite `_build_inputs()` method. It currently calls `_extract_context_fields()`. Replace with:
     ```python
     def _build_inputs(self, node: Node, **deps: Any) -> dict[str, Any]:
         """Build input dict from node fields and deps."""
         inputs = {name: getattr(node, name) for name in node.model_fields}
         inputs.update(deps)
         return inputs
     ```
     This collects ALL field values from the node (not just Context-annotated ones), which is the correct v2 behavior since all fields are potential inputs.
  3. Remove `from bae.markers import Context, Dep` import (line 20). If Dep is still needed elsewhere in the file, keep only Dep. Check: Dep is NOT used in dspy_backend.py source code (only Context was used in _extract_context_fields). So remove the entire markers import line.
  4. Remove unused imports: `Annotated, get_args, get_origin, get_type_hints` from the typing import IF they are no longer used after removing _extract_context_fields. Check each: `get_type_hints` is used in `_get_return_types` (line 191). `get_args` is used in `_get_return_types`. `get_origin` is used in `_extract_context_fields` only -- remove it. `Annotated` is used in `_extract_context_fields` only -- remove it. Keep `get_type_hints` and `get_args`.

  **bae/graph.py:**
  1. Delete the entire `_validate_bind_uniqueness()` method from Graph class (lines 197-228).
  2. In `validate()` method, remove the line `issues.extend(self._validate_bind_uniqueness())` (line 193).
  3. Remove `from bae.markers import Bind` import (line 13).
  4. Clean up unused typing imports: `Annotated, get_args, get_origin, get_type_hints` -- check which are still used elsewhere in graph.py. `get_type_hints` is used in `_get_routing_strategy` (line 75). `get_args` is used there too. `get_origin` is used in `_get_base_type` (line 26). `Annotated` is used in `_get_base_type` (line 26). All four are still used -- keep them all.

  **bae/__init__.py:**
  1. Remove `Context` and `Bind` from the `from bae.markers import Bind, Context, Dep, Recall` line. Change to: `from bae.markers import Dep, Recall`
  2. Remove `"Context"`, `"Bind"` from `__all__` list. Keep `"Dep"` and `"Recall"` in the Markers section.

  **bae/lm.py:**
  1. Update the LM Protocol class docstring. Change:
     `v1 methods (make/decide): node-centric, will be removed in Phase 8.`
     to:
     `v1 methods (make/decide): node-centric, kept for custom __call__ escape-hatch nodes.`
     Remove the line `v2 methods (choose_type/fill): context-dict-centric, used by v2 runtime.` -- now that v2 IS the runtime, just say:
     `v2 methods (choose_type/fill): context-dict-centric, used by the graph runtime.`
  </action>
  <verify>
  Run: `cd /Users/dzaramelcone/lab/bae && uv run python -c "from bae import Dep, Recall, Graph, Node; print('Package imports OK')"` -- should succeed.
  Run: `uv run python -c "from bae import Context" 2>&1` -- should fail with ImportError.
  Run: `uv run python -c "from bae import Bind" 2>&1` -- should fail with ImportError.
  Run: `uv run python -c "from bae.compiler import _extract_context_fields" 2>&1` -- should fail with ImportError.
  Run: `uv run python -c "import bae.graph; print(hasattr(bae.graph.Graph, '_validate_bind_uniqueness'))"` -- should print False.

  NOTE: Tests WILL fail at this point. That is expected. Plans 02 and 03 fix the tests.
  </verify>
  <done>All five source files updated. Context and Bind removed from package exports. _extract_context_fields deleted from compiler.py and dspy_backend.py. _validate_bind_uniqueness deleted from graph.py. LM docstring updated. Dep.description removed.</done>
</task>

</tasks>

<verification>
- bae/markers.py exports only Dep(fn) and Recall
- bae/__init__.py exports do not include Context or Bind
- No source file in bae/ imports Context or Bind
- `uv run python -c "import bae; print([x for x in dir(bae) if x in ('Context', 'Bind')])"` prints `[]`
</verification>

<success_criteria>
- Context class deleted from markers.py
- Bind class deleted from markers.py
- Dep.description field removed
- _extract_context_fields removed from compiler.py and dspy_backend.py
- _validate_bind_uniqueness removed from graph.py
- __init__.py no longer exports Context or Bind
- LM Protocol docstring updated (no Phase 8 reference)
- All changes committed
</success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup-migration/08-01-SUMMARY.md`
</output>
