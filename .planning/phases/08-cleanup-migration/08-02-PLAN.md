---
phase: 08-cleanup-migration
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - tests/test_bind_validation.py
  - tests/test_compiler.py
  - tests/test_dspy_backend.py
  - tests/test_signature_v2.py
autonomous: true

must_haves:
  truths:
    - "test_bind_validation.py no longer exists"
    - "test_compiler.py has no Context or Bind or Dep(description=...) references"
    - "test_dspy_backend.py fixtures use plain fields instead of Context annotations"
    - "test_dspy_backend.py NodeWithDep __call__ param uses v2 pattern"
    - "test_signature_v2.py TestExistingTestsStillPass class is deleted"
    - "All tests in these files pass"
  artifacts:
    - path: "tests/test_compiler.py"
      provides: "v2-only compiler tests"
    - path: "tests/test_dspy_backend.py"
      provides: "v2-only DSPy backend tests"
    - path: "tests/test_signature_v2.py"
      provides: "v2 signature tests without backward compat section"
  key_links:
    - from: "tests/test_compiler.py"
      to: "bae/compiler.py"
      via: "node_to_signature, compile_graph imports"
      pattern: "from bae.compiler import"
    - from: "tests/test_dspy_backend.py"
      to: "bae/dspy_backend.py"
      via: "DSPyBackend import"
      pattern: "from bae.dspy_backend import DSPyBackend"
---

<objective>
Migrate compiler-adjacent test files to v2 patterns: delete test_bind_validation.py, remove v1 test classes and Context fixtures from test_compiler.py, test_dspy_backend.py, and test_signature_v2.py.

Purpose: These test files reference Context, Bind, and Dep(description=...) which were removed in Plan 01. Without this migration, the test suite fails.

Output: Four test files cleaned up, all tests in these files passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/08-cleanup-migration/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete test_bind_validation.py and clean test_compiler.py</name>
  <files>tests/test_bind_validation.py, tests/test_compiler.py</files>
  <action>
  **tests/test_bind_validation.py:**
  Delete this file entirely. Bind is removed from the codebase. All 7 tests in this file are dead.

  **tests/test_compiler.py:**
  This file has these test classes: TestNodeToSignature, TestContextMarker, TestDepMarker, TestCompiledGraphRunUsesOptimizedLM, TestCompiledGraphRunReturnsGraphResult, TestCreateOptimizedLmFactory.

  Changes needed:

  1. Delete `TestContextMarker` class entirely (3 tests about Context frozen dataclass, description, equality). Context no longer exists.

  2. Delete `TestDepMarker` class entirely (3 tests about Dep(description=...) frozen dataclass, description, equality). These test the removed `description` field. The v2 Dep(fn) is tested elsewhere (test_resolver.py, test_dep_injection.py).

  3. Update `RunStartNode` class definition (used by TestCompiledGraphRunUsesOptimizedLM and TestCompiledGraphRunReturnsGraphResult). Currently:
     ```python
     class RunStartNode(Node):
         text: Annotated[str, Context(description="The text")]
         def __call__(self, lm: LM) -> RunResultNode: ...
     ```
     Change to plain field:
     ```python
     class RunStartNode(Node):
         text: str
         def __call__(self, lm: LM) -> RunResultNode: ...
     ```

  4. Remove `from bae.markers import Context, Dep` import. If other imports from markers are needed, adjust. Check: After removing TestContextMarker and TestDepMarker and the Context annotation on RunStartNode, no markers are needed. Remove the entire markers import line. Also remove `Annotated` from typing import if no longer used (check: TestNodeToSignature uses Annotated for its own fixtures -- grep the file carefully before removing).

  5. Keep TestNodeToSignature, TestCompiledGraphRunUsesOptimizedLM, TestCompiledGraphRunReturnsGraphResult, TestCreateOptimizedLmFactory intact (they test v2 behavior).

  Run tests for just these files after changes:
  `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_compiler.py -v`
  </action>
  <verify>
  `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_compiler.py -v` -- all tests pass, no Context/Bind/Dep(description) references.
  `ls tests/test_bind_validation.py 2>&1` -- file should not exist.
  </verify>
  <done>test_bind_validation.py deleted. test_compiler.py has no v1 marker references. TestContextMarker and TestDepMarker deleted. RunStartNode uses plain field. All remaining tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test_dspy_backend.py and test_signature_v2.py</name>
  <files>tests/test_dspy_backend.py, tests/test_signature_v2.py</files>
  <action>
  **tests/test_dspy_backend.py:**
  This file has multiple test node fixtures using `Context(description="...")` annotations. The migration pattern is mechanical: `Annotated[str, Context(description="...")]` becomes `str`.

  1. Remove `from bae.markers import Context, Dep` import line. If Dep is still needed in the file (check: NodeWithDep uses `Dep(description="Database connection")` in a __call__ param -- that's v1 pattern), handle as follows:
     - The NodeWithDep class has a `__call__` method with `db: Annotated[str, Dep(description="Database connection")]` parameter. This is v1 __call__ parameter injection. In v2, __call__ params are plain. Change to just `db: str` as the parameter type. But check how the test actually uses this -- it may be testing DSPyBackend's ability to handle __call__ deps. Read the test carefully.
     - Actually, these tests test the DSPyBackend.make() and .decide() methods which are v1 LM methods. The tests mock DSPy internals. The Dep annotation on __call__ params was used by _extract_context_fields which is now deleted. Since _build_inputs now collects all node fields, the __call__ signature doesn't affect _build_inputs anymore.
     - Change `db: Annotated[str, Dep(description="Database connection")]` to just `db: str` in NodeWithDep's __call__.

  2. Migrate all Context-annotated fields to plain fields:
     - `SimpleNode.content: Annotated[str, Context(description="The content to process")]` -> `content: str`
     - `SingleSuccessorStart.query: Annotated[str, Context(description="The query")]` -> `query: str`
     - `MultiSuccessorStart.content: Annotated[str, Context(description="Content to analyze")]` -> `content: str`
     - `TerminalNode.data: Annotated[str, Context(description="Data to process")]` -> `data: str`

  3. Remove `Annotated` from typing import if no longer used after all annotations are removed. Check carefully -- other Annotated usages may exist (e.g., Dep(fn) annotations). Grep the file after changes.

  4. Run: `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_dspy_backend.py -v`

  **tests/test_signature_v2.py:**
  1. Delete the `TestExistingTestsStillPass` class entirely (1 test that imports _extract_context_fields and Context, both of which are deleted).
  2. Delete the `TestBackwardCompat` class ONLY if its test is redundant. Check: TestBackwardCompat.test_default_is_non_start tests that node_to_signature() without is_start defaults to non-start behavior. This is still valid v2 behavior -- KEEP this class.
  3. Remove `Context` from any import lines. Check if `Annotated` is still needed (used in test fixtures for Dep/Recall fields). Keep Annotated if still used.
  4. Run: `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_signature_v2.py -v`
  </action>
  <verify>
  `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_dspy_backend.py tests/test_signature_v2.py -v` -- all tests pass.
  Grep for "Context" in both files -- should find zero matches (except maybe in comments/docstrings about v2 migration, which is fine to leave or remove).
  </verify>
  <done>test_dspy_backend.py uses plain fields only, no Context/Dep(description) references. test_signature_v2.py TestExistingTestsStillPass deleted. All remaining tests pass.</done>
</task>

</tasks>

<verification>
Run the full subset of migrated tests:
`cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_compiler.py tests/test_dspy_backend.py tests/test_signature_v2.py -v`
All pass. test_bind_validation.py no longer exists.
</verification>

<success_criteria>
- tests/test_bind_validation.py deleted
- tests/test_compiler.py: TestContextMarker deleted, TestDepMarker deleted, RunStartNode uses plain field
- tests/test_dspy_backend.py: All Context annotations replaced with plain fields, Dep(description=...) removed from __call__ param
- tests/test_signature_v2.py: TestExistingTestsStillPass deleted
- All remaining tests in these files pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup-migration/08-02-SUMMARY.md`
</output>
