---
phase: 08-cleanup-migration
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - tests/test_auto_routing.py
  - tests/test_optimized_lm.py
  - tests/test_optimizer.py
  - tests/test_integration_dspy.py
  - tests/test_resolver.py
autonomous: true

must_haves:
  truths:
    - "test_auto_routing.py has no Context references"
    - "test_optimized_lm.py has no Context references"
    - "test_optimizer.py has no Context references"
    - "test_integration_dspy.py has no Context references"
    - "test_resolver.py test_dep_backward_compat is deleted"
    - "All tests in these files pass"
  artifacts:
    - path: "tests/test_auto_routing.py"
      provides: "v2-only auto routing tests"
    - path: "tests/test_optimized_lm.py"
      provides: "v2-only optimized LM tests"
    - path: "tests/test_optimizer.py"
      provides: "v2-only optimizer tests"
    - path: "tests/test_integration_dspy.py"
      provides: "v2-only DSPy integration tests"
    - path: "tests/test_resolver.py"
      provides: "Resolver tests without v1 Dep backward compat"
  key_links:
    - from: "tests/test_auto_routing.py"
      to: "bae/graph.py"
      via: "Graph import"
      pattern: "from bae.graph import Graph"
    - from: "tests/test_integration_dspy.py"
      to: "bae/graph.py"
      via: "Graph import"
      pattern: "from bae"
---

<objective>
Migrate runtime-adjacent test files to v2 patterns: remove Context annotations from test_auto_routing.py, test_optimized_lm.py, test_optimizer.py, test_integration_dspy.py, and delete v1 backward compat test from test_resolver.py.

Purpose: These test files reference Context which was removed in Plan 01. This plan is parallel with Plan 02 (different files, no overlap).

Output: Five test files cleaned up, all tests in these files passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/08-cleanup-migration/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test_auto_routing.py and test_optimized_lm.py</name>
  <files>tests/test_auto_routing.py, tests/test_optimized_lm.py</files>
  <action>
  **tests/test_auto_routing.py:**
  This file has ~12 Context-annotated fields across many node fixture classes. The migration is mechanical.

  1. Replace every `Annotated[str, Context(description="...")]` with `str` (and similar for other types).
     Specific fields to change (all in module-level node class definitions):
     - Line ~50: `content: Annotated[str, Context(description="Content")]` -> `content: str`
     - Line ~59: `data: Annotated[str, Context(description="Data")]` -> `data: str`
     - Line ~68: `data: Annotated[str, Context(description="Data")]` -> `data: str`
     - Line ~77: `content: Annotated[str, Context(description="Content")]` -> `content: str`
     - Line ~86: `data: Annotated[str, Context(description="Data")]` -> `data: str`
     - Line ~96: `content: Annotated[str, Context(description="Content")]` -> `content: str`
     - Line ~105: `data: Annotated[str, Context(description="Data")]` -> `data: str`
     - Line ~114: `query: Annotated[str, Context(description="Query")]` -> `query: str`
     - Line ~136: `content: Annotated[str, Context(description="Content")]` -> `content: str`
     - Line ~146: `data: Annotated[str, Context(description="Data")]` -> `data: str`
     - Line ~156: `data: Annotated[str, Context(description="Data")]` -> `data: str`

  2. Remove `from bae.markers import Context` import.
  3. Remove `Annotated` from typing import IF no longer used. Check: if any field still uses Annotated (e.g., Dep or Recall annotations), keep it.
  4. Run: `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_auto_routing.py -v`

  **tests/test_optimized_lm.py:**
  1. Replace Context-annotated fields with plain fields:
     - Line ~21: `content: Annotated[str, Context(description="The content")]` -> `content: str`
     - Line ~27: `data: Annotated[str, Context(description="The data")]` -> `data: str`
     - Line ~312: `data: Annotated[str, Context(description="data")]` -> `data: str`

  2. Remove `from bae.markers import Context` import.
  3. Remove `Annotated` from typing import IF no longer used.
  4. Run: `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_optimized_lm.py -v`
  </action>
  <verify>
  `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_auto_routing.py tests/test_optimized_lm.py -v` -- all tests pass.
  Grep for "Context" in both files: zero matches.
  </verify>
  <done>test_auto_routing.py and test_optimized_lm.py use plain fields only, no Context references. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test_optimizer.py, test_integration_dspy.py, and test_resolver.py</name>
  <files>tests/test_optimizer.py, tests/test_integration_dspy.py, tests/test_resolver.py</files>
  <action>
  **tests/test_optimizer.py:**
  1. Replace Context-annotated fields with plain fields. There is one location near line 922:
     - `text: Annotated[str, Context(description="The text")]` -> `text: str`
  2. Remove `from bae.markers import Context` import (near line 906).
  3. Remove `Annotated` from typing import IF no longer used.
  4. Run: `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_optimizer.py -v`

  **tests/test_integration_dspy.py:**
  This file does NOT have an explicit `from bae.markers import Context` -- verify by checking imports. The Context annotations are on inline node classes.
  1. Find the import that brings in Context (may be `from bae import ...` or similar). Check the file header carefully.
  2. Replace all Context-annotated fields with plain fields:
     - Line ~39: `query: Annotated[str, Context(description="The query to analyze")]` -> `query: str`
     - Line ~49: `answer: Annotated[str, Context(description="The answer to provide")]` -> `answer: str`
     - Line ~59: `steps: Annotated[list[str], Context(description="Processing steps to execute")]` -> `steps: list[str]`
     - Line ~69: `summary: Annotated[str, Context(description="Summary of processing")]` -> `summary: str`
  3. Remove Context from imports.
  4. Remove `Annotated` from typing import IF no longer used.
  5. Run: `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_integration_dspy.py -v`

  **tests/test_resolver.py:**
  1. Delete the `test_dep_backward_compat` test method (lines ~106-109). This test verifies `Dep(description="old style")` which is removed.
  2. No other changes needed -- test_resolver.py does not use Context.
  3. Run: `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_resolver.py -v`
  </action>
  <verify>
  `cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_optimizer.py tests/test_integration_dspy.py tests/test_resolver.py -v` -- all tests pass.
  Grep for "Context" across all three files: zero matches in test code (comments about v2 are acceptable).
  </verify>
  <done>test_optimizer.py, test_integration_dspy.py use plain fields only. test_resolver.py test_dep_backward_compat deleted. All tests pass.</done>
</task>

</tasks>

<verification>
Run the full subset of migrated tests:
`cd /Users/dzaramelcone/lab/bae && uv run pytest tests/test_auto_routing.py tests/test_optimized_lm.py tests/test_optimizer.py tests/test_integration_dspy.py tests/test_resolver.py -v`
All pass. No Context references remain in any test file.
</verification>

<success_criteria>
- tests/test_auto_routing.py: All Context annotations replaced with plain fields
- tests/test_optimized_lm.py: All Context annotations replaced with plain fields
- tests/test_optimizer.py: All Context annotations replaced with plain fields
- tests/test_integration_dspy.py: All Context annotations replaced with plain fields
- tests/test_resolver.py: test_dep_backward_compat deleted
- All remaining tests in these files pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup-migration/08-03-SUMMARY.md`
</output>
