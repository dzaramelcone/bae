---
phase: 08-cleanup-migration
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - bae/compiler.py
  - tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "Full test suite passes with zero failures"
    - "No Context, Bind, or Dep(description=...) references remain anywhere in bae/ or tests/"
    - "CompiledGraph.run() does not pass **deps to graph.run()"
    - "examples/ootd.py runs end-to-end with a real LLM and produces structured output"
  artifacts:
    - path: "bae/compiler.py"
      provides: "CompiledGraph.run() with fixed signature"
  key_links:
    - from: "bae/compiler.py CompiledGraph.run()"
      to: "bae/graph.py Graph.run()"
      via: "self.graph.run(start_node, lm=lm)"
      pattern: "self\\.graph\\.run\\(start_node, lm=lm\\)"
---

<objective>
Fix the CompiledGraph.run() latent bug, run the full test suite as phase gate, and validate ootd.py end-to-end with a real LLM.

Purpose: This is the phase gate. Everything from Plans 01-03 converges here. The full test suite must pass, zero v1 references must remain, and ootd.py must produce a real outfit recommendation.

Output: Clean codebase, passing suite, validated example.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/08-cleanup-migration/08-01-SUMMARY.md
@.planning/phases/08-cleanup-migration/08-02-SUMMARY.md
@.planning/phases/08-cleanup-migration/08-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CompiledGraph.run() and run full test suite</name>
  <files>bae/compiler.py</files>
  <action>
  **Fix CompiledGraph.run():**
  In bae/compiler.py, the `CompiledGraph.run()` method (line ~34) currently:
  ```python
  def run(self, start_node: Node, **deps) -> "GraphResult":
      ...
      return self.graph.run(start_node, lm=lm, **deps)
  ```

  Graph.run() signature is `run(self, start_node, lm=None, max_iters=10)` -- it does NOT accept **kwargs. The **deps parameter on CompiledGraph.run() is a latent bug (works because no callers pass deps).

  Fix: Remove **deps from the method signature and the graph.run() call:
  ```python
  def run(self, start_node: Node) -> "GraphResult":
      ...
      return self.graph.run(start_node, lm=lm)
  ```

  Update the docstring to remove the `**deps: External dependencies to inject.` line. Deps are resolved automatically by the v2 runtime via resolve_fields().

  **Run full test suite:**
  `cd /Users/dzaramelcone/lab/bae && uv run pytest -v`

  All tests must pass. The expected count should be approximately 305 minus deleted tests:
  - test_bind_validation.py: -7 tests (deleted file)
  - test_compiler.py: -6 tests (TestContextMarker -3, TestDepMarker -3)
  - test_signature_v2.py: -1 test (TestExistingTestsStillPass)
  - test_resolver.py: -1 test (test_dep_backward_compat)
  Total expected: ~290 tests

  **Verify no v1 references remain:**
  Grep across all .py files in bae/ and tests/ for:
  - `Context` (as class reference, not in comments about "context")
  - `Bind` (as class reference)
  - `Dep(description=` (v1 pattern)
  - `_extract_context_fields` (deleted function)
  - `_validate_bind_uniqueness` (deleted method)
  </action>
  <verify>
  `cd /Users/dzaramelcone/lab/bae && uv run pytest -v` -- all tests pass, zero failures.
  `cd /Users/dzaramelcone/lab/bae && uv run python -c "from bae.compiler import CompiledGraph; import inspect; sig = inspect.signature(CompiledGraph.run); print(sig)"` -- should show `(self, start_node: bae.node.Node)` with no **deps.
  Grep verification that no v1 references remain in source or test files.
  </verify>
  <done>CompiledGraph.run() fixed. Full test suite passes. Zero v1 marker references remain in codebase.</done>
</task>

<task type="auto">
  <name>Task 2: Validate ootd.py end-to-end with real LLM</name>
  <files>tests/conftest.py</files>
  <action>
  The ootd.py example must run end-to-end with a real LLM call. Per the phase context decision: "runs end-to-end means a real LLM call."

  **Step 1: Verify ootd.py imports work:**
  `cd /Users/dzaramelcone/lab/bae && uv run python -c "from examples.ootd import graph, IsTheUserGettingDressed; print('Import OK:', graph.nodes)"`
  This confirms the example's node definitions and graph construction work against the v2 runtime.

  **Step 2: Run ootd.py with a real LLM:**
  `cd /Users/dzaramelcone/lab/bae && uv run python examples/ootd.py`
  This runs `graph.run(IsTheUserGettingDressed(user_message="ugh i just got up"))` which will:
  1. Resolve Dep fields (get_location, get_weather, get_schedule from fixtures)
  2. Use DSPyBackend (default LM) to fill plain fields via LLM
  3. Traverse IsTheUserGettingDressed -> AnticipateUsersDay -> RecommendOOTD -> None
  4. Print the final RecommendOOTD node as JSON

  The output must contain the RecommendOOTD fields: top, bottom, footwear, accessories, final_response, inspo.

  NOTE: This requires a DSPy-compatible LLM to be configured (OPENAI_API_KEY or similar env var). If no LLM is available, the test will fail with an API error. In that case, create a simple test that validates the graph structure and dep resolution work correctly without an LLM call, and document that the full E2E requires an API key.

  **Step 3: If real LLM is available and ootd.py runs successfully:**
  Capture the output and verify it has the expected structure (JSON with top, bottom, footwear, accessories, final_response fields).

  **Step 4: Add E2E pytest marker (optional, Claude's discretion):**
  If it makes sense, add a `conftest.py` entry:
  ```python
  def pytest_addoption(parser):
      parser.addoption("--run-e2e", action="store_true", default=False, help="run e2e tests")

  def pytest_configure(config):
      config.addinivalue_line("markers", "e2e: mark test as end-to-end (requires --run-e2e)")

  def pytest_collection_modifyitems(config, items):
      if not config.getoption("--run-e2e"):
          skip_e2e = pytest.mark.skip(reason="need --run-e2e option to run")
          for item in items:
              if "e2e" in item.keywords:
                  item.add_marker(skip_e2e)
  ```

  Only add this if conftest.py doesn't already exist or doesn't already have this. Check first. The E2E test itself is just the ootd.py run -- it validates the example works. Don't add a new test file for this if running ootd.py directly is sufficient proof.
  </action>
  <verify>
  `cd /Users/dzaramelcone/lab/bae && uv run python -c "from examples.ootd import graph, IsTheUserGettingDressed; print('Graph nodes:', [n.__name__ for n in graph.nodes]); print('Import OK')"` -- succeeds.
  If real LLM available: `uv run python examples/ootd.py` produces JSON with outfit fields.
  If no LLM: Document that import + graph construction verified, E2E requires API key.
  </verify>
  <done>ootd.py validated against v2 runtime. Either full E2E with real LLM output, or structural validation with documentation that API key is required for full E2E.</done>
</task>

</tasks>

<verification>
Phase 8 gate checks:
1. `cd /Users/dzaramelcone/lab/bae && uv run pytest -v` -- full suite passes
2. `uv run python -c "from bae import Context"` -- AttributeError
3. `uv run python -c "from bae import Bind"` -- AttributeError
4. `grep -r "class Context" bae/` -- no matches
5. `grep -r "class Bind" bae/` -- no matches
6. `grep -r "Dep(description=" bae/ tests/` -- no matches
7. `uv run python -c "from examples.ootd import graph; print(len(graph.nodes), 'nodes')"` -- prints "3 nodes"
</verification>

<success_criteria>
- CompiledGraph.run() signature fixed (no **deps)
- Full test suite passes (~290 tests, zero failures)
- Zero v1 marker references in bae/ or tests/
- ootd.py imports and graph construction work against v2 runtime
- ootd.py E2E validated (with real LLM or structural validation)
</success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup-migration/08-04-SUMMARY.md`
</output>
