---
phase: 32.2-userview-tool-call-stripping
plan: 04
subsystem: repl
tags: [pydantic, validation, tool-summary, run-block, regex]

# Dependency graph
requires:
  - phase: 32.2-03
    provides: "_validate_tool_params and _build_validator for pydantic parameter validation"
  - phase: 32.2-02
    provides: "_tool_summary diamond-bullet formatting and _is_error_output heuristic"
provides:
  - "Namespace callables wrapped with pydantic validation via _make_tool_wrapper"
  - "Run-block tool detection emitting tool_translated metadata instead of ai_exec"
  - "Resource context prefix [source] on run-block tool summaries"
affects: [33-ai-patterns, userview-rendering]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Wrapper-based validation: _make_tool_wrapper wraps raw bound methods before namespace injection"
    - "Run-block tool detection: _SIMPLE_TOOL_RE classifies <run> block content as tool call vs general code"

key-files:
  created: []
  modified:
    - "bae/repl/spaces/view.py"
    - "bae/repl/ai.py"
    - "tests/test_resource.py"
    - "tests/repl/test_ai.py"

key-decisions:
  - "Validation wrappers raise ResourceError (not return error string) so async_exec traceback handler catches cleanly"
  - "Tool detection uses regex on stripped code, not AST parsing -- simple and sufficient for single-call patterns"
  - "Existing identity-check tests updated to reflect wrapping (ns['read'] is not raw method)"

patterns-established:
  - "_make_tool_wrapper pattern: wrap tool callables at injection point with validation layer"
  - "_SIMPLE_TOOL_RE pattern: classify run-block code as tool vs general for differential rendering"

# Metrics
duration: 3min
completed: 2026-02-16
---

# Phase 32.2 Plan 04: Gap Closure Summary

**Wired tool summaries and pydantic validation onto the <run> block code path where the AI actually calls tools**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-16T21:51:08Z
- **Completed:** 2026-02-16T21:54:00Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Namespace callables now go through pydantic validation before execution -- `read(12345)` raises ResourceError with signature hint instead of raw TypeError
- Simple tool calls in `<run>` blocks render as diamond-bullet summaries with resource context prefix, not full execution panels
- Non-tool `<run>` blocks still render as framed execution panels (no regression)

## Task Commits

Each task was committed atomically:

1. **Task 1: Wrap namespace callables with validation in _put_tools** - `30032c2` (feat)
2. **Task 2: Detect tool calls in run-block handler and emit tool_translated** - `5812c3a` (feat)

## Files Created/Modified
- `bae/repl/spaces/view.py` - Added `_make_tool_wrapper` method and updated `_put_tools` to wrap callables
- `bae/repl/ai.py` - Added `_SIMPLE_TOOL_RE`, `_TOOL_HUMAN_NAMES_REV`, and tool detection in run-block handler
- `tests/test_resource.py` - Added validation wrapper tests, updated identity-check tests
- `tests/repl/test_ai.py` - Added regex matching tests and run-block tool detection tests

## Decisions Made
- Validation wrappers raise ResourceError (not return error string) so async_exec traceback handler catches cleanly
- Tool detection uses simple regex on stripped code, not AST parsing -- sufficient for single-call tool patterns
- Existing identity-check tests updated to reflect wrapping behavior (wrapper is not raw method)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated existing identity-check tests**
- **Found during:** Task 1
- **Issue:** Three existing tests used `assert ns["read"] is mock_read` which fails now that _put_tools wraps callables
- **Fix:** Changed to check callable presence and non-identity with home tools
- **Files modified:** tests/test_resource.py
- **Verification:** All 68 test_resource.py tests pass
- **Committed in:** 30032c2 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Necessary test update for correctness. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 32.2 fully complete: all 3 UAT gaps closed
- Tool summaries, validation, and resource prefix all wired onto the actual code path
- 846 tests passing, 5 skipped

---
*Phase: 32.2-userview-tool-call-stripping*
*Completed: 2026-02-16*
