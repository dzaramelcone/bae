---
phase: 32.2-userview-tool-call-stripping
plan: 03
subsystem: ui
tags: [pydantic, validation, tool-dispatch, create_model, inspect]

# Dependency graph
requires:
  - phase: 32.2-01
    provides: ToolRouter dispatch with ResourceError handling
provides:
  - Pydantic parameter validation on ToolRouter.dispatch before method execution
  - Formatted validation errors with method signature hint and docstring
  - _build_validator caching pydantic models from method signatures
affects: [tool-dispatch, ai-error-handling]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "create_model from inspect.signature for runtime parameter validation"
    - "_validator_cache keyed by method id() for per-method model caching"

key-files:
  created: []
  modified:
    - bae/repl/tools.py
    - tests/test_tools_router.py

key-decisions:
  - "Validator cache keyed by id(method) avoids repeated introspection per dispatch call"
  - "Unannotated parameters default to str type in pydantic model"

patterns-established:
  - "_build_validator + _validate_tool_params + _format_validation_error as validation pipeline"
  - "Validation returns dict on success, str on error -- isinstance check selects path"

# Metrics
duration: 2min
completed: 2026-02-16
---

# Phase 32.2 Plan 03: Pydantic Parameter Validation Summary

**Pydantic create_model validates tool dispatch params from inspect.signature, returning formatted errors with signature hint and docstring**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-16T21:06:23Z
- **Completed:** 2026-02-16T21:08:14Z
- **Tasks:** 1
- **Files modified:** 2

## Accomplishments
- `_build_validator` creates pydantic model from method signature via `create_model`, cached per method
- `_validate_tool_params` validates kwargs before calling resource methods, returns dict or error string
- `_format_validation_error` builds helpful message with tool signature, param types, and docstring
- `ToolRouter.dispatch` validates params via pydantic before execution; bad params return clear error
- 10 new tests covering validator construction, param validation, error formatting, and passthrough

## Task Commits

Each task was committed atomically:

1. **Task 1: Add pydantic validation to ToolRouter.dispatch** - `320f770` (feat)

## Files Created/Modified
- `bae/repl/tools.py` - Added _build_validator, _validate_tool_params, _format_validation_error; updated dispatch to validate before calling
- `tests/test_tools_router.py` - Added TestBuildValidator and TestParameterValidation test classes; fixed StubSpace missing tools() method

## Decisions Made
- Validator cache keyed by `id(method)` avoids repeated introspection on every dispatch call
- Unannotated parameters default to `str` type in the pydantic model (safe default for tool args which are always string-originated)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed StubSpace missing tools() method**
- **Found during:** Task 1 verification
- **Issue:** `StubSpace` test fixture missing `tools()` method required by `Resourcespace` protocol; caused `AttributeError` on `reg.navigate()` in tests
- **Fix:** Added `tools()` method to `StubSpace` that builds dict from `supported_tools()` set
- **Files modified:** tests/test_tools_router.py
- **Verification:** All 29 tests pass
- **Committed in:** 320f770 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** StubSpace fix necessary for tests to run. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Pydantic validation layer complete; all 3 plans in phase 32.2 are done
- 830 tests pass across entire suite

---
*Phase: 32.2-userview-tool-call-stripping*
*Completed: 2026-02-16*
