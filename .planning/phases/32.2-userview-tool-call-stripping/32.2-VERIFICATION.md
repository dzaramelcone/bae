---
phase: 32.2-userview-tool-call-stripping
verified: 2026-02-16T22:05:00Z
status: passed
score: 3/3 must-haves verified
re_verification:
  previous_status: passed
  previous_score: 12/12
  gaps_closed: []
  gaps_remaining: []
  regressions: []
---

# Phase 32.2: UserView Tool Call Stripping Verification Report

**Phase Goal:** Strip tool call content from UserView and AI context history; prune everything but tool I/O and agent's last message; resource entry shows AI-native tool tags with docstring summaries

**Verified:** 2026-02-16T22:05:00Z
**Status:** passed
**Re-verification:** Yes — after gap closure from Plan 04

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Tool calls in <run> blocks display as diamond-bullet one-liners, not full execution panels | ✓ VERIFIED | ai.py:192-210 detects tool calls via `_SIMPLE_TOOL_RE` and emits `tool_translated` metadata with summary |
| 2 | Resource context prefix [source] shown on tool summaries when inside a resource | ✓ VERIFIED | ai.py:127-129 resolves `resource_name` from registry; passed to `_tool_summary` at lines 139, 199; prefix logic at line 420 |
| 3 | Bad tool params return pydantic validation error with signature hint, not raw TypeError | ✓ VERIFIED | view.py:206-229 `_make_tool_wrapper` calls `_validate_tool_params`; raises ResourceError with formatted message at lines 221-223 |

**Score:** 3/3 truths verified (Plan 04 gap closure)

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `bae/repl/spaces/view.py` | `_make_tool_wrapper` wrapping raw bound methods with validation | ✓ VERIFIED | Lines 206-229: wraps callables with `_validate_tool_params`; line 240: injects wrappers into namespace |
| `bae/repl/ai.py` | Tool call detection in <run> block handler emitting tool_translated | ✓ VERIFIED | Line 340: `_SIMPLE_TOOL_RE` regex; lines 192-210: detection logic emitting `tool_translated` instead of `ai_exec` |
| `bae/repl/tools.py` | `_validate_tool_params` already exists (no changes needed) | ✓ VERIFIED | Lines 58-76: pydantic validation with error formatting; unchanged from Plan 03 |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| bae/repl/spaces/view.py | bae/repl/tools.py | `_make_tool_wrapper` calls `_validate_tool_params` | ✓ WIRED | Import at line 208; call at line 221 with tool_name, method, and args |
| bae/repl/ai.py | bae/repl/ai.py::_tool_summary | <run> block handler calls `_tool_summary` for recognized tool calls | ✓ WIRED | Line 199: `_tool_summary(tag, output, is_error=is_error, resource=resource_name)` inside tool detection branch |

### Requirements Coverage

No explicit requirements mapped to this phase in REQUIREMENTS.md.

### Anti-Patterns Found

None detected. All modified files clean of TODO/FIXME/PLACEHOLDER comments, empty implementations, and stub patterns.

### Human Verification Required

#### 1. Run-Block Tool Call Display

**Test:** In a REPL session inside a resource (e.g., `source()`), let the AI execute a tool call via `<run>read("bae")</run>`

**Expected:** Tool call displays as single one-liner with resource prefix: `[source] ◆ read(bae) -> str (N lines)` (not a framed execution panel)

**Why human:** Real-time REPL rendering and visual formatting verification

#### 2. Run-Block Validation Error

**Test:** In a REPL session, let the AI execute a malformed tool call like `<run>read(325035)</run>` (int instead of str)

**Expected:** Error message shows:
```
Tool 'read' parameter error: [validation message]
Usage: read(target: str)
  [docstring first line]
```

**Why human:** Error display formatting in live AI interaction context

#### 3. Non-Tool Run-Block Unchanged

**Test:** Let the AI execute a non-tool run-block like `<run>x = 1 + 2</run>`

**Expected:** Still renders as framed execution panel with code and result, not as a summary line

**Why human:** Verify no regression on non-tool code execution display

#### 4. Resource Prefix Conditional

**Test:** Execute a tool call when NOT in a resource (at home level)

**Expected:** No `[source]` prefix — just `◆ read(bae) -> str (N lines)`

**Why human:** Conditional rendering based on context

### Gaps Summary

No gaps found. All must-haves verified with substantive implementations and correct wiring. This verification confirms Plan 04 gap closure.

## Implementation Quality

### Commits Verified
- 30032c2: feat(32.2-04): wrap namespace callables with pydantic validation
- 5812c3a: feat(32.2-04): detect tool calls in run-blocks and emit tool_translated

Both commits exist and are properly attributed.

### Test Coverage
- test_resource.py: 68 tests pass
- test_ai.py: 100 tests pass
- Total: 168 tests covering all aspects of Plan 04
- Specific tests:
  - `TestSimpleToolRegex`: 10 tests for regex matching
  - `test_wrapper_validates_bad_params`: validation error path
  - `test_wrapper_passes_valid_params`: validation success path
  - `test_tool_call_in_run_block_emits_tool_translated`: tool detection
  - `test_non_tool_run_block_emits_ai_exec`: no regression

### Code Quality
- No TODO/FIXME/PLACEHOLDER markers
- No empty implementations or stub patterns
- Wrapper raises ResourceError (not returns error string) for clean exception handling
- Regex detection is simple and sufficient for single-call patterns
- Resource prefix conditional on `resource_name` presence (line 420)

### Architectural Soundness
- Validation layer injected at namespace boundary (view.py:_put_tools)
- Tool detection uses existing `_tool_summary` and `_is_error_output` utilities
- Run-block handler cleanly branches between tool calls and general code
- No changes to existing tool routing (only additions to run-block path)

### Gap Closure Effectiveness

Plan 04 successfully closed all 3 UAT gaps:

1. **Tool summaries on run-block path:** `_SIMPLE_TOOL_RE` detects tool calls; emits `tool_translated` instead of `ai_exec`
2. **Resource prefix on run-block path:** `resource_name` resolved at line 127-129; passed to `_tool_summary` at line 199
3. **Validation on run-block path:** `_make_tool_wrapper` injects validation at namespace boundary; all tool calls go through wrapper

All features from Plans 01-03 now work on the actual code path the AI uses (<run> blocks), not just the XML tag path.

---

_Verified: 2026-02-16T22:05:00Z_
_Verifier: Claude (gsd-verifier)_
