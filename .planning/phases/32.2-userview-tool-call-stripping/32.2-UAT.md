---
status: diagnosed
phase: 32.2-userview-tool-call-stripping
source: [32.2-01-SUMMARY.md, 32.2-02-SUMMARY.md, 32.2-03-SUMMARY.md]
started: 2026-02-16T21:15:00Z
updated: 2026-02-16T21:30:00Z
---

## Current Test

[testing complete]

## Tests

### 1. Tool calls show diamond-bullet format
expected: After navigating into a resource (e.g., `source()`), use a tool like `read("bae")`. The tool call display should show a one-liner like `◆ read(bae) -> str (N lines)` — not the full output dump. Clean single line with diamond bullet.
result: issue
reported: "No diamond-bullet format visible. glob() result shows as raw output in ai:1 panel box. read('bae') shows [py] prefix still. No ◆ anywhere."
severity: major

### 2. Resource context prefix on tool summaries
expected: While inside a resource (e.g., source), tool summaries show `[source] ◆ read(bae) -> str`. At home (no resource), the prefix is absent — just `◆ ...`.
result: issue
reported: "Same root cause as test 1 — AI calls namespace callables directly as Python execution, not through run_tool_calls/tool_translated path. Execution blocks render instead of summaries."
severity: major

### 3. Error tool calls render in red
expected: Trigger an error tool call (e.g., `read("nonexistent.module")` in source). The tool summary line should render in red with the exception type as return type, like `[source] ◆ read(nonexistent.module) -> ResourceError`.
result: skipped
reason: Blocked by test 1/2 — same rendering path issue

### 4. Intermediate AI prose suppressed
expected: When the AI processes multiple tool calls in sequence, only the final AI response after all tools resolve should display. No intermediate "Let me check that file" or "I'll look at..." prose between tool calls.
result: skipped
reason: Blocked by test 1/2 — AI uses direct callables not XML tool calls, so intermediate response suppression path doesn't fire

### 5. Functions table shows typed XML signatures on resource entry
expected: Navigate into a resource with `source()`. The entry display functions table should show `| Tool | Signature | Description |` headers with rows like `| read | <Read:target:str> | ... |`. Write tool shows body-content format with closing tag.
result: pass

### 6. Pydantic validation on bad tool params
expected: Call a tool with wrong parameter type or missing required param. Should return a clear error message showing the expected signature and docstring — not a raw Python TypeError.
result: issue
reported: "read(325035) gives raw TypeError from _validate_module_path. Pydantic validation is on ToolRouter.dispatch() but namespace callables bypass the router entirely — direct Python call."
severity: major

## Summary

total: 6
passed: 1
issues: 3
pending: 0
skipped: 2

## Gaps

- truth: "Tool calls display as diamond-bullet one-liners like ◆ read(bae) -> str (N lines)"
  status: failed
  reason: "User reported: No diamond-bullet format visible. glob() result shows as raw output in ai:1 panel box. read('bae') shows [py] prefix still. No ◆ anywhere."
  severity: major
  test: 1
  root_cause: "AI uses <run>read('bae')</run> execution blocks, not <Read:bae> XML tags. Eval loop path B (ai_exec/ai_exec_result Rich Panels) fires instead of path A (tool_translated diamond-bullet). _tool_summary code exists but on unreachable path."
  artifacts:
    - path: "bae/repl/ai.py"
      issue: "Eval loop <run> block handler emits ai_exec metadata, not tool_translated with _tool_summary"
    - path: "bae/repl/views.py"
      issue: "ai_exec renders as Rich Panel; tool_translated renders as ANSI one-liner — two branches never cross"
  missing:
    - "Detect simple tool calls in <run> block handler and emit tool_translated metadata with _tool_summary format instead of ai_exec/ai_exec_result"
  debug_session: ".planning/debug/tool-summary-wrong-path.md"
- truth: "Resource context prefix [source] shown on tool summaries inside a resource"
  status: failed
  reason: "User reported: Same root cause — execution blocks render instead of summaries because AI uses direct callables not XML tool calls."
  severity: major
  test: 2
  root_cause: "Same as test 1 — resource prefix is computed in _tool_summary which only fires on tool_translated path"
  artifacts:
    - path: "bae/repl/ai.py"
      issue: "resource_name lookup only in run_tool_calls branch, not in <run> block handler"
  missing:
    - "Include resource context in tool summary when emitting from <run> block path"
  debug_session: ".planning/debug/tool-summary-wrong-path.md"
- truth: "Bad tool params return pydantic validation error with signature hint, not raw TypeError"
  status: failed
  reason: "User reported: read(325035) gives raw TypeError. Pydantic validation on ToolRouter.dispatch() but namespace callables bypass the router — direct Python call."
  severity: major
  test: 6
  root_cause: "_put_tools() in spaces/view.py injects raw bound methods into namespace with no wrapping. _validate_tool_params() only fires through ToolRouter.dispatch() which only fires through run_tool_calls() — unreachable path."
  artifacts:
    - path: "bae/repl/spaces/view.py"
      issue: "_put_tools() injects raw bound methods — no validation wrapper"
    - path: "bae/repl/tools.py"
      issue: "_validate_tool_params() correct code, unreachable path"
  missing:
    - "Wrap namespace callables in _put_tools() to route through _validate_tool_params() before calling bound method"
  debug_session: ".planning/debug/tool-summary-wrong-path.md"
