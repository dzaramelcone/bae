---
phase: 32.2-userview-tool-call-stripping
plan: 01
subsystem: ui
tags: [ansi, tool-display, userview, ai-backend]

# Dependency graph
requires:
  - phase: 32.1.1-subresource-packages-shim-removal
    provides: resource registry with current.name for resource context prefix
provides:
  - "Diamond-bullet tool summary format: [resource] ◆ name(args) -> type (hint)"
  - "is_error flag on run_tool_calls 3-tuple return"
  - "Intermediate AI response suppression in eval loop"
  - "Color-coded tool rendering in UserView (dim success, red error)"
affects: [32.2-02, 32.2-03]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Error detection via _is_error_output regex heuristic on PascalCaseError: prefix"
    - "Resource context prefix from registry.current.name in tool summaries"
    - "Single final response write after eval loop (no intermediate prose display)"

key-files:
  created: []
  modified:
    - bae/repl/ai.py
    - bae/repl/views.py
    - tests/repl/test_ai.py
    - tests/repl/test_views.py

key-decisions:
  - "Error detection uses dual approach: structured is_error flag from run_tool_calls + _is_error_output heuristic fallback"
  - "Intermediate response suppression via removing all mid-loop router.write('ai') calls, single write after loop"
  - "Resource context prefix included per DSC-03 (satisfies early)"

patterns-established:
  - "Tool summaries formatted in AI backend, rendered by view layer"
  - "3-tuple (tag, output, is_error) as standard run_tool_calls return format"

# Metrics
duration: 5min
completed: 2026-02-16
---

# Phase 32.2 Plan 01: Tool Summary + Response Filtering Summary

**Diamond-bullet tool summaries with resource context prefix, error flag propagation, and intermediate AI response suppression**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-16T20:59:01Z
- **Completed:** 2026-02-16T21:04:07Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- `_tool_summary` produces `[resource] ◆ name(args) -> type (hint)` format with resource context prefix
- `run_tool_calls` returns `list[tuple[str, str, bool]]` with structured `is_error` flag
- AI eval loop writes only one response per `__call__` invocation (the final one after all tools resolve)
- UserView renders tool calls as color-coded one-liners: dim italic for success, red for errors
- No `[py]` channel prefix on tool lines -- diamond bullet is the visual indicator

## Task Commits

Each task was committed atomically:

1. **Task 1: Reformat tool summaries and suppress intermediate responses** - `55c7c82` (feat)
2. **Task 2: Update UserView tool rendering with color** - `0313f77` (feat)

## Files Created/Modified
- `bae/repl/ai.py` - New `_tool_summary` format, `_is_error_output`/`_error_type_name` helpers, 3-tuple returns, single final response write
- `bae/repl/views.py` - Color-coded tool_translated rendering without `[py]` prefix
- `tests/repl/test_ai.py` - TestToolSummary, TestErrorHelpers classes; updated 3-tuple assertions; intermediate response suppression test
- `tests/repl/test_views.py` - Updated tool summary assertions to diamond-bullet format; error rendering test; response flow test

## Decisions Made
- Error detection uses dual approach: structured `is_error` flag from `run_tool_calls` exception handler + `_is_error_output` regex heuristic as fallback for string-formatted errors
- Intermediate response suppression implemented by removing all mid-loop `router.write("ai", ...)` calls rather than a `final` flag approach -- simpler, no filtering needed in views
- Resource context prefix (DSC-03) included now since `self._registry.current.name` is readily available

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

Pre-existing test failure in `tests/test_tools_router.py::TestDispatchRouting::test_resource_read_calls_resource_method` -- `StubSpace` missing `tools()` method. Not caused by this plan's changes (verified by running test on pre-change commit). Out of scope.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Tool summary format and error propagation ready for Plan 02 (entry display typed signatures) and Plan 03 (pydantic validation)
- DebugView and AISelfView confirmed unaffected

---
*Phase: 32.2-userview-tool-call-stripping*
*Completed: 2026-02-16*
