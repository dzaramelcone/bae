---
phase: 32.1.1-subresource-packages-shim-removal
plan: 02
type: execute
wave: 2
depends_on: ["32.1.1-01"]
files_modified:
  - bae/repl/spaces/source/deps/__init__.py
  - bae/repl/spaces/source/deps/view.py
  - bae/repl/spaces/source/deps/service.py
  - bae/repl/spaces/source/config/__init__.py
  - bae/repl/spaces/source/config/view.py
  - bae/repl/spaces/source/config/service.py
  - bae/repl/spaces/source/tests/__init__.py
  - bae/repl/spaces/source/tests/view.py
  - bae/repl/spaces/source/tests/service.py
  - bae/repl/spaces/source/meta/__init__.py
  - bae/repl/spaces/source/meta/view.py
  - bae/repl/spaces/source/meta/service.py
  - bae/repl/spaces/source/service.py
  - bae/repl/spaces/source/__init__.py
autonomous: true

must_haves:
  truths:
    - "Each subresource (deps, config, tests, meta) is its own package under spaces/source/"
    - "Subresource classes in view.py delegate to module-level functions in service.py"
    - "source/service.py contains only SourceResourcespace — no subresource class definitions"
    - "SourceResourcespace imports subresource view classes from their packages"
    - "All tests pass unchanged — behavior is identical"
  artifacts:
    - path: "bae/repl/spaces/source/deps/view.py"
      provides: "DepsSubresource class (protocol wrapper)"
      contains: "class DepsSubresource"
    - path: "bae/repl/spaces/source/deps/service.py"
      provides: "Deps implementation functions"
      contains: "def read"
    - path: "bae/repl/spaces/source/config/view.py"
      provides: "ConfigSubresource class"
      contains: "class ConfigSubresource"
    - path: "bae/repl/spaces/source/tests/view.py"
      provides: "TestsSubresource class"
      contains: "class TestsSubresource"
    - path: "bae/repl/spaces/source/meta/view.py"
      provides: "MetaSubresource class"
      contains: "class MetaSubresource"
  key_links:
    - from: "bae/repl/spaces/source/service.py"
      to: "bae/repl/spaces/source/deps"
      via: "import DepsSubresource from package"
      pattern: "from bae\\.repl\\.spaces\\.source\\.deps import DepsSubresource"
    - from: "bae/repl/spaces/source/deps/view.py"
      to: "bae/repl/spaces/source/deps/service.py"
      via: "delegation"
      pattern: "from bae\\.repl\\.spaces\\.source\\.deps import service"
---

<objective>
Extract four subresource classes (DepsSubresource, ConfigSubresource, TestsSubresource, MetaSubresource) from source/service.py into their own packages with view.py + service.py split.

Purpose: Each subresource becomes an isolated package following the view/service convention — view.py wraps protocol, service.py has implementation.
Output: Four new packages under source/, source/service.py slimmed to SourceResourcespace only.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32.1.1-subresource-packages-shim-removal/32.1.1-RESEARCH.md
@.planning/phases/32.1.1-subresource-packages-shim-removal/32.1.1-01-SUMMARY.md

@bae/repl/spaces/source/service.py
@bae/repl/spaces/source/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract deps and config subresources into packages</name>
  <files>
    bae/repl/spaces/source/deps/__init__.py
    bae/repl/spaces/source/deps/view.py
    bae/repl/spaces/source/deps/service.py
    bae/repl/spaces/source/config/__init__.py
    bae/repl/spaces/source/config/view.py
    bae/repl/spaces/source/config/service.py
  </files>
  <action>
    For each of deps and config, create a package with three files:

    **deps/service.py** — Extract implementation functions from DepsSubresource class (lines 36-87 of current service.py):
    - `read_pyproject(project_root: Path) -> dict` (from `_read_pyproject`)
    - `read(project_root: Path, target: str = "") -> str` (from `DepsSubresource.read`)
    - `write(project_root: Path, target: str, content: str = "") -> str` (from `DepsSubresource.write`)
    - `enter(project_root: Path) -> str` (from `DepsSubresource.enter`)
    - `nav(project_root: Path) -> str` (from `DepsSubresource.nav`)
    - Import ResourceError from `bae.repl.spaces.view`, tomllib, subprocess, Path

    **deps/view.py** — DepsSubresource class that delegates to service functions:
    - `class DepsSubresource` with same protocol interface (name, description, __init__, enter, nav, read, write, supported_tools, tools, children)
    - Constructor takes `project_root: Path`, stores as `self._root`
    - Each method delegates: `return service.read(self._root, target)` etc.
    - Import service as module: `from bae.repl.spaces.source.deps import service`
    - Import Resourcespace from `bae.repl.spaces.view` for children() return type

    **deps/__init__.py** — Selective re-export:
    ```python
    from bae.repl.spaces.source.deps.view import DepsSubresource
    __all__ = ["DepsSubresource"]
    ```

    **config/service.py** — Same pattern for ConfigSubresource (lines 90-140):
    - `read_pyproject(project_root: Path) -> dict`
    - `read(project_root: Path, target: str = "") -> str`
    - `enter(project_root: Path) -> str`
    - `nav(project_root: Path) -> str`
    - Import json, tomllib, ResourceError, CHAR_CAP

    **config/view.py** — ConfigSubresource class delegating to service.
    **config/__init__.py** — Re-export ConfigSubresource with `__all__`.
  </action>
  <verify>uv run pytest tests/test_source.py -x -q</verify>
  <done>deps/ and config/ packages created with view/service split, DepsSubresource and ConfigSubresource importable from their packages.</done>
</task>

<task type="auto">
  <name>Task 2: Extract tests and meta subresources, slim down source/service.py</name>
  <files>
    bae/repl/spaces/source/tests/__init__.py
    bae/repl/spaces/source/tests/view.py
    bae/repl/spaces/source/tests/service.py
    bae/repl/spaces/source/meta/__init__.py
    bae/repl/spaces/source/meta/view.py
    bae/repl/spaces/source/meta/service.py
    bae/repl/spaces/source/service.py
    bae/repl/spaces/source/__init__.py
  </files>
  <action>
    1. Create tests/ and meta/ packages following the same view/service pattern:

    **tests/service.py** — Extract from TestsSubresource (lines 143-251):
    - `discover_test_modules(project_root: Path) -> list[str]`
    - `read(project_root: Path, target: str = "") -> str`
    - `grep(project_root: Path, pattern: str, path: str = "") -> str`
    - `enter(project_root: Path) -> str`
    - `nav(project_root: Path) -> str`
    - Import ast, re, ResourceError, CHAR_CAP

    **tests/view.py** — TestsSubresource class delegating to service.

    **meta/service.py** — Extract from MetaSubresource (lines 254-308):
    - `enter() -> str` (static orientation string — per discretion, expand scope to cover all of spaces/source/ package, not just service.py; update _module_path to "bae.repl.spaces.source")
    - `nav(project_root: Path, module_path: str) -> str`
    - `read(project_root: Path, module_path: str, target: str = "") -> str`
    - `edit(project_root: Path, module_path: str, target: str, new_source: str = "") -> str`
    - Import ast, ResourceError, and model helpers (_module_to_path, _module_summary, _read_symbol, _replace_symbol, _hot_reload)

    **meta/view.py** — MetaSubresource class with `_module_path = "bae.repl.spaces.source"` (expanded scope per discretion). Delegates to service functions passing `self._root` and `self._module_path`.

    2. Update `bae/repl/spaces/source/service.py`:
    - Remove all four subresource class definitions (DepsSubresource, ConfigSubresource, TestsSubresource, MetaSubresource)
    - Add imports from subresource packages:
      ```python
      from bae.repl.spaces.source.deps import DepsSubresource
      from bae.repl.spaces.source.config import ConfigSubresource
      from bae.repl.spaces.source.tests import TestsSubresource
      from bae.repl.spaces.source.meta import MetaSubresource
      ```
    - SourceResourcespace._children dict stays the same — imports just come from different paths now
    - Remove imports no longer needed by service.py (tomllib, json, etc. — only keep what SourceResourcespace itself uses)

    3. Update `bae/repl/spaces/source/__init__.py`:
    - Import subresource classes from their packages instead of from service.py
    - Keep SourceResourcespace import from service.py
    - Remove models re-exports that are internal (keep only public API in __all__)
    - Define `__all__` listing only: SourceResourcespace, DepsSubresource, ConfigSubresource, TestsSubresource, MetaSubresource

    4. Update meta's orientation message and test assertion (pitfall 3 from research): meta now covers `bae.repl.spaces.source` (the package) instead of `bae.repl.spaces.source.service`. If test_source.py asserts the old module path in meta output, update the assertion.
  </action>
  <verify>uv run pytest tests/ -x -q --ignore=tests/test_integration.py</verify>
  <done>All four subresource classes extracted into own packages, source/service.py contains only SourceResourcespace (~297 lines → slimmer after removing subresource code and unused imports), source/__init__.py has selective __all__, all 787 tests pass.</done>
</task>

</tasks>

<verification>
- `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` — all tests pass
- `python -c "from bae.repl.spaces.source.deps import DepsSubresource; print(DepsSubresource.name)"` — prints "deps"
- `python -c "from bae.repl.spaces.source.config import ConfigSubresource"` — imports succeed
- `python -c "from bae.repl.spaces.source.tests import TestsSubresource"` — imports succeed
- `python -c "from bae.repl.spaces.source.meta import MetaSubresource"` — imports succeed
- `python -c "from bae.repl.spaces.source import SourceResourcespace"` — imports succeed
- `grep -c "class.*Subresource" bae/repl/spaces/source/service.py` — returns 0 (no subresource classes remain)
</verification>

<success_criteria>
Four subresource packages exist under source/ with view/service split. Each view.py delegates to its service.py. SourceResourcespace imports subresource classes from their packages. source/service.py is slimmed down. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/32.1.1-subresource-packages-shim-removal/32.1.1-02-SUMMARY.md`
</output>
