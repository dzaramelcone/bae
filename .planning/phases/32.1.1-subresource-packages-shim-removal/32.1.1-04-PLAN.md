---
phase: 32.1.1-subresource-packages-shim-removal
plan: 04
type: execute
wave: 3
depends_on: ["32.1.1-02"]
files_modified:
  - bae/repl/spaces/source/service.py
  - bae/repl/spaces/source/models.py
  - bae/repl/spaces/source/meta/service.py
  - bae/repl/spaces/source/meta/view.py
autonomous: true

must_haves:
  truths:
    - "read() on a package groups files by role (protocol / implementation / data) not alphabetically"
    - "write('my_sub') creates a new subresource package with view.py + service.py from a tstring template"
    - "New subresource packages are auto-registered into SourceResourcespace._children"
    - "Meta orientation message instructs AI about the view/service convention"
    - "All tests pass"
  artifacts:
    - path: "bae/repl/spaces/source/models.py"
      provides: "Role-grouped module summary for packages following view/service convention"
      contains: "def _role_label"
    - path: "bae/repl/spaces/source/service.py"
      provides: "Template-based write for new subresource creation"
      contains: "templatelib"
  key_links:
    - from: "bae/repl/spaces/source/service.py"
      to: "bae/repl/spaces/source/models.py"
      via: "_module_summary role grouping"
      pattern: "_module_summary"
    - from: "bae/repl/spaces/source/meta/service.py"
      to: "convention message"
      via: "enter() orientation"
      pattern: "view must implement protocol"
---

<objective>
Add structure-aware behavior to source resourcespace operations: role-grouped read() output for packages, tstring-templated write() for new subresource creation, and AI convention guidance in meta.

Purpose: Source operations understand and enforce the view/service/models convention, making the package structure self-documenting and extensible.
Output: Enhanced read(), write(), and meta enter() that reflect the package convention.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32.1.1-subresource-packages-shim-removal/32.1.1-RESEARCH.md
@.planning/phases/32.1.1-subresource-packages-shim-removal/32.1.1-02-SUMMARY.md

@bae/repl/spaces/source/service.py
@bae/repl/spaces/source/models.py
@bae/repl/spaces/source/meta/service.py
@bae/repl/spaces/source/meta/view.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Role-grouped read() and tstring-templated write()</name>
  <files>
    bae/repl/spaces/source/models.py
    bae/repl/spaces/source/service.py
  </files>
  <action>
    1. **models.py** — Add role detection for packages following view/service convention:
       - Add `_role_label(filename: str) -> str` that maps: `view.py` → "protocol", `service.py` → "implementation", `models.py` → "data", `schemas.py` → "data", `__init__.py` → "exports", anything else → ""
       - Modify `_module_summary()`: when filepath is `__init__.py` (package), check if `view.py` exists in the package dir. If it does (convention-following package), group the file listing by role using `_role_label()`. Show output like:
         ```
         bae.repl.spaces.source.deps -- Project dependencies (protocol: view, implementation: service)
         ```
       - If `view.py` does not exist (non-convention package), keep current behavior (N subpackages, M modules).

    2. **service.py** — Add tstring template to SourceResourcespace.write():
       - Import `from string.templatelib import Template`
       - When `write(target, content)` is called and `target` is a simple identifier (no dots — e.g. "alerts"), treat it as a new subresource creation:
         - Create package directory `source/{target}/`
         - Use tstring templates to generate `__init__.py`, `view.py`, `service.py` with scaffolded content:
           - `__init__.py`: re-exports `{Target}Subresource` from view.py with `__all__`
           - `view.py`: `{Target}Subresource` class with protocol methods delegating to service
           - `service.py`: docstring and placeholder functions
         - Auto-register by adding the new subresource to `self._children`
         - If `content` is provided, use it as the description (otherwise derive from target name)
         - Return confirmation message
       - When `target` contains dots, keep existing behavior (create a plain module).
       - The template content follows the convention guidance: "view must implement protocol and call service layer functions, service has underlying implementations"
  </action>
  <verify>uv run pytest tests/ -x -q --ignore=tests/test_integration.py</verify>
  <done>_module_summary groups by role for convention-following packages. write("name") creates scaffolded subresource package from tstring template. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Meta orientation message with convention guidance</name>
  <files>
    bae/repl/spaces/source/meta/service.py
    bae/repl/spaces/source/meta/view.py
  </files>
  <action>
    1. **meta/service.py** — Update the `enter()` function to include convention guidance in the orientation message:
       ```
       Source resourcespace implementation (bae.repl.spaces.source)

       Convention: view.py must implement the protocol and call service layer functions.
       service.py has the underlying implementations. models.py for entities, schemas.py for DTOs — add only when needed.

       read() for summary, read(symbol) for symbol source, edit(symbol, new_source) to modify
       ```

    2. **meta/view.py** — Verify `_module_path` is set to `"bae.repl.spaces.source"` (expanded scope, covering the full source package). This was done in plan 02, but verify the orientation message references it correctly.

    3. Update any test assertions in test_source.py that check meta's enter() output or module path string. The old message referenced "bae.repl.spaces.source.service" — update to "bae.repl.spaces.source" and add assertion for the convention guidance text.
  </action>
  <verify>uv run pytest tests/test_source.py -x -q -k meta</verify>
  <done>Meta enter() includes convention guidance message. Module path covers full source package. Tests updated and passing.</done>
</task>

</tasks>

<verification>
- `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` — all tests pass
- `python -c "from bae.repl.spaces.source import SourceResourcespace; from pathlib import Path; s = SourceResourcespace(Path('.')); print(s.read('bae.repl.spaces.source.deps'))"` — shows role-grouped summary
- Meta enter output contains "view.py must implement the protocol"
</verification>

<success_criteria>
read() on convention-following packages shows role-grouped output. write() for new subresources creates scaffolded packages from tstring templates. Meta orientation includes convention guidance. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/32.1.1-subresource-packages-shim-removal/32.1.1-04-SUMMARY.md`
</output>
