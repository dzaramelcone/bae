---
phase: 25-views-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/repl/views.py
  - tests/repl/test_views.py
autonomous: true

must_haves:
  truths:
    - "DebugView renders channel name + all metadata key=value pairs in a visible header"
    - "DebugView renders raw content lines indented below the header, no Rich panels"
    - "AISelfView labels each write with an AI-perspective tag (ai-output, exec-code, exec-result, tool-call, tool-output)"
    - "AISelfView renders content lines without transformation or buffering"
    - "ViewMode enum has USER, DEBUG, AI_SELF members"
    - "VIEW_FORMATTERS maps each ViewMode to its formatter class"
    - "VIEW_CYCLE lists all three modes in toggle order"
  artifacts:
    - path: "bae/repl/views.py"
      provides: "DebugView, AISelfView, ViewMode, VIEW_CYCLE, VIEW_FORMATTERS"
      contains: "class DebugView"
    - path: "tests/repl/test_views.py"
      provides: "Tests for DebugView, AISelfView, ViewMode"
      contains: "test_debug_view"
  key_links:
    - from: "bae/repl/views.py"
      to: "bae/repl/channels.py"
      via: "ViewFormatter protocol satisfaction"
      pattern: "isinstance.*ViewFormatter"
---

<objective>
Implement DebugView and AISelfView formatters plus ViewMode enum and routing infrastructure in views.py.

Purpose: VIEW-04 (DebugView), VIEW-06 (AISelfView), and the ViewMode/VIEW_FORMATTERS infrastructure that Plan 02 will consume for shell wiring and view toggling.

Output: Two new ViewFormatter implementations (DebugView, AISelfView), ViewMode enum, VIEW_CYCLE list, VIEW_FORMATTERS dict, and comprehensive tests.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-views-completion/25-RESEARCH.md
@bae/repl/views.py
@bae/repl/channels.py
@tests/repl/test_views.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ViewMode enum and routing infrastructure to views.py</name>
  <files>bae/repl/views.py</files>
  <action>
Add at the bottom of views.py (after the UserView class):

1. Import `Enum` from `enum` at the top of the file.

2. Add `ViewMode` enum with three members:
   - `USER = "user"`
   - `DEBUG = "debug"`
   - `AI_SELF = "ai-self"`

3. Add `VIEW_CYCLE` list: `[ViewMode.USER, ViewMode.DEBUG, ViewMode.AI_SELF]`

4. Add `VIEW_FORMATTERS` dict mapping each ViewMode to its formatter CLASS (not instance):
   ```python
   VIEW_FORMATTERS: dict[ViewMode, type] = {
       ViewMode.USER: UserView,
       ViewMode.DEBUG: DebugView,
       ViewMode.AI_SELF: AISelfView,
   }
   ```

Place the enum and constants AFTER the three formatter classes (UserView, DebugView, AISelfView) so forward references are not needed.
  </action>
  <verify>
`uv run python -c "from bae.repl.views import ViewMode, VIEW_CYCLE, VIEW_FORMATTERS; print(VIEW_CYCLE); print(VIEW_FORMATTERS)"` prints all three modes and their formatter classes.
  </verify>
  <done>ViewMode enum exists with USER/DEBUG/AI_SELF. VIEW_CYCLE and VIEW_FORMATTERS correctly map all modes.</done>
</task>

<task type="auto">
  <name>Task 2: Implement DebugView and AISelfView formatters</name>
  <files>bae/repl/views.py</files>
  <action>
Add two new classes to views.py between UserView and the ViewMode enum.

**DebugView** (VIEW-04): Raw content with full metadata for debugging.
- `render(self, channel_name, color, content, *, metadata=None)` method.
- Build a metadata string: `" ".join(f"{k}={v}" for k, v in sorted(meta.items()))` (sorted for deterministic output in tests).
- Print a header line: `[{channel_name}] {meta_str}` if meta_str, else `[{channel_name}]`. Use `FormattedText` with `(f"{color} bold", header)` style.
- Print each content line indented with 2 spaces: `("fg:#808080", "  ")` prefix, then `("", line)`.
- No Rich Panels, no Syntax highlighting, no markdown rendering. Raw data only.

**AISelfView** (VIEW-06): Shows channel data from the AI's perspective.
- `render(self, channel_name, color, content, *, metadata=None)` method.
- Define a `tag_map` dict mapping metadata types to AI-perspective labels:
  - `"response"` -> `"ai-output"`
  - `"ai_exec"` -> `"exec-code"`
  - `"ai_exec_result"` -> `"exec-result"`
  - `"tool_translated"` -> `"tool-call"`
  - `"tool_result"` -> `"tool-output"`
  - `"error"` -> `"error"`
- Derive tag: `tag_map.get(content_type, content_type or channel_name)`. If metadata has `label`, append `:{label}`.
- Print header: `FormattedText([("fg:#b0b040 bold", f"[{tag}]")])`.
- Print each content line indented with 2 spaces, same as DebugView: `("fg:#808080", "  ")` prefix, then `("", line)`.
- No buffering, no transformation, no Rich Panels.

Both classes must satisfy the `ViewFormatter` protocol (structural typing -- they have a `render` method with the right signature).
  </action>
  <verify>
`uv run python -c "from bae.repl.views import DebugView, AISelfView; from bae.repl.channels import ViewFormatter; assert isinstance(DebugView(), ViewFormatter); assert isinstance(AISelfView(), ViewFormatter); print('OK')"` prints OK.
  </verify>
  <done>DebugView shows metadata header + raw content. AISelfView shows AI-perspective tags + raw content. Both satisfy ViewFormatter protocol.</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for DebugView, AISelfView, and ViewMode</name>
  <files>tests/repl/test_views.py</files>
  <action>
Add tests to the existing test_views.py file. Import `DebugView`, `AISelfView`, `ViewMode`, `VIEW_CYCLE`, `VIEW_FORMATTERS` from `bae.repl.views`.

**DebugView tests** (all mock `bae.repl.views.print_formatted_text`):

1. `test_debug_view_shows_metadata` -- Render with `metadata={"type": "ai_exec", "label": "1"}`. Assert first print call's FormattedText contains `"label=1"` and `"type=ai_exec"` in the header text. Assert header includes `[py]`.

2. `test_debug_view_no_metadata` -- Render with `metadata=None`. Assert header is just `[py]` with no metadata keys.

3. `test_debug_view_content_lines_indented` -- Render `"line1\nline2"`. Assert print is called 3 times (1 header + 2 content lines). Assert content lines have the `("fg:#808080", "  ")` indent prefix.

4. `test_debug_view_satisfies_protocol` -- `assert isinstance(DebugView(), ViewFormatter)`.

**AISelfView tests** (all mock `bae.repl.views.print_formatted_text`):

5. `test_ai_self_view_response_tag` -- Render with `metadata={"type": "response"}`. Assert header contains `[ai-output]`.

6. `test_ai_self_view_exec_tags` -- Render with `metadata={"type": "ai_exec"}`. Assert header contains `[exec-code]`. Render with `metadata={"type": "ai_exec_result"}`. Assert header contains `[exec-result]`.

7. `test_ai_self_view_tool_tags` -- Render with `metadata={"type": "tool_translated"}`. Assert header contains `[tool-call]`. Render with `metadata={"type": "tool_result"}`. Assert header contains `[tool-output]`.

8. `test_ai_self_view_label_appended` -- Render with `metadata={"type": "response", "label": "3"}`. Assert header contains `[ai-output:3]`.

9. `test_ai_self_view_unknown_type_uses_channel` -- Render with `metadata={}` and `channel_name="bash"`. Assert header contains `[bash]`.

10. `test_ai_self_view_satisfies_protocol` -- `assert isinstance(AISelfView(), ViewFormatter)`.

**ViewMode/infrastructure tests:**

11. `test_view_mode_values` -- Assert `ViewMode.USER.value == "user"`, etc.

12. `test_view_cycle_order` -- Assert `VIEW_CYCLE == [ViewMode.USER, ViewMode.DEBUG, ViewMode.AI_SELF]`.

13. `test_view_formatters_maps_all_modes` -- Assert every `ViewMode` member is in `VIEW_FORMATTERS`. Assert each value is the correct class.

Run: `uv run pytest tests/repl/test_views.py -x -q`
  </action>
  <verify>`uv run pytest tests/repl/test_views.py -x -q` -- all tests pass, zero failures, zero warnings.</verify>
  <done>13+ new tests cover DebugView metadata rendering, AISelfView tag mapping, ViewMode enum, VIEW_CYCLE, VIEW_FORMATTERS. All pass.</done>
</task>

</tasks>

<verification>
```bash
# All view tests pass
uv run pytest tests/repl/test_views.py -x -q

# Imports work
uv run python -c "from bae.repl.views import DebugView, AISelfView, ViewMode, VIEW_CYCLE, VIEW_FORMATTERS, UserView; print('All exports available')"

# Protocol compliance
uv run python -c "from bae.repl.channels import ViewFormatter; from bae.repl.views import DebugView, AISelfView; assert isinstance(DebugView(), ViewFormatter); assert isinstance(AISelfView(), ViewFormatter); print('Protocol OK')"

# Full test suite (excluding integration)
uv run pytest tests/ -x -q --ignore=tests/test_integration.py
```
</verification>

<success_criteria>
- DebugView renders `[channel] key=value ...` header + raw indented content
- AISelfView renders `[ai-perspective-tag]` header + raw indented content
- ViewMode enum has USER, DEBUG, AI_SELF
- VIEW_FORMATTERS maps all modes to their classes
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/25-views-completion/25-01-SUMMARY.md`
</output>
