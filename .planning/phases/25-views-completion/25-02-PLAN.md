---
phase: 25-views-completion
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - bae/repl/shell.py
  - bae/repl/toolbar.py
  - tests/repl/test_toolbar.py
autonomous: true

must_haves:
  truths:
    - "Pressing Ctrl+V cycles view_mode through USER -> DEBUG -> AI_SELF -> USER"
    - "_set_view() updates _formatter on every registered channel to a fresh formatter instance"
    - "Toolbar shows the active view mode name when not in USER view"
    - "Toolbar hides the view indicator when in USER view (default, no clutter)"
    - "Style dict includes toolbar.view class for view widget styling"
  artifacts:
    - path: "bae/repl/shell.py"
      provides: "view_mode state, _set_view method, Ctrl+V keybinding"
      contains: "_set_view"
    - path: "bae/repl/toolbar.py"
      provides: "make_view_widget factory"
      contains: "make_view_widget"
    - path: "tests/repl/test_toolbar.py"
      provides: "Tests for make_view_widget"
      contains: "test_make_view_widget"
  key_links:
    - from: "bae/repl/shell.py"
      to: "bae/repl/views.py"
      via: "imports ViewMode, VIEW_CYCLE, VIEW_FORMATTERS"
      pattern: "from bae\\.repl\\.views import.*ViewMode"
    - from: "bae/repl/shell.py"
      to: "bae/repl/toolbar.py"
      via: "toolbar.add('view', make_view_widget(self))"
      pattern: "make_view_widget"
    - from: "bae/repl/shell.py"
      to: "bae/repl/channels.py"
      via: "_set_view iterates router._channels to set _formatter"
      pattern: "router\\._channels\\.values"
---

<objective>
Wire view toggling into CortexShell: _set_view method, Ctrl+V keybinding, toolbar view widget, and style entry.

Purpose: VIEW-05 (runtime view toggling via keybinding) and toolbar indicator. This connects the DebugView/AISelfView/ViewMode infrastructure from Plan 01 to the running REPL.

Output: Working Ctrl+V toggle that cycles all channel formatters, toolbar indicator showing active view, and tests.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-views-completion/25-RESEARCH.md
@.planning/phases/25-views-completion/25-01-SUMMARY.md
@bae/repl/shell.py
@bae/repl/toolbar.py
@bae/repl/channels.py
@bae/repl/views.py
@tests/repl/test_toolbar.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add _set_view method and view_mode state to CortexShell</name>
  <files>bae/repl/shell.py</files>
  <action>
1. Update the import from `bae.repl.views` to also import `ViewMode`, `VIEW_CYCLE`, `VIEW_FORMATTERS`:
   ```python
   from bae.repl.views import UserView, ViewMode, VIEW_CYCLE, VIEW_FORMATTERS
   ```

2. In `CortexShell.__init__`, add `self.view_mode = ViewMode.USER` (after `self.router` is set up, near where `self.router.py._formatter = UserView()` is).

3. Replace the single-channel formatter assignment `self.router.py._formatter = UserView()` with a call to `self._set_view(ViewMode.USER)`. This sets formatter on ALL channels, not just py.

4. Add the `_set_view` method to CortexShell:
   ```python
   def _set_view(self, mode: ViewMode) -> None:
       """Switch all channels to the given view mode."""
       self.view_mode = mode
       formatter = VIEW_FORMATTERS[mode]()
       for ch in self.router._channels.values():
           ch._formatter = formatter
   ```
   This creates a FRESH formatter instance each time (important: UserView has buffer state that must not be stale after switching).

5. Add the Ctrl+V keybinding in `_build_key_bindings()`, right after the existing Shift+Tab `cycle_mode` binding:
   ```python
   @kb.add("c-v")
   def cycle_view(event):
       """Ctrl+V cycles view modes."""
       idx = VIEW_CYCLE.index(shell.view_mode)
       shell._set_view(VIEW_CYCLE[(idx + 1) % len(VIEW_CYCLE)])
       event.app.invalidate()
   ```
   This follows the exact same pattern as the Shift+Tab mode cycling.

6. Add `"toolbar.view": "bg:#303030 #ffaf87"` to the `Style.from_dict()` dict in the PromptSession constructor, alongside the existing `toolbar.mode`, `toolbar.tasks`, etc. entries.
  </action>
  <verify>
`uv run python -c "from bae.repl.views import ViewMode; print('import OK')"` -- no import errors.
Grep for `_set_view` and `c-v` in shell.py to confirm wiring.
  </verify>
  <done>CortexShell has view_mode state, _set_view method that swaps all channel formatters, Ctrl+V keybinding, and toolbar.view style class.</done>
</task>

<task type="auto">
  <name>Task 2: Add make_view_widget to toolbar.py and wire in shell.py</name>
  <files>bae/repl/toolbar.py, bae/repl/shell.py</files>
  <action>
1. In `toolbar.py`, add `make_view_widget` factory function after the existing `make_mem_widget`:
   ```python
   def make_view_widget(shell) -> ToolbarWidget:
       """Built-in widget: active view mode (hidden in default user view)."""
       def widget():
           if shell.view_mode.value == "user":
               return []
           return [("class:toolbar.view", f" {shell.view_mode.value} ")]
       return widget
   ```
   This returns empty list when in USER view (default, no clutter) and shows the view name otherwise.

2. In `shell.py`, update the toolbar import to include `make_view_widget`:
   ```python
   from bae.repl.toolbar import (
       TASKS_PER_PAGE,
       ToolbarConfig,
       make_cwd_widget,
       make_mem_widget,
       make_mode_widget,
       make_tasks_widget,
       make_view_widget,
   )
   ```

3. In `CortexShell.__init__`, add the view widget registration after `self.toolbar.add("mode", ...)`:
   ```python
   self.toolbar.add("view", make_view_widget(self))
   ```
   Place it right after `"mode"` so the view indicator appears next to the mode indicator in the toolbar.
  </action>
  <verify>
`uv run python -c "from bae.repl.toolbar import make_view_widget; print('import OK')"` -- no import errors.
  </verify>
  <done>make_view_widget exists in toolbar.py, wired into shell toolbar as "view" widget after "mode".</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for view widget and verify full test suite</name>
  <files>tests/repl/test_toolbar.py</files>
  <action>
1. In `test_toolbar.py`, add import for `make_view_widget`:
   ```python
   from bae.repl.toolbar import (
       ToolbarConfig,
       make_cwd_widget,
       make_mem_widget,
       make_mode_widget,
       make_tasks_widget,
       make_view_widget,
   )
   ```

2. Add these tests to the `TestBuiltinWidgets` class:

   `test_make_view_widget_hidden_in_user_mode`:
   - Create `shell = MagicMock()` with `shell.view_mode.value = "user"`.
   - `widget = make_view_widget(shell)`
   - Assert `widget() == []` (hidden in default user view).

   `test_make_view_widget_shows_debug`:
   - Create `shell = MagicMock()` with `shell.view_mode.value = "debug"`.
   - `widget = make_view_widget(shell)`
   - Assert `widget() == [("class:toolbar.view", " debug ")]`.

   `test_make_view_widget_shows_ai_self`:
   - Create `shell = MagicMock()` with `shell.view_mode.value = "ai-self"`.
   - `widget = make_view_widget(shell)`
   - Assert `widget() == [("class:toolbar.view", " ai-self ")]`.

Run full test suite: `uv run pytest tests/ -x -q --ignore=tests/test_integration.py`
  </action>
  <verify>
```bash
uv run pytest tests/repl/test_toolbar.py -x -q
uv run pytest tests/ -x -q --ignore=tests/test_integration.py
```
All tests pass, zero failures.
  </verify>
  <done>3 new toolbar tests cover view widget hidden/debug/ai-self states. Full test suite passes.</done>
</task>

</tasks>

<verification>
```bash
# Toolbar tests pass
uv run pytest tests/repl/test_toolbar.py -x -q

# View tests still pass
uv run pytest tests/repl/test_views.py -x -q

# Full test suite (excluding integration)
uv run pytest tests/ -x -q --ignore=tests/test_integration.py

# Shell imports cleanly
uv run python -c "from bae.repl.shell import CortexShell; print('Shell OK')"

# View toggle infrastructure available
uv run python -c "from bae.repl.views import ViewMode, VIEW_CYCLE, VIEW_FORMATTERS; from bae.repl.toolbar import make_view_widget; print('All exports OK')"
```
</verification>

<success_criteria>
- Ctrl+V keybinding exists in _build_key_bindings
- _set_view updates _formatter on all channels via router._channels.values()
- make_view_widget returns empty list for USER, view name for DEBUG/AI_SELF
- toolbar.view style class in Style.from_dict
- All tests pass including full suite
</success_criteria>

<output>
After completion, create `.planning/phases/25-views-completion/25-02-SUMMARY.md`
</output>
