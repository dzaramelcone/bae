---
phase: 32.1-resourcespace-package-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/repl/spaces/__init__.py
  - bae/repl/spaces/source/__init__.py
  - bae/repl/spaces/source/service.py
  - bae/repl/spaces/source/models.py
  - bae/repl/spaces/source/schemas.py
  - bae/repl/spaces/source/view.py
  - bae/repl/spaces/home/__init__.py
  - bae/repl/spaces/home/service.py
  - bae/repl/spaces/home/view.py
  - bae/repl/resource.py
  - bae/repl/source.py
autonomous: true

must_haves:
  truths:
    - "All existing tests pass without modification"
    - "Source resourcespace code lives in bae/repl/spaces/source/"
    - "Home tools and orientation code lives in bae/repl/spaces/home/"
    - "Protocol types are importable from bae/repl/spaces/"
    - "Old import paths (bae.repl.resource, bae.repl.source) still resolve"
  artifacts:
    - path: "bae/repl/spaces/__init__.py"
      provides: "Protocol re-exports (Resourcespace, ResourceRegistry, ResourceHandle, ResourceError, NavResult, format_*)"
      contains: "from bae.repl.spaces"
    - path: "bae/repl/spaces/source/service.py"
      provides: "SourceResourcespace, DepsSubresource, ConfigSubresource, TestsSubresource, MetaSubresource"
      contains: "class SourceResourcespace"
    - path: "bae/repl/spaces/source/models.py"
      provides: "Module path helpers (_module_to_path, _path_to_module, _validate_module_path, _discover_packages, _discover_all_modules)"
      contains: "_module_to_path"
    - path: "bae/repl/spaces/home/service.py"
      provides: "Home filesystem tools (_exec_read, _exec_glob, _exec_grep)"
      contains: "_exec_read"
    - path: "bae/repl/spaces/home/view.py"
      provides: "Home orientation and dispatch helpers"
  key_links:
    - from: "bae/repl/resource.py"
      to: "bae/repl/spaces/__init__.py"
      via: "re-export for backward compat"
      pattern: "from bae\\.repl\\.spaces import"
    - from: "bae/repl/source.py"
      to: "bae/repl/spaces/source/service.py"
      via: "re-export for backward compat"
      pattern: "from bae\\.repl\\.spaces\\.source"
---

<objective>
Create bae/repl/spaces/ package structure and move resourcespace code into dedicated sub-packages, with backward-compatible re-exports so all existing imports and tests pass unchanged.

Purpose: Establish the package layout before Phases 33-36 add more resourcespaces. Moving code now prevents compounding tech debt.
Output: New package structure with all code relocated; old modules become thin re-export shims.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bae/repl/resource.py
@bae/repl/source.py
@bae/repl/tools.py
@bae/repl/ai.py
@bae/repl/shell.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spaces/ package and move source resourcespace code</name>
  <files>
    bae/repl/spaces/__init__.py
    bae/repl/spaces/source/__init__.py
    bae/repl/spaces/source/service.py
    bae/repl/spaces/source/models.py
    bae/repl/spaces/source/schemas.py
    bae/repl/spaces/source/view.py
  </files>
  <action>
Create the directory structure:
```
bae/repl/spaces/
  __init__.py
  source/
    __init__.py
    service.py
    models.py
    schemas.py
    view.py
  home/
    __init__.py
    service.py
    view.py
```

**bae/repl/spaces/__init__.py** -- Re-export the protocol layer. Import everything from bae.repl.resource (the canonical location stays in resource.py for now) and re-export. This makes `from bae.repl.spaces import Resourcespace, ResourceRegistry, ...` work.

```python
from bae.repl.resource import (
    NavResult,
    ResourceError,
    ResourceHandle,
    ResourceRegistry,
    Resourcespace,
    format_nav_error,
    format_unsupported_error,
    MAX_STACK_DEPTH,
    _TOOL_NAMES,
)
```

**bae/repl/spaces/source/models.py** -- Move these functions from bae/repl/source.py:
- `_validate_module_path`
- `_module_to_path`
- `_path_to_module`
- `_module_summary`
- `_read_symbol`
- `_discover_packages`
- `_discover_all_modules`
- `_find_symbol`
- `_replace_symbol`
- `_hot_reload`
- `CHAR_CAP` constant
- `_GLOB_VALID` regex

These are the domain model helpers. They import from `bae.repl.resource` (just ResourceError). Keep that import.

**bae/repl/spaces/source/schemas.py** -- Empty file with docstring only. No Pydantic schemas exist yet for source; this is a placeholder for future IO/DTO definitions.

```python
"""Source resourcespace IO schemas (reserved for future use)."""
```

**bae/repl/spaces/source/view.py** -- Empty file with docstring. The enter/nav display logic is currently inline in SourceResourcespace methods. When it grows, it moves here. Placeholder for now.

```python
"""Source resourcespace view helpers (reserved for future use)."""
```

**bae/repl/spaces/source/service.py** -- Move these classes from bae/repl/source.py:
- `DepsSubresource`
- `ConfigSubresource`
- `TestsSubresource`
- `MetaSubresource`
- `SourceResourcespace`

These import from models.py (same package): `from bae.repl.spaces.source.models import ...`
And from resource: `from bae.repl.resource import ResourceError, Resourcespace`

**bae/repl/spaces/source/__init__.py** -- Re-export public names:
```python
from bae.repl.spaces.source.service import (
    SourceResourcespace,
    DepsSubresource,
    ConfigSubresource,
    TestsSubresource,
    MetaSubresource,
)
from bae.repl.spaces.source.models import (
    CHAR_CAP,
    _validate_module_path,
    _module_to_path,
    _path_to_module,
    _module_summary,
    _read_symbol,
    _discover_packages,
    _discover_all_modules,
    _find_symbol,
    _replace_symbol,
    _hot_reload,
)
```

CRITICAL: Match the exact style and formatting of surrounding code. All files use `from __future__ import annotations`. Preserve every import, constant, and function signature exactly.
  </action>
  <verify>
`python -c "from bae.repl.spaces.source import SourceResourcespace; print('OK')"` succeeds.
`python -c "from bae.repl.spaces.source.models import _module_to_path, _validate_module_path; print('OK')"` succeeds.
`python -c "from bae.repl.spaces import Resourcespace, ResourceRegistry; print('OK')"` succeeds.
  </verify>
  <done>All source resourcespace code exists in bae/repl/spaces/source/ and is importable from the new paths.</done>
</task>

<task type="auto">
  <name>Task 2: Create home package and set up backward-compatible re-exports</name>
  <files>
    bae/repl/spaces/home/__init__.py
    bae/repl/spaces/home/service.py
    bae/repl/spaces/home/view.py
    bae/repl/source.py
  </files>
  <action>
**bae/repl/spaces/home/service.py** -- Move these functions from bae/repl/ai.py:
- `_exec_read`
- `_exec_write`
- `_exec_edit_read`
- `_exec_edit_replace`
- `_exec_glob`
- `_exec_grep`
- `_MAX_TOOL_OUTPUT` constant
- `_LINE_RANGE_RE` regex

These are the filesystem tool implementations used at home (root). They have minimal dependencies (just `re`, `Path`, `glob`). Move them verbatim.

**bae/repl/spaces/home/view.py** -- Placeholder docstring only for now. The orientation builder (_build_orientation) is a method on ResourceRegistry, not a standalone function, so it stays in resource.py.

```python
"""Home resourcespace view helpers (reserved for future use)."""
```

**bae/repl/spaces/home/__init__.py** -- Re-export public names:
```python
from bae.repl.spaces.home.service import (
    _exec_read,
    _exec_write,
    _exec_edit_read,
    _exec_edit_replace,
    _exec_glob,
    _exec_grep,
    _MAX_TOOL_OUTPUT,
)
```

**bae/repl/source.py** -- Replace the entire file with backward-compatible re-exports from the new location. This ensures all existing `from bae.repl.source import X` statements still work.

```python
"""Backward-compatible re-exports from bae.repl.spaces.source."""
from bae.repl.spaces.source.service import (  # noqa: F401
    SourceResourcespace,
    DepsSubresource,
    ConfigSubresource,
    TestsSubresource,
    MetaSubresource,
)
from bae.repl.spaces.source.models import (  # noqa: F401
    CHAR_CAP,
    _validate_module_path,
    _module_to_path,
    _path_to_module,
    _module_summary,
    _read_symbol,
    _discover_packages,
    _discover_all_modules,
    _find_symbol,
    _replace_symbol,
    _hot_reload,
    _GLOB_VALID,
)
```

**bae/repl/ai.py** -- Update the home tool functions to import from new location. Replace the function definitions of `_exec_read`, `_exec_write`, `_exec_edit_read`, `_exec_edit_replace`, `_exec_glob`, `_exec_grep` and the `_MAX_TOOL_OUTPUT` / `_LINE_RANGE_RE` constants with imports from `bae.repl.spaces.home.service`. Keep the `_TOOL_NAMES`, `_TOOL_EXEC`, `_TOOL_DISPATCH`, `_tool_summary`, `run_tool_calls`, `_load_prompt`, `_build_context` functions in ai.py (they are AI-specific, not home-specific). Update `_TOOL_EXEC` dict to reference the imported functions.

Specifically in ai.py, replace lines defining _MAX_TOOL_OUTPUT through _exec_grep with:
```python
from bae.repl.spaces.home.service import (
    _exec_read,
    _exec_write,
    _exec_edit_read,
    _exec_edit_replace,
    _exec_glob,
    _exec_grep,
    _MAX_TOOL_OUTPUT,
    _LINE_RANGE_RE,
)
```

Remove the old function bodies but keep everything else in ai.py untouched.

**bae/repl/shell.py** -- Update the import to get home tools from the new location:
- Change `from bae.repl.ai import _exec_read, _exec_glob, _exec_grep` to `from bae.repl.spaces.home import _exec_read, _exec_glob, _exec_grep`
- Change `from bae.repl.source import SourceResourcespace` to `from bae.repl.spaces.source import SourceResourcespace`

**bae/repl/tools.py** -- No changes needed. It imports from bae.repl.resource which is untouched. Its lazy import of `from bae.repl.ai import _exec_glob, _exec_grep, _exec_read` in _home_dispatch should be updated to `from bae.repl.spaces.home import _exec_glob, _exec_grep, _exec_read`.
  </action>
  <verify>
`uv run pytest tests/test_resource.py tests/test_source.py tests/test_tools_router.py -x -q` -- all tests pass with zero modifications to test files.
`uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full test suite passes.
  </verify>
  <done>
Home tools live in bae/repl/spaces/home/. Old bae/repl/source.py is a thin re-export shim. All production imports updated to new paths where direct (shell.py, tools.py). All tests pass unchanged.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full test suite passes
2. `python -c "from bae.repl.spaces.source import SourceResourcespace; print('new path OK')"` -- new import works
3. `python -c "from bae.repl.source import SourceResourcespace; print('old path OK')"` -- backward compat works
4. `python -c "from bae.repl.spaces.home import _exec_read; print('home OK')"` -- home tools importable
5. `python -c "from bae.repl.spaces import Resourcespace, ResourceRegistry, ResourceError; print('protocol OK')"` -- protocol types importable from spaces
</verification>

<success_criteria>
- All existing tests pass with zero test file modifications
- New package structure exists: bae/repl/spaces/{__init__.py, source/, home/}
- Source resourcespace code is in spaces/source/service.py and spaces/source/models.py
- Home filesystem tools are in spaces/home/service.py
- Old import paths still work via re-export shims
- Production code (shell.py, tools.py) uses new import paths
</success_criteria>

<output>
After completion, create `.planning/phases/32.1-resourcespace-package-structure/32.1-01-SUMMARY.md`
</output>
