---
phase: 32.1-resourcespace-package-structure
plan: 02
type: execute
wave: 2
depends_on: ["32.1-01"]
files_modified:
  - tests/test_resource.py
  - tests/test_source.py
  - tests/test_tools_router.py
  - bae/repl/ai.py
autonomous: true

must_haves:
  truths:
    - "All test imports use new bae.repl.spaces paths"
    - "No test imports bae.repl.source directly (uses bae.repl.spaces.source)"
    - "ai.py no longer contains filesystem tool function bodies"
    - "All tests pass after import migration"
  artifacts:
    - path: "tests/test_resource.py"
      provides: "Protocol tests importing from bae.repl.spaces"
      contains: "from bae.repl.spaces"
    - path: "tests/test_source.py"
      provides: "Source tests importing from bae.repl.spaces.source"
      contains: "from bae.repl.spaces.source"
    - path: "tests/test_tools_router.py"
      provides: "Router tests importing from bae.repl.spaces"
      contains: "from bae.repl.spaces"
  key_links:
    - from: "tests/test_source.py"
      to: "bae/repl/spaces/source/service.py"
      via: "direct import"
      pattern: "from bae\\.repl\\.spaces\\.source import"
    - from: "tests/test_resource.py"
      to: "bae/repl/spaces/__init__.py"
      via: "direct import"
      pattern: "from bae\\.repl\\.spaces import"
---

<objective>
Migrate all test imports from old paths (bae.repl.resource, bae.repl.source) to new package paths (bae.repl.spaces, bae.repl.spaces.source). Clean up ai.py to confirm home tools are fully delegated.

Purpose: Complete the migration so tests validate the new package structure directly, not through backward-compat shims.
Output: Tests using canonical new import paths; ai.py cleaned of relocated code.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32.1-resourcespace-package-structure/32.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test imports to new package paths</name>
  <files>
    tests/test_resource.py
    tests/test_source.py
    tests/test_tools_router.py
  </files>
  <action>
**tests/test_resource.py** -- Change the import block:
```python
# Old:
from bae.repl.resource import (
    NavResult, ResourceError, ResourceHandle, ResourceRegistry,
    Resourcespace, format_nav_error, format_unsupported_error,
)
# New:
from bae.repl.spaces import (
    NavResult, ResourceError, ResourceHandle, ResourceRegistry,
    Resourcespace, format_nav_error, format_unsupported_error,
)
```

No other changes. Every test body stays identical.

**tests/test_source.py** -- Change imports:
```python
# Old:
from bae.repl.resource import ResourceError, Resourcespace
from bae.repl.source import SourceResourcespace
# New:
from bae.repl.spaces import ResourceError, Resourcespace
from bae.repl.spaces.source import SourceResourcespace
```

Also update inline imports within test methods:
- `from bae.repl.source import _module_to_path` -> `from bae.repl.spaces.source.models import _module_to_path`
- `from bae.repl.source import _path_to_module` -> `from bae.repl.spaces.source.models import _path_to_module`
- `from bae.repl.source import _validate_module_path` -> `from bae.repl.spaces.source.models import _validate_module_path`
- `from bae.repl.source import _hot_reload` -> `from bae.repl.spaces.source.models import _hot_reload`
- `from bae.repl.source import _module_summary` -> `from bae.repl.spaces.source.models import _module_summary`
- `from bae.repl.resource import ResourceHandle, ResourceRegistry` -> `from bae.repl.spaces import ResourceHandle, ResourceRegistry`

**tests/test_tools_router.py** -- Change imports:
```python
# Old:
from bae.repl.resource import (
    ResourceError, ResourceRegistry, Resourcespace, format_unsupported_error,
)
from bae.repl.tools import CHAR_CAP, TOKEN_CAP, ToolRouter
# New:
from bae.repl.spaces import (
    ResourceError, ResourceRegistry, Resourcespace, format_unsupported_error,
)
from bae.repl.tools import CHAR_CAP, TOKEN_CAP, ToolRouter
```

(ToolRouter stays in bae.repl.tools -- it's cross-cutting, not per-space.)
  </action>
  <verify>
`uv run pytest tests/test_resource.py tests/test_source.py tests/test_tools_router.py -x -q` -- all pass.
`uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full suite passes.
  </verify>
  <done>All three test files import from bae.repl.spaces (not bae.repl.resource or bae.repl.source). All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Verify ai.py cleanup and final import audit</name>
  <files>
    bae/repl/ai.py
  </files>
  <action>
Verify that ai.py from Plan 01 correctly:
1. Imports `_exec_read`, `_exec_write`, `_exec_edit_read`, `_exec_edit_replace`, `_exec_glob`, `_exec_grep`, `_MAX_TOOL_OUTPUT`, `_LINE_RANGE_RE` from `bae.repl.spaces.home.service`
2. No longer contains the function bodies for those functions
3. Still contains: AI class, `_TOOL_NAMES`, `_TOOL_EXEC`, `_TOOL_DISPATCH`, `_tool_summary`, `run_tool_calls`, `_load_prompt`, `_build_context` (these are AI-specific)
4. The `_build_context` function's import of `ResourceHandle` should be updated: `from bae.repl.spaces import ResourceHandle`

If ai.py still has old function bodies, remove them and replace with imports. If the ResourceHandle import is still from `bae.repl.resource`, update it to `from bae.repl.spaces import ResourceHandle`.

Run a grep across the entire codebase for any remaining `from bae.repl.source import` or `from bae.repl.resource import` in production code (bae/ directory, not tests/). The only files that should still have these are:
- `bae/repl/resource.py` itself (canonical location, unchanged)
- `bae/repl/source.py` (now a re-export shim importing from spaces.source)
- `bae/repl/spaces/source/service.py` (imports ResourceError from bae.repl.resource)
- `bae/repl/spaces/source/models.py` (imports ResourceError from bae.repl.resource)
- `bae/repl/tools.py` (imports from bae.repl.resource -- this is fine, resource.py is the canonical location for protocol types)

If any other production file still has old imports, update them.
  </action>
  <verify>
`uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full suite passes.
`python -c "import bae.repl.spaces; import bae.repl.spaces.source; import bae.repl.spaces.home; print('All packages importable')"` -- confirms structure.
Grep `bae/` for `from bae.repl.source import` -- only bae/repl/source.py itself and planning files.
Grep `bae/` for `from bae.repl.ai import _exec` -- should return zero hits in production code.
  </verify>
  <done>ai.py is clean (no relocated function bodies). All production imports use new paths or canonical resource.py. No stale imports remain.</done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full test suite passes
2. No test file contains `from bae.repl.resource import` or `from bae.repl.source import`
3. `grep -r "from bae.repl.ai import _exec" bae/` -- zero hits
4. `grep -r "from bae.repl.source import" bae/` -- only bae/repl/source.py (the shim)
</verification>

<success_criteria>
- All tests import from bae.repl.spaces (new canonical paths)
- ai.py contains no relocated filesystem tool functions
- Full test suite passes
- Codebase is clean: no stale imports in production code
</success_criteria>

<output>
After completion, create `.planning/phases/32.1-resourcespace-package-structure/32.1-02-SUMMARY.md`
</output>
