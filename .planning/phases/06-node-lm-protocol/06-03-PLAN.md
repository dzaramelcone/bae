---
phase: 06-node-lm-protocol
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - bae/result.py
  - tests/test_result_v2.py
autonomous: true

must_haves:
  truths:
    - "GraphResult.result returns the terminal node (last node in trace)"
    - "GraphResult.trace includes ALL nodes: start + intermediate + terminal"
    - "Graph[T] generic makes .result typed as T when specified"
    - "Graph without generic parameter still works (.result typed as Node)"
  artifacts:
    - path: "bae/result.py"
      provides: "GraphResult with .result property and Generic[T] support"
      contains: "class GraphResult"
    - path: "tests/test_result_v2.py"
      provides: "Tests for GraphResult.result, trace semantics, Graph[T]"
  key_links:
    - from: "bae/result.py"
      to: "bae/node.py"
      via: "Node type for TypeVar bound"
      pattern: "bound=.*Node"
---

<objective>
Redesign GraphResult to expose a `.result` property that returns the terminal node (the graph's response), and make GraphResult generic with `GraphResult[T]` so that `Graph[T]` can provide typed access to the terminal node.

Purpose: The terminal node IS the graph's response schema (NODE-03). Currently GraphResult.node is None when the graph terminates. The new design preserves the terminal node as `.result` so the caller can access the graph's output fields. Graph[T] provides type-safe access when the terminal type is known.

Output: Updated bae/result.py with generic GraphResult, new test file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-node-lm-protocol/06-CONTEXT.md
@.planning/phases/06-node-lm-protocol/06-RESEARCH.md
@bae/result.py
@bae/node.py
@bae/graph.py
@tests/test_result.py
@tests/test_auto_routing.py
</context>

<feature>
  <name>GraphResult.result property and Graph[T] generic</name>
  <files>bae/result.py, tests/test_result_v2.py</files>
  <behavior>
    GraphResult changes:
    - GraphResult becomes Generic[T] where T = TypeVar("T", bound=Node, default=Node)
    - Keep existing `node: Node | None` field for backward compatibility
    - Add `result` property that returns the last node in trace (the terminal node), or None if trace is empty
    - `.result` is typed as `T` when GraphResult[T] is used
    - `.trace` semantics clarified: includes ALL nodes in execution order (start, intermediate, terminal)
    - The terminal node IS in the trace (it was already -- trace.append(current) happens before __call__)

    IMPORTANT: The current Graph.run() already appends nodes to trace before calling __call__. So the terminal node IS already in trace. The `.result` property just provides typed access to trace[-1].

    IMPORTANT: Keep `node` field for backward compat. Current code sets `node=current` where current is None after terminal node returns None. Phase 7 may change this, but for now keep it.

    IMPORTANT: GraphResult is currently a dataclass. We need to make it Generic. Options:
    - Convert to a regular class with __init__ (simplest for Generic support)
    - Use dataclass with Generic mixin
    Either works. Prefer the approach that keeps existing `GraphResult(node=..., trace=...)` construction working.

    Test cases:
    - GraphResult with trace [A, B, C]: .result is C (last node)
    - GraphResult with empty trace: .result is None
    - GraphResult with single node trace [A]: .result is A
    - GraphResult.node still works (backward compat)
    - GraphResult.trace is accessible and ordered
    - GraphResult[SpecificNode] type annotation works (type-level, not runtime)
    - GraphResult(node=None, trace=[a, b]) construction still works
    - Existing test_result.py tests still pass
    - Existing test_auto_routing.py tests still pass (they check result.node and result.trace)
  </behavior>
  <implementation>
    In bae/result.py:
    1. Import Generic, TypeVar from typing
    2. Import Node from bae.node
    3. Define T = TypeVar("T", bound=Node, default=Node) using PEP 696 default
    4. Make GraphResult generic: class GraphResult(Generic[T]) -- keep it as a dataclass if possible
    5. Keep `node: Node | None` field
    6. Keep `trace: list[Node]` field
    7. Add `result` property:
       ```python
       @property
       def result(self) -> T | None:
           """The terminal node (graph's response). Last node in trace."""
           return self.trace[-1] if self.trace else None
       ```
    8. Note: The @property return type uses T, but at runtime T is just Node. The typing benefit comes when Graph[TerminalType] is used.

    Note on dataclass + Generic: In Python 3.12+, `@dataclass class GraphResult(Generic[T])` works. Since bae requires Python 3.14+, this is fine.
  </implementation>
</feature>

<verification>
- `cd /Users/dzaramelcone/lab/bae && python -m pytest tests/test_result_v2.py -v` -- all new tests pass
- `cd /Users/dzaramelcone/lab/bae && python -m pytest tests/test_result.py -v` -- existing tests still pass
- `cd /Users/dzaramelcone/lab/bae && python -m pytest tests/test_auto_routing.py -v` -- existing tests still pass
- `cd /Users/dzaramelcone/lab/bae && python -m pytest tests/ -v` -- full test suite passes
</verification>

<success_criteria>
- GraphResult.result returns trace[-1] (the terminal node)
- GraphResult is Generic[T] with T defaulting to Node
- Backward compat: GraphResult(node=..., trace=...) still works
- Backward compat: result.node still accessible
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06-node-lm-protocol/06-03-SUMMARY.md`
</output>
