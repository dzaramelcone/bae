---
phase: 02-dspy-integration
plan: 04
type: tdd
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - bae/graph.py
  - tests/test_dep_injection.py
autonomous: true

must_haves:
  truths:
    - "External deps passed via kwargs on Graph.run()"
    - "Bind-annotated node fields are captured after node execution"
    - "Dep-annotated __call__ params are injected by type matching"
    - "Bind values accumulate through the run"
    - "Incant handles the injection mechanics"
  artifacts:
    - path: "bae/graph.py"
      provides: "Dep injection via incant"
      contains: "incanter"
    - path: "tests/test_dep_injection.py"
      provides: "Dep injection tests"
      min_lines: 100
  key_links:
    - from: "bae/graph.py"
      to: "incant"
      via: "register_by_type"
      pattern: "incanter\\.register_by_type"
    - from: "bae/graph.py"
      to: "bae/markers.py"
      via: "Bind/Dep markers"
      pattern: "from bae.markers import.*Bind.*Dep"
---

<objective>
Implement Dep injection via incant. External deps come from Graph.run() kwargs. Bind-annotated node fields are captured after execution and made available to downstream Dep params by type matching.

Purpose: Deps "accumulate throughout the run" - Bind captures values nodes produce, Dep consumes them downstream. No explicit field copying needed.

Output: Updated bae/graph.py with incant-based injection
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-dspy-integration/02-CONTEXT.md
@.planning/phases/02-dspy-integration/02-RESEARCH.md

# Need Bind marker from 02-01
@.planning/phases/02-dspy-integration/02-01-SUMMARY.md
# Need auto-routing from 02-02
@.planning/phases/02-dspy-integration/02-02-SUMMARY.md

@bae/graph.py
@bae/markers.py
@bae/node.py
</context>

<feature>
  <name>Feature 1: External Deps via run() kwargs</name>
  <files>bae/graph.py, tests/test_dep_injection.py</files>
  <behavior>
    Graph.run() accepts **kwargs for external dependencies:
    - graph.run(node, db=conn, cache=redis)
    - These are registered with incant by their type
    - Available to any Dep param of matching type

    Cases:
    - run(node, db=Connection()) -> Dep[Connection] receives db
    - run(node) with node needing Dep[X] -> error (missing dep)
    - run(node, x=val1, y=val2) -> multiple deps available
  </behavior>
  <implementation>
    In run(), create fresh Incanter instance.
    For each kwarg, call incanter.register_by_type(type(value), lambda: value).
    Use incanter for node __call__ invocation.
  </implementation>
</feature>

<feature>
  <name>Feature 2: Bind Field Capture</name>
  <files>bae/graph.py, tests/test_dep_injection.py</files>
  <behavior>
    After each node executes, scan its fields for Bind annotations:
    - Bind-annotated fields have their values captured
    - Values are registered with incant by their type
    - Available to downstream nodes

    Cases:
    - class A(Node): x: Annotated[Conn, Bind()] -> after A runs, Conn registered
    - class B(Node): def __call__(self, lm, c: Annotated[Conn, Dep()]) -> B gets A's Conn
    - Multiple nodes can consume same Bind value
  </behavior>
  <implementation>
    After node execution, before moving to next:
    1. Get type hints with include_extras=True
    2. Find Bind-annotated fields
    3. Get field value from node instance
    4. Register with incanter by field's base type
  </implementation>
</feature>

<feature>
  <name>Feature 3: Dep Param Injection via Incant</name>
  <files>bae/graph.py, tests/test_dep_injection.py</files>
  <behavior>
    When calling node.__call__(), use incant to inject Dep params:
    - Incant matches Dep param types to registered values
    - lm is always passed explicitly
    - Other params come from incant registry

    Cases:
    - __call__(self, lm, db: Annotated[Conn, Dep()]) -> db injected from registry
    - __call__(self, lm) -> no injection needed
    - Missing dep type in registry -> incant raises -> wrapped as BaeError
  </behavior>
  <implementation>
    Replace direct node(lm=lm) with incanter.compose_and_call(node.__call__, self=node, lm=lm).
    Incant fills remaining params from registry.
  </implementation>
</feature>

<verification>
All tests pass:
```bash
pytest tests/test_dep_injection.py -v
```

Existing tests still pass:
```bash
pytest tests/ -v
```
</verification>

<success_criteria>
- External deps from run() kwargs are injectable
- Bind fields captured after node execution
- Dep params injected by type matching
- Deps accumulate through the run
- Missing deps raise appropriate error
- All tests pass (new and existing)
</success_criteria>

<output>
After completion, create `.planning/phases/02-dspy-integration/02-04-SUMMARY.md`
</output>
