---
phase: 31-resource-protocol-navigation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/repl/resource.py
  - bae/repl/shell.py
  - tests/test_resource.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "homespace() in REPL displays bold-rendered nav tree, not escaped ANSI codes"
    - "back() at root displays the same rendered nav tree"
    - "Navigating into a resource displays rendered entry, not escaped codes"
  artifacts:
    - path: "bae/repl/resource.py"
      provides: "NavResult str subclass with raw __repr__"
      contains: "class NavResult"
    - path: "bae/repl/shell.py"
      provides: "homespace/back lambdas returning NavResult"
    - path: "tests/test_resource.py"
      provides: "Tests proving repr(nav_result) preserves ANSI"
      contains: "repr"
  key_links:
    - from: "bae/repl/resource.py"
      to: "bae/repl/shell.py"
      via: "NavResult returned by registry methods, repr'd by _run_py"
      pattern: "repr.*NavResult|NavResult.*repr"
---

<objective>
Fix ANSI escape code rendering in navigation output.

Purpose: homespace(), back(), and resource navigation return ANSI strings that get repr()'d
by _run_py in shell.py (line 429-431), escaping the codes and showing raw \x1b sequences
instead of bold/styled text. The fix: a str subclass whose __repr__ returns self (raw ANSI).

Output: Navigation commands render styled text in the REPL.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-resource-protocol-navigation/31-UAT.md
@bae/repl/resource.py
@bae/repl/shell.py
@tests/test_resource.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NavResult str subclass and use it in all navigation returns</name>
  <files>bae/repl/resource.py, bae/repl/shell.py, tests/test_resource.py</files>
  <action>
In bae/repl/resource.py, add a NavResult class near the top (after imports, before MAX_STACK_DEPTH):

```python
class NavResult(str):
    """String whose repr() outputs raw content, preserving ANSI rendering.

    _run_py displays expression results via repr(result). Normal str repr
    escapes ANSI codes (\x1b becomes \\x1b). NavResult.__repr__ returns
    self so ANSI passes through to the terminal.
    """
    def __repr__(self) -> str:
        return str(self)
```

Then wrap every return value in NavResult in the following methods:
- ResourceRegistry.navigate: wrap the final `return transition + self._entry_display(resolved)` -> `return NavResult(transition + self._entry_display(resolved))`
- ResourceRegistry.back: wrap both return paths (entry display and root nav) in NavResult
- ResourceRegistry.homespace: wrap the return in NavResult
- ResourceRegistry._root_nav: wrap the return in NavResult (so it propagates up)
- ResourceHandle.__call__: this calls registry.navigate which already returns NavResult, so no change needed
- format_nav_error: wrap return in NavResult (error strings also get repr'd)
- format_unsupported_error: wrap return in NavResult

In bae/repl/shell.py, update the homespace/back lambdas (line 232-233). Since registry.homespace() and registry.back() now return NavResult, the lambdas already propagate it. No change needed unless the lambda wrapping strips the type -- verify by checking `type(result)` in a test.

In tests/test_resource.py, add tests:

```python
def test_nav_result_repr_preserves_ansi(self):
    """repr() on NavResult returns raw string, not escaped."""
    from bae.repl.resource import NavResult
    ansi = "\x1b[1mhome\x1b[0m"
    nr = NavResult(ansi)
    assert repr(nr) == ansi  # not "\\x1b[1mhome\\x1b[0m"

def test_homespace_returns_nav_result(self):
    reg = ResourceRegistry()
    result = reg.homespace()
    assert isinstance(result, NavResult)

def test_navigate_returns_nav_result(self):
    reg = ResourceRegistry()
    reg.register(StubSpace("source"))
    result = reg.navigate("source")
    assert isinstance(result, NavResult)

def test_back_returns_nav_result(self):
    reg = ResourceRegistry()
    result = reg.back()
    assert isinstance(result, NavResult)
```

Add NavResult to the imports in the test file if needed.
  </action>
  <verify>
Run `uv run pytest tests/test_resource.py tests/test_tools_router.py -x -q` -- all pass.
Then run full suite: `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- all pass.
  </verify>
  <done>
repr() on any navigation return value outputs raw ANSI codes (not escaped).
homespace(), back(), navigate() all return NavResult instances.
All existing tests still pass (NavResult is a str subclass, so isinstance(x, str) still works).
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- all tests pass
2. Manual verification: `repr(NavResult("\x1b[1mhome\x1b[0m"))` outputs the raw ANSI, not escaped
</verification>

<success_criteria>
- NavResult class exists in resource.py with __repr__ returning self
- All navigation methods return NavResult
- New tests prove repr preserves ANSI
- All 699+ existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/31-resource-protocol-navigation/31-04-SUMMARY.md`
</output>
