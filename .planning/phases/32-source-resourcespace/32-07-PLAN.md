---
phase: 32-source-resourcespace
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/repl/resource.py
  - bae/repl/shell.py
  - bae/repl/tools.py
  - bae/repl/ai.py
  - bae/repl/ai_prompt.md
  - tests/test_resource.py
  - tests/test_tools_router.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "home() is a callable in the namespace that navigates to root"
    - "home() returns a procedurally-built orientation string (the system prompt content)"
    - "At home, tools (read, glob, grep) are available in the namespace"
    - "The AI system prompt uses home()'s output for orientation"
    - "homespace() no longer exists anywhere in code, tests, or docs"
  artifacts:
    - path: "bae/repl/resource.py"
      provides: "home() method that clears stack, injects home tools, returns orientation string"
      contains: "def home"
    - path: "bae/repl/shell.py"
      provides: "namespace['home'] callable, home tools wired to registry"
    - path: "bae/repl/tools.py"
      provides: "_home_dispatch renamed from _homespace_dispatch"
    - path: "bae/repl/ai.py"
      provides: "_with_location uses home() output at root; _SKIP uses 'home' not 'homespace'"
    - path: "bae/repl/ai_prompt.md"
      provides: "home() references, not homespace()"
  key_links:
    - from: "bae/repl/shell.py"
      to: "bae/repl/resource.py"
      via: "namespace['home'] calls registry.home()"
      pattern: "home"
    - from: "bae/repl/resource.py"
      to: "namespace"
      via: "home() injects read/glob/grep into namespace and returns orientation string"
      pattern: "_home_tools|_build_orientation"
    - from: "bae/repl/ai.py"
      to: "bae/repl/resource.py"
      via: "_with_location calls registry to get orientation at root"
      pattern: "_with_location"
---

<objective>
Rename homespace() to home(), make home a resource with tools, and wire home()'s
procedural orientation string into the AI system prompt path.

Purpose: Dzara's direction -- home() is a resource that returns a procedurally-built
orientation string. That string IS the system prompt content (what Claude sees to get
oriented). home() should build it procedurally: available resourcespaces, current state,
affordances. The AI prompt injection path (_with_location in ai.py) should use home()'s
output when at root. Keep it simple and tweakable -- Dzara will iterate on the template.

Output: home() as a first-class resource with tools and orientation output; AI sees
home's orientation on every call.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bae/repl/resource.py
@bae/repl/shell.py
@bae/repl/tools.py
@bae/repl/ai.py
@bae/repl/ai_prompt.md
@tests/test_resource.py
@tests/test_tools_router.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename homespace to home and add orientation builder</name>
  <files>bae/repl/resource.py, bae/repl/shell.py, bae/repl/tools.py, bae/repl/ai.py, bae/repl/ai_prompt.md, tests/test_resource.py, tests/test_tools_router.py</files>
  <action>
**resource.py -- Rename + orientation builder:**

1. Rename `ResourceRegistry.homespace()` to `ResourceRegistry.home()`.

2. Add `_home_tools: dict[str, Callable]` attribute to `__init__` (default `{}`). This dict
   holds the home-level tool callables (read, glob, grep) set by shell.py during init.

3. Update `_put_tools()`: when `current is None` (at home), inject `_home_tools` instead of
   nothing:
   ```python
   def _put_tools(self) -> None:
       if self._namespace is None:
           return
       for name in _TOOL_NAMES:
           self._namespace.pop(name, None)
       current = self.current
       if current is not None:
           self._namespace.update(current.tools())
       elif self._home_tools:
           self._namespace.update(self._home_tools)
   ```

4. Add `_build_orientation()` method that procedurally builds an orientation string.
   This is what the AI sees to get oriented. Template (keep simple, Dzara will iterate):
   ```python
   def _build_orientation(self) -> str:
       """Build procedural orientation string for AI system prompt."""
       lines = ["home"]
       lines.append("")
       # Available resourcespaces
       if self._spaces:
           lines.append("Resourcespaces:")
           for name, space in sorted(self._spaces.items()):
               lines.append(f"  {name}() -- {space.description}")
       # Current tools
       tools = sorted(self._home_tools.keys()) if self._home_tools else []
       if tools:
           lines.append("")
           lines.append(f"Tools: {', '.join(tools)}")
       lines.append("")
       lines.append("Navigate: call a resourcespace as a function. back() to return.")
       return "\n".join(lines)
   ```

5. Update `home()` to return NavResult wrapping `_build_orientation()` instead of `_root_nav()`:
   ```python
   def home(self) -> str:
       """Clear stack, inject home tools, return orientation."""
       self._stack.clear()
       self._put_tools()
       return NavResult(self._build_orientation())
   ```

6. Update `back()`: when stack is empty after pop, return `NavResult(self._build_orientation())`
   instead of `self._root_nav()`. The `_root_nav()` method stays (it's the Rich tree used
   by nav()), but home/back at root use orientation.

**shell.py -- Wire home tools and rename:**

1. Replace `self.namespace["homespace"] = lambda: self.registry.homespace()` with
   `self.namespace["home"] = lambda: self.registry.home()`

2. After creating ToolRouter, set home tools on registry. Use the _exec_read/_exec_glob/_exec_grep
   from ai.py directly (these are the filesystem fallbacks that _homespace_dispatch delegates to):
   ```python
   from bae.repl.ai import _exec_read, _exec_glob, _exec_grep
   self.registry._home_tools = {
       "read": _exec_read,
       "glob": _exec_glob,
       "grep": _exec_grep,
   }
   ```

**tools.py -- Rename homespace references:**

1. Rename `_homespace_dispatch` to `_home_dispatch`.
2. Update string "homespace root" to "home" in error message.
3. Update docstrings: "homespace" -> "home".
4. Update module docstring: "homespace filesystem" -> "home filesystem".

**ai.py -- Use orientation at root, rename in _SKIP:**

1. In `_SKIP` set: change `"homespace"` to `"home"`.

2. Update `_with_location()` to use home's orientation when at root (current is None):
   ```python
   def _with_location(self, prompt: str) -> str:
       """Prepend resource context to prompt."""
       if self._registry is None:
           return prompt
       if self._registry.current is None:
           orientation = self._registry._build_orientation()
           return f"[Location: home]\n{orientation}\n\n{prompt}"
       return f"[Location: {self._registry.breadcrumb()}]\n{prompt}"
   ```
   This means every AI call at root level gets the procedural orientation. When navigated
   into a resource, the breadcrumb is enough (the resource's enter() already gave context).

**ai_prompt.md:**

1. Replace `homespace()` with `home()` in the Resources section.

**tests/test_resource.py:**

1. Rename all `homespace` method calls to `home()`.
2. Test names: `test_homespace_*` -> `test_home_*`.
3. Add `test_home_injects_tools`: set `_home_tools` on registry, call `home()`,
   verify read/glob/grep are in namespace.
4. Update `test_homespace_removes_tools` -> `test_home_swaps_to_home_tools`:
   navigate to a resource, then call `home()`, verify resource tools removed and
   home tools injected.
5. Add `test_home_returns_orientation`: call `home()`, verify result contains
   "Resourcespaces:" and the registered space names and "Tools:".
6. Add `test_back_to_root_returns_orientation`: navigate then back() to root,
   verify result contains orientation content.

**tests/test_tools_router.py:**

1. Update any `homespace` references to `home`.
  </action>
  <verify>`uv run pytest tests/test_resource.py tests/test_tools_router.py -x -q` passes. Then full suite: `uv run pytest tests/ -x -q --ignore=tests/test_integration.py`. Grep for remaining "homespace" in source: `grep -rn homespace bae/ tests/` should return nothing.</verify>
  <done>home() is a namespace callable that navigates to root, injects read/glob/grep tools, returns a procedural orientation string, and the AI receives that orientation on every call at root. No trace of homespace() in bae/ or tests/.</done>
</task>

</tasks>

<verification>
- `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- all tests pass
- `grep -rn homespace bae/ tests/` -- zero matches
- `grep -rn "def home" bae/repl/resource.py` -- shows home() method
- `grep -rn "_build_orientation" bae/repl/resource.py` -- shows orientation builder
- `grep -rn "_with_location" bae/repl/ai.py` -- shows orientation injection at root
</verification>

<success_criteria>
home() navigates to root, provides read/glob/grep tools in namespace, and returns a
procedural orientation string listing available resourcespaces and tools. The AI sees
this orientation on every call when at root. No trace of homespace() anywhere in
bae/ or tests/.
</success_criteria>

<output>
After completion, create `.planning/phases/32-source-resourcespace/32-07-SUMMARY.md`
</output>
