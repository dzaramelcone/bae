---
phase: 32-source-resourcespace
plan: 02
type: tdd
wave: 2
depends_on: ["32-01"]
files_modified:
  - bae/repl/source.py
  - tests/test_source.py
autonomous: true

must_haves:
  truths:
    - "glob('bae.repl.*') returns module paths matching pattern"
    - "grep('ResourceError', 'bae.repl') returns module:line: content format"
    - "Glob and grep output never contains filesystem paths"
    - "Glob/grep use module notation in both patterns and results"
  artifacts:
    - path: "bae/repl/source.py"
      provides: "glob() and grep() methods on SourceResourcespace"
    - path: "tests/test_source.py"
      provides: "Tests for glob and grep with module path output"
  key_links:
    - from: "bae/repl/source.py glob/grep"
      to: "pathlib/re under the hood"
      via: "module path translation in results"
      pattern: "_path_to_module"
---

<objective>
Glob and grep tools for SourceResourcespace with module-path output.

Purpose: Complete the read-only tool surface. Glob lets the agent discover modules by pattern; grep lets the agent search source content. Both must output module paths only -- no filesystem paths leak.

Output: `glob()` and `grep()` methods on SourceResourcespace, plus helpers for module enumeration and content search.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-source-resourcespace/32-RESEARCH.md
@.planning/phases/32-source-resourcespace/32-01-SUMMARY.md
@bae/repl/source.py
@bae/repl/tools.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Tests for glob and grep with module paths</name>
  <files>tests/test_source.py</files>
  <action>
Add tests to tests/test_source.py covering:

**Glob (4 tests):**
- `glob("bae.repl.*")` returns list of module paths matching (should include `bae.repl.ai`, `bae.repl.shell`, etc.)
- `glob("bae.repl.resource")` returns exact match
- `glob("bae.nonexistent.*")` returns "(no matches)" or empty
- Glob output contains NO `/` characters (no filesystem paths leaked)

**Grep (4 tests):**
- `grep("ResourceError")` finds matches in `bae.repl.resource` with format `bae.repl.resource:NN: line content`
- `grep("ResourceError", "bae.repl.resource")` scopes search to that module
- `grep("zzzznonexistent")` returns "(no matches)" or empty
- Grep output contains NO `/` characters (no filesystem paths leaked)

**Budget (2 tests):**
- `glob("bae.*")` with large result set: output either fits budget or raises ResourceError with narrowing hint
- `grep("def ")` with many matches: same budget behavior

All new tests must fail initially.
  </action>
  <verify>`uv run pytest tests/test_source.py -k "glob or grep" -x -q` -- all new tests fail</verify>
  <done>10 new tests written for glob and grep, all failing</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement glob and grep on SourceResourcespace</name>
  <files>bae/repl/source.py</files>
  <action>
Add to bae/repl/source.py:

**Helper: `_discover_all_modules(project_root: Path) -> list[str]`:**
- Walk all `.py` files under project_root recursively
- Convert each to module path via `_path_to_module`
- Filter to only those under packages with `__init__.py`
- Return sorted list of all module paths

**SourceResourcespace.glob(pattern: str = "") -> str:**
- Validate pattern (only `.` and `*` and identifiers allowed -- no `/` or `..`)
- Convert glob pattern to work with module notation: `bae.repl.*` matches `bae.repl.ai`, `bae.repl.shell`, etc.
- Use `fnmatch.fnmatch()` on dotted module paths
- Return one module path per line
- If output exceeds CHAR_CAP, raise ResourceError("Too many matches ({N}). Narrow with a more specific pattern like '{pattern}.subpackage.*'")

**SourceResourcespace.grep(pattern: str = "", path: str = "") -> str:**
- `pattern` is the regex to search for
- `path` (optional) scopes to a specific module or package
- If path given: validate and resolve to file(s). If it's a package, search all modules in that package.
- If no path: search all project modules
- For each file, search line by line with `re.search(pattern, line)`
- Format results as `module.path:lineno: line_content`
- Cap results: if more than ~50 matches, return first 50 with "[N more matches, narrow with path argument]"
- If output exceeds CHAR_CAP, raise ResourceError with narrowing hint

No filesystem paths in any output string.
  </action>
  <verify>`uv run pytest tests/test_source.py -x -q` -- all tests pass. `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full suite green.</verify>
  <done>glob() and grep() implemented with module-path-only output, budget awareness, and narrowing hints. All tests pass.</done>
</task>

</tasks>

<verification>
- `uv run pytest tests/test_source.py -k "glob or grep" -x -q` -- glob/grep tests pass
- Grep output for any call does not contain `/` character (module paths only)
- Budget overflow triggers ResourceError with narrowing hint, not silent pruning
</verification>

<success_criteria>
- glob matches modules by dotted pattern and returns module paths
- grep searches source content and returns module:line: format
- No filesystem paths in any output
- Budget exceeded -> ResourceError with narrowing guidance
</success_criteria>

<output>
After completion, create `.planning/phases/32-source-resourcespace/32-02-SUMMARY.md`
</output>
