---
phase: 26-engine-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/graph.py
  - bae/lm.py
  - tests/test_graph.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Graph(start=SomeNode()) raises TypeError with message mentioning 'instance' and 'class'"
    - "Ctrl-C while a graph is running opens the task menu instead of killing the REPL"
  artifacts:
    - path: "bae/graph.py"
      provides: "Runtime isinstance guard in Graph.__init__"
      contains: "isinstance"
    - path: "bae/lm.py"
      provides: "Process group isolation for Claude CLI subprocess"
      contains: "start_new_session"
    - path: "tests/test_graph.py"
      provides: "Test for instance-vs-class guard"
      contains: "instance"
  key_links:
    - from: "bae/lm.py"
      to: "asyncio.create_subprocess_exec"
      via: "start_new_session=True kwarg"
      pattern: "start_new_session=True"
---

<objective>
Fix two independent defensive bugs found during UAT: (1) Graph(start=instance) gives a cryptic unhashable TypeError instead of a helpful message, and (2) Claude CLI subprocesses inherit the REPL process group causing Ctrl-C to kill the entire REPL.

Purpose: Close UAT gaps for "clear error on instance" and "Ctrl-C task menu works during graph execution"
Output: Patched graph.py and lm.py with tests
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-engine-foundation/26-01-SUMMARY.md
@.planning/phases/26-engine-foundation/26-02-SUMMARY.md
@.planning/debug/node-unhashable-in-discover.md
@.planning/debug/ctrl-c-kills-repl.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Graph instance guard and subprocess isolation</name>
  <files>bae/graph.py, bae/lm.py, tests/test_graph.py</files>
  <action>
Two independent one-shot fixes:

**A) bae/graph.py -- Graph.__init__ instance guard (line 156-167):**

Add a runtime check at the TOP of `__init__`, before `self.start = start`:

```python
if not isinstance(start, type):
    raise TypeError(
        f"Graph(start=...) expects a Node class, got an instance of "
        f"{type(start).__name__}. Use Graph(start={type(start).__name__}) "
        f"instead of Graph(start={type(start).__name__}(...))"
    )
```

This catches the case where a user passes `Graph(start=MyNode(field="val"))` instead of `Graph(start=MyNode)`. The error message tells them exactly what to do. Place this BEFORE `self.start = start` so `_discover()` never sees the instance.

**B) bae/lm.py -- subprocess process group isolation (line 464):**

Add `start_new_session=True` to the `asyncio.create_subprocess_exec` call in `ClaudeCLIBackend._run_cli_json()`. Currently line 464:

```python
process = await asyncio.create_subprocess_exec(
    *cmd,
    stdout=asyncio.subprocess.PIPE,
    stderr=asyncio.subprocess.PIPE,
    start_new_session=True,  # ADD THIS
)
```

Every other subprocess in the codebase (ai.py:235, bash.py:34, agent.py:173) already uses `start_new_session=True`. lm.py is the sole outlier. Without this, the Claude CLI child inherits the REPL's process group and terminal SIGINT hits both processes, killing the REPL before prompt_toolkit's Ctrl-C handler can intercept it.

**C) tests/test_graph.py -- add test for instance guard:**

Add one test to the existing test file. Place it in a new class or with the existing structure:

```python
def test_graph_rejects_instance():
    """Graph(start=instance) raises TypeError with helpful message."""
    instance = Start(query="hello")
    with pytest.raises(TypeError, match="expects a Node class, got an instance"):
        Graph(start=instance)
```

Ensure the test uses an existing test Node class (Start is defined at module level in test_graph.py).
  </action>
  <verify>
Run: `uv run pytest tests/test_graph.py -x -q` -- all tests pass including new instance guard test.
Grep: `grep -n "start_new_session" bae/lm.py` shows the flag is present.
Grep: `grep -n "isinstance(start, type)" bae/graph.py` shows the guard is present.
  </verify>
  <done>
Graph(start=SomeNode()) raises TypeError with message containing "expects a Node class, got an instance". ClaudeCLIBackend._run_cli_json creates subprocess with start_new_session=True.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest tests/test_graph.py -x -q` passes
- `uv run pytest tests/repl/test_engine.py -x -q` passes (no regressions)
- `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` passes (full suite)
- `grep "start_new_session=True" bae/lm.py` matches
- `grep "isinstance(start, type)" bae/graph.py` matches
</verification>

<success_criteria>
1. Graph(start=instance) produces a clear, actionable TypeError
2. _run_cli_json subprocess isolated in its own session (start_new_session=True)
3. All existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/26-engine-foundation/26-03-SUMMARY.md`
</output>
