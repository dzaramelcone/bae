---
phase: 23-view-framework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/repl/channels.py
  - tests/repl/test_channels.py
autonomous: true

must_haves:
  truths:
    - "ViewFormatter protocol exists with render(channel_name, color, content, *, metadata) signature"
    - "Channel._display() delegates to formatter when _formatter is set"
    - "Channel._display() falls back to existing behavior when _formatter is None"
    - "All 39 existing channel tests pass without modification"
  artifacts:
    - path: "bae/repl/channels.py"
      provides: "ViewFormatter protocol and Channel formatter delegation"
      contains: "class ViewFormatter"
    - path: "tests/repl/test_channels.py"
      provides: "Tests for formatter delegation and fallback"
      contains: "test_channel_display_delegates_to_formatter"
  key_links:
    - from: "bae/repl/channels.py"
      to: "ViewFormatter.render"
      via: "Channel._display() delegation"
      pattern: "self\\._formatter\\.render"
---

<objective>
Add pluggable display strategy to Channel via ViewFormatter protocol and _display() delegation.

Purpose: Enable Phase 24/25 to swap channel display behavior without modifying Channel identity or breaking existing code.
Output: ViewFormatter protocol in channels.py, _formatter field on Channel, delegation in _display(), tests proving both paths.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-view-framework/23-RESEARCH.md
@bae/repl/channels.py
@tests/repl/test_channels.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ViewFormatter protocol and Channel formatter delegation</name>
  <files>bae/repl/channels.py</files>
  <action>
In `bae/repl/channels.py`, make these surgical changes:

1. **Add imports**: Add `Protocol` and `runtime_checkable` to the existing `typing` import line.
   Change `from typing import TYPE_CHECKING` to `from typing import TYPE_CHECKING, Protocol, runtime_checkable`.

2. **Add ViewFormatter protocol**: Insert BEFORE the Channel class (after `render_markdown`, before `@dataclass`):

```python
@runtime_checkable
class ViewFormatter(Protocol):
    """Display strategy for channel content.

    Receives channel name, color, content, and optional metadata.
    Renders to terminal via print_formatted_text (prompt_toolkit).
    All Rich rendering MUST use Console(file=StringIO()) -- never stdout directly.
    """

    def render(
        self,
        channel_name: str,
        color: str,
        content: str,
        *,
        metadata: dict | None = None,
    ) -> None:
        """Format and display content from a channel write."""
        ...
```

This matches the existing LM protocol pattern in `bae/lm.py`.

3. **Add _formatter field to Channel dataclass**: Insert `_formatter: ViewFormatter | None = field(default=None, repr=False)` BEFORE the existing `_buffer` field (line 52). This follows the same pattern as `_buffer` -- private, defaulted, hidden from repr.

4. **Add delegation to _display()**: Prepend a formatter check as the FIRST lines of `_display()`, before the existing `label_text = self.label` line:

```python
if self._formatter is not None:
    self._formatter.render(self.name, self.color, content, metadata=metadata)
    return
```

The existing code below this check remains EXACTLY as-is -- no reformatting, no cleanup, no changes.

5. **Export ViewFormatter**: Add `ViewFormatter` to the module's public API. If there's no `__all__`, the import in tests will work directly.

Do NOT touch any other method, class, or function in the file. The `_display()` docstring can be updated to mention formatter delegation.
  </action>
  <verify>
Run `uv run python -m pytest tests/repl/test_channels.py -q` -- all 39 existing tests must pass.
Run `uv run python -c "from bae.repl.channels import ViewFormatter; print(ViewFormatter)"` -- import must succeed.
  </verify>
  <done>ViewFormatter protocol defined with render() signature. Channel has _formatter field. _display() delegates to formatter when set. All 39 existing tests pass unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for formatter delegation and protocol shape</name>
  <files>tests/repl/test_channels.py</files>
  <action>
In `tests/repl/test_channels.py`, add these tests. Add `ViewFormatter` to the import from `bae.repl.channels` at the top of the file.

Add a new test section after the toggle_channels tests (at the bottom of the file):

```python
# --- ViewFormatter delegation tests ---


def test_view_formatter_protocol_shape():
    """Any object with a matching render() method satisfies ViewFormatter."""
    class Good:
        def render(self, channel_name, color, content, *, metadata=None):
            pass

    assert isinstance(Good(), ViewFormatter)


def test_channel_display_delegates_to_formatter():
    """When _formatter is set, _display() delegates to formatter.render()."""
    mock_formatter = MagicMock()
    ch = Channel(name="py", color="#87ff87")
    ch._formatter = mock_formatter
    ch._display("hello", metadata={"type": "test"})
    mock_formatter.render.assert_called_once_with(
        "py", "#87ff87", "hello", metadata={"type": "test"},
    )


def test_channel_display_delegates_skips_default_rendering():
    """When _formatter is set, print_formatted_text is NOT called."""
    mock_formatter = MagicMock()
    ch = Channel(name="py", color="#87ff87")
    ch._formatter = mock_formatter
    with patch("bae.repl.channels.print_formatted_text") as mock_pft:
        ch._display("hello")
        mock_pft.assert_not_called()


@patch("bae.repl.channels.print_formatted_text")
def test_channel_display_no_formatter_unchanged(mock_pft):
    """When _formatter is None, _display() uses existing line-by-line rendering."""
    ch = Channel(name="py", color="#87ff87")
    ch._display("x = 42")
    mock_pft.assert_called_once()
    fragments = list(mock_pft.call_args[0][0])
    assert fragments[0] == ("#87ff87 bold", "[py]")
    assert fragments[2] == ("", "x = 42")


def test_channel_formatter_field_default_none():
    """Channel._formatter defaults to None."""
    ch = Channel(name="py", color="#87ff87")
    assert ch._formatter is None


def test_channel_formatter_not_in_repr():
    """Channel repr does not expose _formatter."""
    mock_formatter = MagicMock()
    ch = Channel(name="py", color="#87ff87")
    ch._formatter = mock_formatter
    assert "formatter" not in repr(ch)
```

These six tests cover:
- Protocol structural typing (any object with render() satisfies it)
- Delegation path (formatter receives correct args)
- Delegation exclusivity (default rendering skipped when formatter set)
- Fallback path (no formatter means original behavior)
- Default field value (None)
- Repr exclusion (private field hidden)
  </action>
  <verify>
Run `uv run python -m pytest tests/repl/test_channels.py -q` -- all tests pass (39 existing + 6 new = 45 total).
Run `uv run python -m pytest tests/repl/test_channels.py -q --tb=short` to confirm zero failures.
  </verify>
  <done>Six new tests pass covering formatter protocol shape, delegation, fallback, and dataclass integration. Total test count is 45, zero failures.</done>
</task>

</tasks>

<verification>
1. `uv run python -m pytest tests/repl/test_channels.py -q` -- 45 tests pass (39 original + 6 new)
2. `uv run python -m pytest tests/ -q` -- full test suite passes (no regressions elsewhere)
3. `uv run python -c "from bae.repl.channels import ViewFormatter, Channel; c = Channel('x', 'red'); assert c._formatter is None"` -- import and default work
4. `uv run python -c "from bae.repl.channels import ViewFormatter; assert hasattr(ViewFormatter, 'render')"` -- protocol has render method
</verification>

<success_criteria>
- ViewFormatter protocol importable from bae.repl.channels with render(channel_name, color, content, *, metadata) signature
- Channel._formatter field defaults to None, hidden from repr
- Channel._display() delegates to formatter.render() when _formatter is set
- Channel._display() runs existing code path when _formatter is None
- 45 tests pass (39 existing unchanged + 6 new), zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/23-view-framework/23-01-SUMMARY.md`
</output>
