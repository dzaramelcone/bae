---
phase: 26-engine-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - bae/graph.py
  - bae/lm.py
  - tests/test_graph.py
autonomous: true

must_haves:
  truths:
    - "Graph.arun() accepts dep_cache keyword arg and merges it into the run cache"
    - "Existing Graph.arun() callers (no dep_cache) work unchanged"
    - "asyncio.sleep(0) yields to event loop on each iteration"
    - "CancelledError during LM subprocess kills the process and re-raises"
  artifacts:
    - path: "bae/graph.py"
      provides: "dep_cache parameter and event loop yield in arun()"
      contains: "dep_cache"
    - path: "bae/lm.py"
      provides: "CancelledError handling in _run_cli_json"
      contains: "CancelledError"
    - path: "tests/test_graph.py"
      provides: "Tests for dep_cache injection and event loop yield"
      contains: "dep_cache"
  key_links:
    - from: "bae/graph.py"
      to: "bae/resolver.py"
      via: "dep_cache dict passed to resolve_fields as cache arg"
      pattern: "resolve_fields.*cache"
---

<objective>
Add dep_cache parameter to Graph.arun() and harden subprocess cancellation.

Purpose: Enable cortex engine (Plan 02) to inject timing LM and external resources into graph runs without modifying the framework layer. Fix subprocess orphan leak on cancellation.
Output: Modified Graph.arun() signature, CancelledError handling in _run_cli_json, passing tests.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-engine-foundation/26-RESEARCH.md

@bae/graph.py
@bae/lm.py
@tests/test_graph.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dep_cache parameter and event loop yield to Graph.arun()</name>
  <files>bae/graph.py, bae/lm.py, tests/test_graph.py</files>
  <action>
**RED phase -- write failing tests first:**

In `tests/test_graph.py`, add tests for the new dep_cache behavior:

1. `test_dep_cache_seeds_resolver` -- Create a graph with a Dep field. Pass `dep_cache={dep_fn: "preseeded"}` to `arun()`. Assert the dep function is NOT called (the preseeded value is used instead). Use a MockLM and a simple graph with one dep.

2. `test_dep_cache_none_is_default` -- Call `arun()` without dep_cache. Assert it works exactly as before (backward compat).

3. `test_dep_cache_does_not_shadow_lm` -- Pass `dep_cache={some_fn: val}` and also pass `lm=mock_lm`. Assert the LM is used for fill/choose_type (dep_cache doesn't clobber LM_KEY unless explicitly set).

4. `test_arun_yields_to_event_loop` -- Run a graph and verify `asyncio.sleep(0)` is called during execution (patch asyncio.sleep and check it was called with 0).

Run tests: `uv run pytest tests/test_graph.py -x -q` -- they should FAIL (dep_cache param doesn't exist yet).

**GREEN phase -- implement:**

In `bae/graph.py`, modify `Graph.arun()`:
- Add `dep_cache: dict | None = None` as keyword-only parameter after `max_iters`
- Rename internal `dep_cache` variable to `cache` to avoid shadowing
- After initializing `cache: dict = {LM_KEY: lm}`, add: `if dep_cache is not None: cache.update(dep_cache)`
- Add `await asyncio.sleep(0)` at the top of the `while current is not None` loop (before the iteration guard)
- Update all internal references from `dep_cache` to `cache` (there are references at lines 308, 321, 375, 410)
- Update docstring to document the new parameter

In `bae/lm.py`, fix `_run_cli_json()`:
- Change the except clause from `except asyncio.TimeoutError:` to `except (asyncio.TimeoutError, asyncio.CancelledError):`
- After `process.kill()`, add `await process.wait()` before re-raising
- This prevents subprocess orphans when graph tasks are cancelled

Run tests: `uv run pytest tests/test_graph.py -x -q` -- should PASS.

**REFACTOR:** Verify all existing tests still pass: `uv run pytest tests/ -x -q --ignore=tests/test_integration.py`

**Important:** The `run()` sync wrapper calls `arun()` without dep_cache -- this is fine since dep_cache defaults to None.
  </action>
  <verify>
`uv run pytest tests/test_graph.py -x -q` passes including new dep_cache tests.
`uv run pytest tests/ -x -q --ignore=tests/test_integration.py` passes (no regressions).
  </verify>
  <done>
Graph.arun() accepts dep_cache kwarg, merges into resolver cache. asyncio.sleep(0) yields on each iteration. CancelledError in _run_cli_json kills subprocess. All existing tests pass unchanged.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_graph.py -x -q` -- all pass including new dep_cache tests
2. `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full suite passes, no regressions
3. Verify `dep_cache` appears in Graph.arun() signature with `None` default
4. Verify `CancelledError` appears in lm.py _run_cli_json except clause
</verification>

<success_criteria>
- Graph.arun(dep_cache={"fn": val}) pre-seeds resolver cache
- Graph.arun() without dep_cache works identically to before
- Event loop yields on every graph iteration
- Subprocess killed on CancelledError during LM calls
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/26-engine-foundation/26-01-SUMMARY.md`
</output>
