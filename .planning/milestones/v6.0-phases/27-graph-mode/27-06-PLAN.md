---
phase: 27-graph-mode
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - bae/lm.py
  - bae/repl/graph_commands.py
  - tests/repl/test_graph_commands.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Graph runs in background while Dzara continues using the REPL"
    - "inspect shows per-node timings inline with each trace node"
    - "inspect shows terminal node fields with readable JSON formatting"
  artifacts:
    - path: "bae/lm.py"
      provides: "stdin=DEVNULL on subprocess creation"
      contains: "stdin=asyncio.subprocess.DEVNULL"
    - path: "bae/repl/graph_commands.py"
      provides: "Reformatted _cmd_inspect with inline timing and JSON fields"
      contains: "json.dumps"
    - path: "tests/repl/test_graph_commands.py"
      provides: "Updated inspect test assertions for new format"
  key_links:
    - from: "bae/lm.py"
      to: "asyncio.subprocess.DEVNULL"
      via: "stdin parameter in create_subprocess_exec"
      pattern: "stdin=asyncio\\.subprocess\\.DEVNULL"
    - from: "bae/repl/graph_commands.py"
      to: "bae/repl/engine.py"
      via: "run.node_timings matched to trace by index"
      pattern: "node_timings"
---

<objective>
Fix two UAT gaps: (1) subprocess stdin inheritance blocks REPL input during graph execution, (2) inspect output lacks inline per-node timing and readable field formatting.

Purpose: Close the remaining Phase 27 UAT issues so graph mode is fully usable.
Output: Fixed lm.py subprocess creation, reformatted inspect command, updated tests.
</objective>

<execution_context>
@/Users/dzaramelcone/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dzaramelcone/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-graph-mode/27-04-SUMMARY.md
@.planning/phases/27-graph-mode/27-05-SUMMARY.md
@.planning/debug/graph-run-blocks-input.md
@.planning/debug/inspect-formatting.md
@bae/lm.py
@bae/repl/graph_commands.py
@bae/repl/engine.py
@tests/repl/test_graph_commands.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix subprocess stdin inheritance blocking REPL input</name>
  <files>bae/lm.py</files>
  <action>
In bae/lm.py at the `asyncio.create_subprocess_exec` call (line ~384), add `stdin=asyncio.subprocess.DEVNULL` alongside the existing `stdout=asyncio.subprocess.PIPE` and `stderr=asyncio.subprocess.PIPE` parameters.

This is a one-line addition. The root cause is that omitting stdin causes the child process to inherit the parent's stdin file descriptor. When the claude CLI subprocess holds stdin, prompt_toolkit loses terminal access and Dzara cannot type while a graph runs in the background.

After the fix, the call should read:
```python
process = await asyncio.create_subprocess_exec(
    *cmd,
    stdin=asyncio.subprocess.DEVNULL,
    stdout=asyncio.subprocess.PIPE,
    stderr=asyncio.subprocess.PIPE,
    start_new_session=True,
)
```
  </action>
  <verify>
Run `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- all tests pass. Grep bae/lm.py for `stdin=asyncio.subprocess.DEVNULL` to confirm the line exists.
  </verify>
  <done>ClaudeCLIBackend subprocess no longer inherits parent stdin. Background graph LM calls cannot steal terminal input from prompt_toolkit.</done>
</task>

<task type="auto">
  <name>Task 2: Reformat inspect command with inline timing and JSON fields</name>
  <files>bae/repl/graph_commands.py, tests/repl/test_graph_commands.py</files>
  <action>
Rewrite `_cmd_inspect` in bae/repl/graph_commands.py to address three formatting issues:

1. **Merge timing inline with trace nodes.** Remove the separate "Timings:" section. Instead, when iterating trace nodes, look up each node's timing from `run.node_timings` and display it inline:
   ```
   1. NodeTypeName  120ms
   ```
   Build a list of timings and match by index position (not by type name, since same type can appear multiple times). If a node has no corresponding timing entry, omit the ms suffix.

2. **Format terminal node fields with json.dumps.** Replace the raw `model_dump()` dict repr with `json.dumps(node.model_dump(), indent=2, default=str)`. The `default=str` handles non-serializable types. Indent the JSON block by 5 spaces so it nests visually under the node line.

3. **Keep field display to terminal node only.** This is the balanced approach (Option B from the debug investigation). Show all nodes with timing, but only the terminal (last) node gets its fields displayed.

Add `import json` at the top of graph_commands.py.

The rewritten `_cmd_inspect` should produce output like:
```
Run g1 (done, 2.5s)
Graph: StartNode

Trace:
  1. StartNode  120ms
  2. MiddleNode  2300ms
  3. EndNode  80ms
     {
       "reply": "hello",
       "details": {
         "key": "value"
       }
     }
```

If `run.result` has no trace but `run.node_timings` exists (e.g. failed run with partial data), show a "Timings:" section as fallback with just the timing data (preserving current behavior for that edge case).

**Update tests** in tests/repl/test_graph_commands.py:

Update `test_inspect_completed_run` to assert that the output contains timing suffix (e.g. check for "ms" appearing in the output) and that terminal node fields are formatted (check for `"reply"` with quotes, indicating JSON formatting rather than raw dict repr like `{'reply': 'done'}`).

Add `test_inspect_inline_timing` that:
- Creates a graph, submits it, drains tasks
- Runs inspect
- Asserts timing values appear inline with node names (the output contains a line matching pattern like `TStart` followed by `ms` on the same line, and similarly for `TEnd`)
  </action>
  <verify>
Run `uv run pytest tests/repl/test_graph_commands.py -x -q` -- all tests pass including updated and new inspect tests. Visually confirm `_cmd_inspect` output format by reading the test assertions.
  </verify>
  <done>inspect shows unified trace with per-node timing inline and terminal node fields formatted as indented JSON. No separate "Timings:" section for normal runs.</done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/ -x -q --ignore=tests/test_integration.py` -- full test suite passes
2. `grep -n "stdin=asyncio.subprocess.DEVNULL" bae/lm.py` -- confirms stdin fix
3. `grep -n "json.dumps" bae/repl/graph_commands.py` -- confirms JSON formatting
4. No separate "Timings:" section in _cmd_inspect for runs that have both trace and timings
</verification>

<success_criteria>
- Subprocess creation includes stdin=DEVNULL preventing terminal input contention
- inspect output merges timing inline with trace nodes (no separate section)
- Terminal node fields rendered as indented JSON, not raw dict repr
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-graph-mode/27-06-SUMMARY.md`
</output>
