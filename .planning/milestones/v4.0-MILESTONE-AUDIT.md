---
milestone: v4.0
audited: 2026-02-14T20:00:00Z
status: tech_debt
scores:
  requirements: 32/32
  phases: 7/7
  integration: 12/12
  flows: 7/7
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 18-ai-agent
    items:
      - "AI hallucinates <tool_use> XML instead of Python fences — prompt needs explicit no-tools constraint (UAT-2 test 2, major)"
  - phase: 20-ai-eval-loop
    items:
      - "Eval output displayed redundantly (code in AI markdown + again on [py] channel) — needs differentiated user view vs model feedback (UAT-2 test 5, cosmetic)"
      - "AI bash dispatch deferred — Claude XML tool calls need parsing infrastructure"
      - "AI streaming/progressive display deferred — NL responses currently blocking"
      - "GWT-inspired stream UX deferred — multi-session output needs visual sectioning, attention model, debug mode for raw I/O streams"
---

# Milestone v4.0 Cortex — Audit Report

**Audited:** 2026-02-14
**Status:** tech_debt (all requirements met, no critical blockers, accumulated deferred items)

## Scope

**Milestone Goal:** NL-first augmented REPL where human and AI collaborate in a shared namespace — session store captures all I/O for cross-session memory, channels route labeled output, and the AI agent operates in natural language while producing correct code.

**Phases:** 14-20 (7 phases, 24 plans)
**Tests:** 245 passing (0 failures)
**LOC:** 4,884 lines (bae/repl/ + tests/repl/)

## Requirements Coverage

All 32 v4.0 requirements satisfied.

| Category | Requirements | Satisfied | Phase(s) |
|----------|-------------|-----------|----------|
| REPL | REPL-01, 03, 04, 05, 07, 08, 12, 13, 14 | 9/9 | 14 |
| REPL | REPL-06, 10, 11 | 3/3 | 19 |
| STORE | STORE-01, 02, 03, 04 | 4/4 | 15 |
| CHAN | CHAN-01, 02, 03, 04, 05 | 5/5 | 16 |
| NS | NS-01, 02, 03, 04 | 4/4 | 17 |
| AI | AI-01, 02, 03, 04, 05, 06, 07 | 7/7 | 18, 20 |

**Total: 32/32 requirements satisfied**

### Requirement Details

| ID | Description | Status | Evidence |
|----|-------------|--------|----------|
| REPL-01 | `bae` launches cortex | satisfied | cli.py callback invokes launch() |
| REPL-03 | Top-level await support | satisfied | PyCF_ALLOW_TOP_LEVEL_AWAIT in exec.py |
| REPL-04 | Shift+Tab cycles modes | satisfied | s-tab keybinding in shell.py |
| REPL-05 | Mode indicator in prompt | satisfied | Colored prompt + toolbar mode display |
| REPL-06 | Custom prompt content | satisfied | ToolbarConfig.add/remove API |
| REPL-07 | Syntax highlighting + multiline | satisfied | PygmentsLexer + Shift+Enter |
| REPL-08 | Tab completion | satisfied | NamespaceCompleter wraps rlcompleter |
| REPL-10 | Ctrl-C opens kill menu | satisfied | Inline task menu in scrollback |
| REPL-11 | Double Ctrl-C kills all | satisfied | Second Ctrl-C in menu calls revoke_all() |
| REPL-12 | Ctrl-C no tasks exits | satisfied | KeyboardInterrupt returns from prompt |
| REPL-13 | Ctrl-D graceful shutdown | satisfied | _shutdown() cancels tasks, closes store |
| REPL-14 | Bash mode executes commands | satisfied | dispatch_bash with subprocess |
| STORE-01 | All I/O labeled + persisted | satisfied | 7+ store.record() call sites |
| STORE-02 | Structured for RAG | satisfied | SQLite + FTS5 + metadata JSON |
| STORE-03 | Cross-session persistence | satisfied | Shared .bae/store.db + cross_session_context() |
| STORE-04 | User can inspect store | satisfied | store() callable with FTS5 search |
| CHAN-01 | Color-coded channel labels | satisfied | Channel._display with FormattedText |
| CHAN-02 | TUI toggle menu | satisfied | Ctrl+O toggle_channels dialog |
| CHAN-03 | Channels as namespace objects | satisfied | channels.py, channels.graph attribute access |
| CHAN-04 | Debug logging to file | satisfied | enable_debug/disable_debug + FileHandler |
| CHAN-05 | Graph wrapper, no bae mods | satisfied | channel_arun with temporary logger handler |
| NS-01 | Bae objects in namespace | satisfied | seed() with Node/Graph/Dep/Recall |
| NS-02 | _ and _trace capture | satisfied | async_exec + GRAPH mode handlers |
| NS-03 | ns() lists namespace | satisfied | NsInspector.__call__() |
| NS-04 | ns(obj) inspects objects | satisfied | Specialized handlers for Graph/Node |
| AI-01 | await ai("question") | satisfied | AI.__call__ with Claude CLI subprocess |
| AI-02 | ai.fill delegation | satisfied | Delegates to self._lm.fill |
| AI-03 | ai.choose_type delegation | satisfied | Delegates to self._lm.choose_type |
| AI-04 | AI output on [ai] channel | satisfied | router.write("ai", ...) |
| AI-05 | AI receives namespace context | satisfied | _build_context with graph/trace/variables |
| AI-06 | AI code extraction + execution | satisfied | Eval loop: extract_code → async_exec → feedback |
| AI-07 | Prompt engineering for NL-to-code | satisfied | ai_prompt.md with NL-first rules |

## Phase Verification Summary

| Phase | Name | Score | Status | Gaps |
|-------|------|-------|--------|------|
| 14 | Shell Foundation | 12/12 | passed | None |
| 15 | Session Store | 13/13 | passed | None |
| 16 | Channel I/O | 8/8 | passed | None |
| 17 | Namespace | 8/8 | passed | None |
| 18 | AI Agent | 5/5 | human_needed* | None (UAT covered) |
| 19 | Task Lifecycle | 18/18 | human_needed* | None (UAT covered) |
| 20 | AI Eval Loop | 7/7 | passed | None |

*Phase 18 and 19 automated verification flagged "human_needed" for interactive TUI/AI behavior. Two UAT rounds (20-UAT, 20-UAT-2) covered these items with results: 4/6 passed, 2 cosmetic/prompt issues deferred.

## Cross-Phase Integration

**Status: PASS**

All 12 integration points verified:
1. Shell → Store (I/O recording at 7+ call sites)
2. Shell → Channels (all output via router.write())
3. Shell → Namespace (seed, _, _trace, ai/store/channels injection)
4. Shell → AI (NL dispatch, multi-session, @N prefix)
5. Shell → TaskManager (submit for all tracked modes, Ctrl-C handler)
6. AI → Channels ([ai] channel with session labels)
7. AI → Store (cross-session context on first prompt)
8. AI → exec (eval loop in shared namespace)
9. Channels → Store (Channel.write records to store)
10. exec → sys.modules (REPL class annotation resolution)
11. AI → TaskManager (register_process for Claude CLI subprocess)
12. Bash → TaskManager (register_process for shell subprocess)

## E2E Flows

All 7 critical user flows verified:
1. Launch → namespace seeded → all modes accessible
2. AI question → context → Claude CLI → response → [ai] channel → store
3. AI code → extract → execute → tee [py] → feed back → summary
4. Concurrent AI sessions → correct routing → @N prefix switching
5. Exit/relaunch → cross_session_context → AI aware of prior work
6. Long task → Ctrl-C → task menu → cancel → process group killed
7. Graph → channel_arun → logger on [graph] → _trace captured

## UAT Results

Two UAT rounds completed (20-UAT, 20-UAT-2):

**UAT Round 1 (20-UAT):** 0/6 passed — identified root causes, created gap closure plans 20-04 and 20-05

**UAT Round 2 (20-UAT-2):** 4/6 passed
- pass: AI answers naturally (no runaway code loops)
- issue: AI hallucinates tool calls (major, deferred to prompt engineering)
- pass: Unawaited coroutines handled gracefully
- pass: Session indicators on AI channel
- issue: Eval output redundant display (cosmetic, deferred to GWT stream UX)
- pass: Cross-session memory works

## Tech Debt

### Prompt Engineering (major)

AI generates fake `<tool_use>` XML blocks with fabricated file paths instead of using Python code fences. Claude CLI subprocess defaults to tool-use patterns; system prompt needs explicit "you have NO tools, only Python code execution" constraint.

**Artifact:** bae/repl/ai_prompt.md
**Deferred to:** Next prompt engineering iteration

### Display Redundancy (cosmetic)

Eval loop output tee shows code in AI markdown response AND again as [py] channel lines. User sees code 2-3x. Needs differentiated views — what user sees vs what model gets fed back.

**Artifacts:** bae/repl/ai.py, bae/repl/channels.py
**Deferred to:** GWT-inspired stream UX design effort

### AI Bash Dispatch (deferred)

AI can't execute bash commands directly. Claude XML tool calls need a parsing infrastructure. Deferred past v4.0.

### AI Streaming (deferred)

NL responses block until complete. Streaming/progressive display would improve UX.

### GWT Stream UX (deferred)

Multi-session output needs visual sectioning (headers/fences per source), attention model (squelch/queue/pause when saturated), and debug mode for raw I/O streams per session. Shared namespace = global workspace, channels = broadcast, missing piece = attention bottleneck.

## Conclusion

v4.0 Cortex milestone is **ready for completion**. All 32 requirements satisfied, all 7 phases verified, all 12 integration points wired, all 7 E2E flows complete, 245 tests passing. Accumulated tech debt is non-blocking — 1 major prompt engineering item and 4 cosmetic/deferred items, all tracked for future work.

---
*Audited: 2026-02-14*
*Auditor: Claude (milestone audit workflow)*
